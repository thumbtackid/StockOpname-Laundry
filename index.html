<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Linen RS Charlie (V4.1 Hybrid Cloud)</title>
    
    <!-- Assets -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --primary: #0284c7; --primary-dark: #0369a1; --primary-light: #e0f2fe;
            --success: #10b981; --success-bg: #dcfce7; --success-text: #166534;
            --warning: #f59e0b; --warning-bg: #fef3c7; --warning-text: #92400e;
            --danger: #ef4444; --danger-bg: #fee2e2; --danger-text: #991b1b;
            --info: #64748b; --info-bg: #f1f5f9; --info-text: #475569;
            --bg-body: #f8fafc; --bg-surface: #ffffff; --border: #e2e8f0;
            --text-main: #0f172a; --text-muted: #64748b;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05); --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); font-size: 14px; line-height: 1.5; -webkit-font-smoothing: antialiased; padding: 20px; }

        /* --- LAYOUT --- */
        .app-container { max-width: 1440px; margin: 0 auto; display: grid; grid-template-columns: 250px 1fr; gap: 24px; min-height: 90vh; }
        
        /* Sidebar */
        .sidebar { background: var(--bg-surface); border-radius: 12px; border: 1px solid var(--border); padding: 20px; height: fit-content; box-shadow: var(--shadow-sm); display: flex; flex-direction: column; gap: 10px; }
        .nav-item { padding: 12px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; color: var(--text-muted); transition: all 0.2s; display: flex; align-items: center; gap: 10px; }
        .nav-item:hover { background: var(--info-bg); color: var(--primary); }
        .nav-item.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(2, 132, 199, 0.2); }

        /* Main Content */
        .main-content { display: flex; flex-direction: column; gap: 20px; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        h1 { font-size: 1.5rem; font-weight: 800; color: var(--primary-dark); }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        
        /* Cards & Tables */
        .card { background: var(--bg-surface); border-radius: 12px; border: 1px solid var(--border); padding: 24px; box-shadow: var(--shadow-sm); }
        .grid-dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: #fff; padding: 20px; border-radius: 10px; border: 1px solid var(--border); display: flex; flex-direction: column; }
        .stat-val { font-size: 2rem; font-weight: 800; color: var(--text-main); margin-top: 5px; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: var(--info-bg); font-weight: 700; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; }
        tr:hover { background: #f8fafc; }

        /* Forms & Inputs */
        .form-group { margin-bottom: 16px; }
        label { display: block; font-weight: 600; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-family: inherit; transition: border 0.2s; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
        
        /* Buttons */
        .btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
        .btn:hover { filter: brightness(90%); transform: translateY(-1px); }

        /* Utilities */
        .hidden { display: none !important; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .text-success { color: var(--success); } .text-danger { color: var(--danger); } .text-warning { color: var(--warning); }
        
        /* Toast */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { min-width: 300px; padding: 16px; background: white; border-left: 4px solid var(--primary); box-shadow: var(--shadow-md); border-radius: 4px; animation: slideIn 0.3s; display: flex; justify-content: space-between; align-items: center; }
        .toast.error { border-left-color: var(--danger); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15,23,42,0.6); z-index: 1000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-overlay.open { display: flex; }
        .modal-content { background: white; width: 100%; max-width: 600px; border-radius: 12px; padding: 24px; box-shadow: var(--shadow-lg); max-height: 90vh; overflow-y: auto; }
        
        /* Info Icon */
        .info-icon { font-size: 0.8rem; color: var(--info); margin-left: 5px; cursor: help; }

        /* Loading Overlay */
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 2000; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 50px; height: 50px; border: 5px solid #e2e8f0; border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            .app-container { grid-template-columns: 1fr; }
            .sidebar { flex-direction: row; overflow-x: auto; }
        }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="spinner"></div>
        <h3 style="color:var(--primary);">Sinkronisasi Server...</h3>
        <p>Mengambil data terbaru dari Cloud.</p>
    </div>

    <div class="app-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div style="padding-bottom: 15px; border-bottom: 1px solid var(--border); margin-bottom: 10px;">
                <h3 style="color: var(--primary-dark);">Sistem Linen</h3>
                <small style="color: var(--text-muted);">V4.1 Hybrid Cloud</small>
            </div>
            <div class="nav-item active" onclick="App.switchView('dashboard')">
                <i class="fas fa-chart-line"></i> Dashboard
            </div>
            <div class="nav-item" onclick="App.switchView('master')">
                <i class="fas fa-box-open"></i> Master Linen
            </div>
            <div class="nav-item" onclick="App.switchView('opname')">
                <i class="fas fa-clipboard-check"></i> Stock Opname
            </div>
            <div class="nav-item" onclick="App.switchView('analisa')">
                <i class="fas fa-calculator"></i> Analisa Kebutuhan
            </div>
            <div class="nav-item" onclick="App.switchView('config')">
                <i class="fas fa-cogs"></i> Konfigurasi RS
            </div>
            <div class="nav-item" onclick="App.switchView('audit')">
                <i class="fas fa-history"></i> Riwayat Audit
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <header>
                <div>
                    <h1 id="pageTitle">Dashboard</h1>
                    <p id="currentDate" class="text-muted"></p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-success" onclick="CloudManager.syncToCloud()"><i class="fas fa-cloud-upload-alt"></i> Sync ke Cloud</button>
                    <button class="btn btn-outline" onclick="App.backupData()"><i class="fas fa-download"></i> Backup JSON</button>
                </div>
            </header>

            <!-- VIEW: DASHBOARD -->
            <section id="view-dashboard" class="view-section">
                <div class="grid-dashboard">
                    <div class="stat-card">
                        <label>Total Item Linen</label>
                        <div class="stat-val" id="dash-total-items">0</div>
                    </div>
                    <div class="stat-card">
                        <label>Item Rusak/Afkir</label>
                        <div class="stat-val text-danger" id="dash-damaged-items">0</div>
                    </div>
                    <div class="stat-card">
                        <label>Set Ready</label>
                        <div class="stat-val text-success" id="dash-sets-ready">0</div>
                    </div>
                    <div class="stat-card">
                        <label>Biaya Penggantian</label>
                        <div class="stat-val text-warning" id="dash-replacement-cost">Rp 0</div>
                    </div>
                </div>
                
                <div class="card">
                    <h3><i class="fas fa-exclamation-triangle text-warning"></i> Peringatan Kritis</h3>
                    <div id="dashboard-warnings" style="margin-top: 15px;"></div>
                </div>
            </section>

            <!-- VIEW: MASTER LINEN -->
            <section id="view-master" class="view-section hidden">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                        <input type="text" id="masterSearch" placeholder="Cari kode/nama..." style="width: 300px;" oninput="AppUI.renderMasterTable()">
                        <button class="btn btn-primary" onclick="AppUI.openModal('add')"><i class="fas fa-plus"></i> Tambah Linen</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Kode</th><th>Nama</th><th>Tipe</th><th>Stok Baik</th><th>Stok Rusak</th><th>Stok Fisik (Set)</th><th>Harga</th><th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="masterTableBody"></tbody>
                    </table>
                </div>
            </section>

            <!-- VIEW: STOCK OPNAME -->
            <section id="view-opname" class="view-section hidden">
                <div class="card">
                    <div class="alert-box" style="background: #fffbeb; border: 1px solid #fcd34d; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <strong><i class="fas fa-info-circle"></i> Aturan:</strong> Input jumlah rusak/hilang. Stok Baik akan otomatis dikurangi.
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                        <input type="text" id="opnameSearch" placeholder="Cari item..." style="width: 300px;" oninput="AppUI.renderOpnameTable()">
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-outline" onclick="AppUI.resetOpname()">Reset</button>
                            <button class="btn btn-success" onclick="AppUI.finalizeOpname()">Finalisasi</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Kode</th><th>Nama</th><th>Stok Baik (Awal)</th><th>Input Rusak/Hilang</th><th>Sisa Baik</th><th>Catatan</th>
                            </tr>
                        </thead>
                        <tbody id="opnameTableBody"></tbody>
                    </table>
                </div>
            </section>

            <!-- VIEW: ANALISA -->
            <section id="view-analisa" class="view-section hidden">
                <div class="card">
                    <h3>Parameter Analisa</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; background: #f8fafc; padding: 15px; border-radius: 8px;">
                        <div><label>Faktor Kehilangan (%)</label><input type="number" id="param-loss-factor" value="5"></div>
                        <div><label>Umur Linen (Bulan)</label><input type="number" id="param-linen-age" value="24"></div>
                        <div style="display: flex; align-items: flex-end;">
                            <button class="btn btn-primary" onclick="App.runAnalysis()"><i class="fas fa-calculator"></i> Hitung Kebutuhan</button>
                        </div>
                    </div>
                    <table id="analysisTable">
                        <thead>
                            <tr>
                                <th>Status</th><th>Kode</th><th>Nama</th><th>Stok Saat Ini</th><th>Kebutuhan</th><th>Selisih</th><th>Rekomendasi</th>
                            </tr>
                        </thead>
                        <tbody id="analysisBody"></tbody>
                    </table>
                </div>
            </section>

            <!-- VIEW: CONFIG -->
            <section id="view-config" class="view-section hidden">
                <div class="card">
                    <h3>Konfigurasi Rumah Sakit</h3>
                    <div style="max-width: 500px; margin-top: 20px;">
                        <div class="form-group"><label>Jumlah Bed Rawat Inap</label><input type="number" id="cfg-beds"></div>
                        <div class="form-group"><label>BOR (Bed Occupancy Rate) %</label><input type="number" id="cfg-bor"></div>
                        <div class="form-group"><label>Rata-rata Operasi / Hari</label><input type="number" id="cfg-ops"></div>
                        <div class="form-group"><label>Buffer Laundry (Siklus)</label><input type="number" id="cfg-buffer"></div>
                        <button class="btn btn-primary" onclick="App.saveConfig()">Simpan Konfigurasi</button>
                    </div>
                </div>
            </section>

            <!-- VIEW: AUDIT -->
            <section id="view-audit" class="view-section hidden">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>Riwayat Aktivitas</h3>
                    </div>
                    <table style="font-size: 0.85rem;">
                        <thead>
                            <tr><th>Waktu</th><th>Aksi</th><th>Detail</th><th>User</th></tr>
                        </thead>
                        <tbody id="auditTableBody"></tbody>
                    </table>
                </div>
            </section>

        </main>
    </div>

    <!-- MODAL FORM -->
    <div id="itemModal" class="modal-overlay">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;" id="modalTitle">Tambah Linen</h2>
            <form id="linenForm" onsubmit="AppUI.saveItem(event)">
                <input type="hidden" id="inp-code">
                <div class="form-group">
                    <label>Tipe</label>
                    <select id="inp-type" onchange="AppUI.toggleSetInput(this.value)">
                        <option value="item">Item Satuan</option>
                        <option value="set">Set (Paket)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Nama Item / Set</label>
                    <input type="text" id="inp-name" required placeholder="Contoh: Sprei 180">
                </div>
                <div class="form-group">
                    <label>Kategori</label>
                    <input type="text" id="inp-category" list="listCategory" placeholder="Contoh: Sprei">
                    <datalist id="listCategory"></datalist>
                </div>
                <div class="form-group">
                    <label>Harga Satuan (Rp)</label>
                    <input type="number" id="inp-price" min="0">
                </div>
                
                <div id="set-logic-area" class="hidden" style="background: #f1f5f9; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <label>Komposisi Set (Manual Input)</label>
                    <textarea id="inp-composition" rows="3" placeholder="Contoh: Sprei 180, Sarung Bantal, Selimut"></textarea>
                    <small class="text-muted">Stok Set dihitung otomatis dari stok item terendah di dalamnya.</small>
                </div>

                <div id="item-logic-area">
                    <div class="form-group">
                        <label>Stok Awal (Baik)</label>
                        <input type="number" id="inp-stock" min="0">
                    </div>
                    <div class="form-group">
                        <label>Rasio Rotasi</label>
                        <input type="number" id="inp-rotation" value="1.0" step="0.5" min="0.5">
                    </div>
                </div>

                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn btn-outline" onclick="AppUI.closeModal()">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- TOAST CONTAINER -->
    <div id="toast-container"></div>

    <script>
        /**
         * ==========================================
         * CONFIGURATION
         * ==========================================
         */
        // GANTI SCRIPT ID INI DENGAN SCRIPT ID ANDA
        const SCRIPT_ID = "AKfycbzMZr-e8m_2edwCsf1J-gGccCZaTNoYqZspI1o8gKrYa8IdFk_1p9CnbGpPs22xaQSUIw";
        const BASE_URL = `https://script.google.com/macros/s/${SCRIPT_ID}/exec`;

        const defaults = {
            items: [
                { code: 'LIN-SPR-001', name: 'Sprei 180', type: 'item', category: 'Sprei', stock: 100, damaged: 0, price: 85000, rotation: 1.0, composition: '' },
                { code: 'LIN-SB-001', name: 'Sarung Bantal', type: 'item', category: 'Sarung', stock: 120, damaged: 0, price: 25000, rotation: 1.0, composition: '' },
                { code: 'SET-OP-001', name: 'Set Operasi Mayor', type: 'set', category: 'Set', stock: 0, damaged: 0, price: 0, rotation: 0, composition: 'Jas Dokter, Duk Kecil' }
            ],
            config: { beds: 100, bor: 70, ops: 20, buffer: 3 }
        };

        let appData = {
            items: [],
            config: {},
            audit: []
        };

        /**
         * ==========================================
         * MODULE: CLOUD MANAGER (SYNC)
         * ==========================================
         */
        const CloudManager = {
            isLoading: false,

            loadFromCloud: function() {
                this.showLoading(true);
                const callbackName = 'cb_' + Math.floor(Math.random() * 1000000);
                const url = `${BASE_URL}?callback=${callbackName}`;
                const script = document.createElement('script');
                script.src = url;
                script.onerror = () => {
                    this.showLoading(false);
                    AppUI.showToast("Gagal koneksi ke Cloud. Menggunakan data lokal.", "error");
                    this.loadFromLocal();
                };
                document.body.appendChild(script);

                window[callbackName] = (response) => {
                    document.body.removeChild(script);
                    delete window[callbackName];
                    this.showLoading(false);
                    
                    try {
                        if (response && response.status === 'success') {
                            // Merge data cloud dengan local (jika perlu), disini timpa local
                            appData.items = response.items || defaults.items;
                            appData.config = response.config || defaults.config;
                            appData.audit = response.audit || [];
                            
                            // Simpan ke local agar next load cepat
                            this.saveToLocal();
                            
                            AppUI.init();
                            AppUI.showToast("✅ Data dimuat dari Cloud", "success");
                        } else {
                            throw new Error("Format data salah");
                        }
                    } catch (e) {
                        console.error(e);
                        this.loadFromLocal(); // Fallback
                    }
                };
            },

            syncToCloud: function() {
                this.showLoading(true);
                const payload = {
                    action: "sync",
                    items: appData.items,
                    config: appData.config,
                    audit: appData.audit
                };

                fetch(BASE_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                .then(() => {
                    this.showLoading(false);
                    AppUI.showToast("✅ Data berhasil disinkronkan ke Spreadsheet!", "success");
                })
                .catch(err => {
                    this.showLoading(false);
                    AppUI.showToast("❌ Gagal sinkronisasi. Cek koneksi internet.", "error");
                    console.error(err);
                });
            },

            loadFromLocal: function() {
                const stored = localStorage.getItem('linen_hybrid_v4');
                if (stored) {
                    appData = JSON.parse(stored);
                } else {
                    appData = { items: JSON.parse(JSON.stringify(defaults.items)), config: JSON.parse(JSON.stringify(defaults.config)), audit: [] };
                }
                AppUI.init();
            },

            saveToLocal: function() {
                localStorage.setItem('linen_hybrid_v4', JSON.stringify(appData));
            },

            showLoading: function(show) {
                const el = document.getElementById('loadingOverlay');
                el.style.display = show ? 'flex' : 'none';
            }
        };

        /**
         * ==========================================
         * MODULE: DATA STORE (LOGIC)
         * ==========================================
         */
        const DataStore = {
            saveData: function() {
                // Simpan ke local dulu (instan)
                CloudManager.saveToLocal();
            },

            addItem: function(newItem) {
                // Validasi Duplikat
                const dup = appData.items.find(i => i.name.toLowerCase() === newItem.name.toLowerCase() && i.code !== newItem.code);
                if (dup) throw new Error(`Nama "${newItem.name}" sudah ada!`);

                if (newItem.code) {
                    // Edit
                    const idx = appData.items.findIndex(i => i.code === newItem.code);
                    if(idx !== -1) {
                        newItem.stock = appData.items[idx].stock;
                        newItem.damaged = appData.items[idx].damaged;
                        appData.items[idx] = newItem;
                        AuditLog.add('EDIT', `Edit ${newItem.code}`);
                    }
                } else {
                    // Add
                    newItem.code = this.generateCode(newItem.category, newItem.type);
                    if (newItem.type === 'item') newItem.stock = newItem.stock || 0;
                    appData.items.push(newItem);
                    AuditLog.add('CREATE', `Tambah ${newItem.code}`);
                }
                this.saveData();
            },

            deleteItem: function(code) {
                appData.items = appData.items.filter(i => i.code !== code);
                AuditLog.add('DELETE', `Hapus ${code}`);
                this.saveData();
            },

            processOpname: function(opnameData) {
                let changedCount = 0;
                for (const code in opnameData) {
                    const input = opnameData[code];
                    const item = appData.items.find(i => i.code === code);
                    
                    if (item && input.damaged > 0) {
                        if (input.damaged > item.stock) throw new Error(`Input rusak melebihi stok untuk ${item.name}`);
                        item.stock -= input.damaged;
                        item.damaged = (item.damaged || 0) + input.damaged;
                        AuditLog.add('OPNAME', `Opname ${item.code}: -${input.damaged}. Note: ${input.note}`);
                        changedCount++;
                    }
                }
                this.saveData();
                return changedCount;
            },

            validateComposition: function(text) {
                const errors = [];
                if (!text) return errors;
                const parts = text.split(',').map(s => s.trim()).filter(s => s);
                parts.forEach(part => {
                    const found = appData.items.find(i => i.type === 'item' && i.name.toLowerCase().includes(part.toLowerCase()));
                    if (!found) errors.push(`Item "${part}" tidak ditemukan.`);
                });
                return errors;
            },

            generateCode: function(cat, type) {
                const prefix = type === 'set' ? 'SET' : 'LIN';
                const items = appData.items.filter(i => i.code.startsWith(prefix));
                let max = 0;
                items.forEach(i => {
                    const num = parseInt(i.code.split('-').pop());
                    if (!isNaN(num) && num > max) max = num;
                });
                return `${prefix}-${cat.substring(0,3).toUpperCase()}-${String(max + 1).padStart(3, '0')}`;
            }
        };

        /**
         * ==========================================
         * MODULE: AUDIT LOG
         * ==========================================
         */
        const AuditLog = {
            add: function(action, details) {
                const newLog = {
                    timestamp: new Date().toLocaleString('id-ID'),
                    action: action,
                    details: details,
                    user: 'Admin'
                };
                appData.audit.unshift(newLog);
                if (appData.audit.length > 500) appData.audit.pop();
                CloudManager.saveToLocal(); // Trigger save
            }
        };

        /**
         * ==========================================
         * MODULE: LINEN LOGIC (CALCULATIONS)
         * ==========================================
         */
        const LinenLogic = {
            calculateSetStock: function(setItem) {
                if (!setItem.composition) return 0;
                const parts = setItem.composition.split(',').map(s => s.trim()).filter(s => s);
                let minStock = Infinity;
                
                parts.forEach(part => {
                    const component = appData.items.find(i => i.type === 'item' && i.name.toLowerCase().includes(part.toLowerCase()));
                    if (component) {
                        const avail = Math.floor(component.stock / 1);
                        if (avail < minStock) minStock = avail;
                    } else {
                        minStock = 0;
                    }
                });
                return minStock === Infinity ? 0 : minStock;
            },

            runAnalysis: function(lossFactor) {
                const results = [];
                const activeBeds = Math.floor(appData.config.beds * (appData.config.bor / 100));
                const buffer = appData.config.buffer;

                appData.items.forEach(item => {
                    if (item.type === 'set') return;

                    const neededPerCycle = activeBeds * (item.rotation || 1);
                    const totalNeeded = Math.ceil(neededPerCycle * buffer * (1 + (lossFactor/100)));
                    const diff = item.stock - totalNeeded;
                    
                    let status = 'AMAN';
                    if (diff < 0) status = diff < -10 ? 'DEFISIT KRITIS' : 'DEFISIT RINGAN';
                    else if (diff > 10) status = 'SURPLUS';

                    results.push({ code: item.code, name: item.name, stock: item.stock, needed: totalNeeded, diff: diff, status: status });
                });

                // Re-calculate Sets
                appData.items.filter(i => i.type === 'set').forEach(set => {
                    const setStock = this.calculateSetStock(set);
                    const setNeeded = appData.config.ops * buffer;
                    const diff = setStock - setNeeded;
                    let status = 'AMAN';
                    if (diff < 0) status = 'DEFISIT KRITIS';
                    results.push({ code: set.code, name: set.name + ' (SET)', stock: setStock, needed: setNeeded, diff: diff, status: status });
                });

                return results;
            }
        };

        /**
         * ==========================================
         * MODULE: APP UI
         * ==========================================
         */
        const AppUI = {
            currentEditCode: null,
            tempOpnameData: {},

            init: function() {
                document.getElementById('currentDate').innerText = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                this.renderDashboard();
                this.populateCategoryDatalist();
            },

            switchView: function(viewId) {
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                document.getElementById('view-' + viewId).classList.remove('hidden');
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                event.currentTarget.classList.add('active');
                
                const titles = { 'dashboard': 'Dashboard', 'master': 'Master Linen', 'opname': 'Stock Opname', 'analisa': 'Analisa Kebutuhan', 'config': 'Konfigurasi', 'audit': 'Riwayat Audit' };
                document.getElementById('pageTitle').innerText = titles[viewId];

                if(viewId === 'dashboard') this.renderDashboard();
                if(viewId === 'master') this.renderMasterTable();
                if(viewId === 'opname') this.renderOpnameTable();
                if(viewId === 'audit') this.renderAuditTable();
                if(viewId === 'config') this.loadConfigForm();
            },

            renderDashboard: function() {
                let totalDamaged = 0, replacementCost = 0, setsReady = 0, warnings = [];
                appData.items.forEach(item => {
                    totalDamaged += (item.damaged || 0);
                    replacementCost += ((item.damaged || 0) * item.price);
                    if (item.type === 'set') {
                        const stock = LinenLogic.calculateSetStock(item);
                        if (stock < 10) warnings.push(`<div class="text-danger">⚠️ Set <b>${item.name}</b> menipis (${stock}).</div>`);
                        else setsReady += stock;
                    }
                });

                document.getElementById('dash-total-items').innerText = appData.items.length;
                document.getElementById('dash-damaged-items').innerText = totalDamaged;
                document.getElementById('dash-sets-ready').innerText = setsReady;
                document.getElementById('dash-replacement-cost').innerText = this.formatRupiah(replacementCost);
                document.getElementById('dashboard-warnings').innerHTML = warnings.length ? warnings.join('') : '<div class="text-success">✅ Semua normal.</div>';
            },

            renderMasterTable: function() {
                const search = document.getElementById('masterSearch').value.toLowerCase();
                const tbody = document.getElementById('masterTableBody');
                tbody.innerHTML = '';

                appData.items.forEach(item => {
                    if (!item.name.toLowerCase().includes(search) && !item.code.toLowerCase().includes(search)) return;
                    const setStock = item.type === 'set' ? LinenLogic.calculateSetStock(item) : '-';
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${item.code}</td>
                        <td><b>${item.name}</b></td>
                        <td><span class="badge" style="background:${item.type==='set'?'var(--warning-bg)':'var(--info-bg)'}">${item.type.toUpperCase()}</span></td>
                        <td>${item.stock}</td>
                        <td class="text-danger">${item.damaged || 0}</td>
                        <td><b>${setStock}</b></td>
                        <td>${this.formatRupiah(item.price)}</td>
                        <td>
                            <button class="btn btn-sm btn-outline" onclick="AppUI.openModal('edit', '${item.code}')">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="AppUI.deleteItem('${item.code}')">Hapus</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            },

            // (Functions renderOpnameTable, updateOpnameInput, resetOpname, finalizeOpname, renderAuditTable, Modal handlers, Config, Analysis, Utils, Backup kept from previous V4 logic for brevity, assuming integration works seamlessly)
            
            // ... Include all UI logic methods here from V4 (renderOpnameTable, etc.) ...
            // NOTE: Due to length limits, I am providing the core structure. 
            // You must copy the UI methods from the previous V4.0 response into this section.
            
            // --- PLACEHOLDER FOR UI METHODS (Copy from V4.0) ---
            // For example: renderOpnameTable, updateOpnameInput, etc. 
            // The logic remains exactly the same, just accessing `appData` instead of calling DataStore.getData() constantly.
        };

        // --- SHIM FOR UI METHODS (Copy from V4.0) ---
        // To ensure this file works standalone, I am including the critical UI functions inline.
        AppUI.renderOpnameTable = function() {
            const search = document.getElementById('opnameSearch').value.toLowerCase();
            const tbody = document.getElementById('opnameTableBody');
            tbody.innerHTML = '';
            appData.items.forEach(item => {
                if (item.type === 'set') return;
                if (!item.name.toLowerCase().includes(search) && !item.code.toLowerCase().includes(search)) return;
                const temp = this.tempOpnameData[item.code] || { damaged: 0, note: '' };
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${item.code}</td><td>${item.name}</td><td>${item.stock}</td><td><input type="number" style="width:80px" value="${temp.damaged}" onchange="AppUI.updateOpnameInput('${item.code}', 'damaged', this.value)"></td><td class="text-primary font-bold">${item.stock - temp.damaged}</td><td><input type="text" value="${temp.note}" onchange="AppUI.updateOpnameInput('${item.code}', 'note', this.value)"></td>`;
                tbody.appendChild(tr);
            });
        };
        AppUI.updateOpnameInput = function(code, field, val) {
            if (!this.tempOpnameData[code]) this.tempOpnameData[code] = { damaged: 0, note: '' };
            this.tempOpnameData[code][field] = field === 'damaged' ? parseInt(val) || 0 : val;
            this.renderOpnameTable();
        };
        AppUI.resetOpname = function() {
            if(confirm('Reset?')) { this.tempOpnameData = {}; this.renderOpnameTable(); }
        };
        AppUI.finalizeOpname = function() {
            try {
                const count = DataStore.processOpname(this.tempOpnameData);
                this.showToast(`Sukses! ${count} item diperbarui.`, 'success');
                this.tempOpnameData = {};
                this.renderOpnameTable();
                this.renderDashboard();
            } catch (e) { this.showToast(e.message, 'error'); }
        };
        AppUI.renderAuditTable = function() {
            const tbody = document.getElementById('auditTableBody');
            tbody.innerHTML = appData.audit.map(l => `<tr><td>${l.timestamp}</td><td><span class="badge">${l.action}</span></td><td>${l.details}</td><td>${l.user}</td></tr>`).join('');
        };
        AppUI.openModal = function(mode, code) {
            const modal = document.getElementById('itemModal'); modal.classList.add('open');
            document.getElementById('linenForm').reset();
            this.currentEditCode = code;
            if(mode==='edit' && code) {
                const item = appData.items.find(i => i.code === code);
                document.getElementById('modalTitle').innerText = 'Edit Linen';
                document.getElementById('inp-code').value = item.code; document.getElementById('inp-code').disabled = true;
                document.getElementById('inp-name').value = item.name;
                document.getElementById('inp-type').value = item.type;
                document.getElementById('inp-category').value = item.category;
                document.getElementById('inp-price').value = item.price;
                document.getElementById('inp-composition').value = item.composition || '';
                document.getElementById('inp-rotation').value = item.rotation || 1.0;
            } else {
                document.getElementById('modalTitle').innerText = 'Tambah Linen';
                document.getElementById('inp-code').disabled = false;
            }
            this.toggleSetInput(document.getElementById('inp-type').value);
        };
        AppUI.closeModal = function() { document.getElementById('itemModal').classList.remove('open'); };
        AppUI.toggleSetInput = function(type) {
            if(type==='set') { document.getElementById('set-logic-area').classList.remove('hidden'); document.getElementById('item-logic-area').classList.add('hidden'); }
            else { document.getElementById('set-logic-area').classList.add('hidden'); document.getElementById('item-logic-area').classList.remove('hidden'); }
        };
        AppUI.saveItem = function(e) {
            e.preventDefault();
            const type = document.getElementById('inp-type').value;
            const newItem = {
                code: this.currentEditCode, type: type, name: document.getElementById('inp-name').value,
                category: document.getElementById('inp-category').value, price: parseInt(document.getElementById('inp-price').value)||0,
                rotation: parseFloat(document.getElementById('inp-rotation').value)||1.0, composition: document.getElementById('inp-composition').value, stock:0, damaged:0
            };
            if(type==='set') {
                const errs = DataStore.validateComposition(newItem.composition);
                if(errs.length) return this.showToast(errs[0], 'error');
            }
            try { DataStore.addItem(newItem); this.showToast('Disimpan', 'success'); this.closeModal(); this.renderMasterTable(); this.renderDashboard(); }
            catch (err) { this.showToast(err.message, 'error'); }
        };
        AppUI.deleteItem = function(code) {
            if(confirm('Hapus?')) { DataStore.deleteItem(code); this.renderMasterTable(); this.renderDashboard(); }
        };
        AppUI.loadConfigForm = function() {
            document.getElementById('cfg-beds').value = appData.config.beds;
            document.getElementById('cfg-bor').value = appData.config.bor;
            document.getElementById('cfg-ops').value = appData.config.ops;
            document.getElementById('cfg-buffer').value = appData.config.buffer;
        };
        AppUI.populateCategoryDatalist = function() {
            const cats = [...new Set(appData.items.map(i => i.category))];
            document.getElementById('listCategory').innerHTML = cats.map(c=>`<option value="${c}">`).join('');
        };
        AppUI.formatRupiah = function(num) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(num); };
        AppUI.showToast = function(msg, type='info') {
            const div = document.createElement('div');
            div.className = `toast ${type}`; div.innerHTML = `<span>${msg}</span> <i class="fas fa-times" onclick="this.parentElement.remove()"></i>`;
            document.getElementById('toast-container').appendChild(div);
            setTimeout(()=>div.remove(), 4000);
        };

        /**
         * ==========================================
         * MAIN APP CONTROLLER
         * ==========================================
         */
        const App = {
            init: function() {
                CloudManager.loadFromCloud(); // Try Cloud first
            },
            switchView: function(id) { AppUI.switchView(id); },
            syncToCloud: function() { CloudManager.syncToCloud(); },
            saveConfig: function() {
                appData.config = {
                    beds: parseInt(document.getElementById('cfg-beds').value),
                    bor: parseInt(document.getElementById('cfg-bor').value),
                    ops: parseInt(document.getElementById('cfg-ops').value),
                    buffer: parseInt(document.getElementById('cfg-buffer').value)
                };
                CloudManager.saveToLocal();
                AppUI.showToast('Config tersimpan', 'success');
            },
            runAnalysis: function() {
                const loss = parseInt(document.getElementById('param-loss-factor').value) || 0;
                const results = LinenLogic.runAnalysis(loss);
                const tbody = document.getElementById('analysisBody');
                tbody.innerHTML = '';
                results.forEach(r => {
                    const color = r.status.includes('DEFISIT') ? 'text-danger' : (r.status==='SURPLUS'?'text-warning':'text-success');
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td><span class="badge" style="background:${r.status.includes('DEFISIT')?'#fee2e2':'#dcfce7'}">${r.status}</span></td><td>${r.code}</td><td>${r.name}</td><td><b>${r.stock}</b></td><td>${r.needed}</td><td class="${color}">${r.diff}</td><td>${r.diff<0?`<b class="text-danger">BELI ${Math.abs(r.diff)}</b>`:'Cukup'}</td>`;
                    tbody.appendChild(tr);
                });
                AppUI.showToast('Analisa selesai', 'success');
            },
            backupData: function() {
                const blob = new Blob([JSON.stringify(appData, null, 2)], {type:'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `backup_linen_${Date.now()}.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            }
        };

        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
