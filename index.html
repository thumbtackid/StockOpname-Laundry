<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Laundry RS Charlie (Live)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #0284c7; --primary-dark: #0369a1; --bg: #f8fafc;
            --text: #334155; --border: #cbd5e1;
            --danger: #ef4444; --success: #22c55e; --warning: #f59e0b;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }
        
        /* Components */
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: white; border: 1px solid var(--border); color: var(--text); }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid var(--border); }
        
        /* Screens */
        #login-screen { position: fixed; inset: 0; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .login-box { background: white; padding: 40px; border-radius: 16px; width: 100%; max-width: 380px; text-align: center; box-shadow: 0 20px 25px rgba(0,0,0,0.2); }
        
        /* App Layout */
        .app-container { display: grid; grid-template-columns: 250px 1fr; height: 100vh; }
        .sidebar { background: white; border-right: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; }
        .nav-item { padding: 12px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; color: var(--text); display: flex; align-items: center; gap: 10px; }
        .nav-item:hover, .nav-item.active { background: #e0f2fe; color: var(--primary-dark); font-weight: 600; }
        
        .main-content { padding: 20px; overflow-y: auto; }
        .hidden { display: none !important; }
        
        /* Modal */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 100; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 450px; }
        
        /* Form */
        input, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 15px; }
        
        /* Toast */
        #toast-box { position: fixed; bottom: 20px; right: 20px; z-index: 200; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: #333; color: white; padding: 12px 20px; border-radius: 8px; font-size: 14px; animation: slide 0.3s ease; }
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.success { border-left: 4px solid var(--success); }
        @keyframes slide { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid var(--border); font-size: 14px; }
        th { background: #f1f5f9; color: #64748b; font-size: 12px; text-transform: uppercase; }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-screen">
        <div class="login-box">
            <h2 style="color: var(--primary); margin-bottom: 20px;">Laundry RS</h2>
            <form id="form-login">
                <input type="text" id="login-user" placeholder="Username" required>
                <input type="password" id="login-pass" placeholder="Password" required>
                <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">Masuk</button>
            </form>
            <p style="margin: 20px 0; color: #94a3b8;">atau</p>
            <button class="btn btn-outline" style="width: 100%; justify-content: center;" onclick="UI.openModal('modal-register')">Daftar Akun Baru</button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div class="app-container hidden" id="app">
        <nav class="sidebar">
            <h3 style="color: var(--primary); margin-bottom: 20px;">Laundry System</h3>
            <div class="nav-item active" onclick="App.go('dashboard')"><i class="fas fa-home"></i> Dashboard</div>
            <div class="nav-item" onclick="App.go('workflow')"><i class="fas fa-tasks"></i> Workflow</div>
            <div class="nav-item" onclick="App.go('linen')"><i class="fas fa-layer-group"></i> Data Linen</div>
            <div class="nav-item" onclick="App.go('inventory')"><i class="fas fa-box"></i> Inventory</div>
            <div id="menu-admin" class="hidden">
                <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">
                <small style="color:#999; margin-left:10px;">ADMIN AREA</small>
                <div class="nav-item" onclick="App.go('users')"><i class="fas fa-users-cog"></i> Manajemen User</div>
            </div>
            <div style="margin-top: auto;">
                <div id="user-display" style="font-size: 13px; margin-bottom: 10px; font-weight: 600;">-</div>
                <button class="btn btn-outline" style="width: 100%; justify-content: center; font-size: 13px;" onclick="Auth.logout()">Logout</button>
            </div>
        </nav>

        <main class="main-content">
            <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 id="page-title">Dashboard</h2>
                <button class="btn btn-primary" onclick="App.openAdd()"><i class="fas fa-plus"></i> Tambah Data</button>
            </header>

            <!-- VIEW: DASHBOARD -->
            <div id="view-dashboard">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div class="card"><h1 id="stat-linen">0</h1><p>Total Linen</p></div>
                    <div class="card"><h1 id="stat-trans">0</h1><p>Transaksi</p></div>
                    <div class="card"><h1 id="stat-inv">0</h1><p>Item Inventory</p></div>
                </div>
            </div>

            <!-- VIEW: WORKFLOW -->
            <div id="view-workflow" class="hidden">
                <div class="card">
                    <h3>Proses Laundry</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 100px; gap: 10px; margin-top: 15px;">
                        <input type="text" id="wf-id" placeholder="ID Linen (Cth: SET-ICU-01)">
                        <select id="wf-status">
                            <option value="Di Laundry">Terima Kotor</option>
                            <option value="Cuci">Cuci</option>
                            <option value="Setrika">Setrika</option>
                            <option value="Siap Distribusi">Siap</option>
                        </select>
                        <button class="btn btn-primary" onclick="Workflow.do()">Proses</button>
                    </div>
                </div>
                <div class="card">
                    <h3>Riwayat</h3>
                    <table><thead><tr><th>Waktu</th><th>Linen</th><th>Status</th><th>Petugas</th></tr></thead><tbody id="table-wf"></tbody></table>
                </div>
            </div>

            <!-- VIEW: LINEN -->
            <div id="view-linen" class="hidden">
                <div class="card">
                    <h3>Data Linen</h3>
                    <table><thead><tr><th>ID</th><th>Nama</th><th>Kategori</th><th>Status</th><th>Lokasi</th></tr></thead><tbody id="table-linen"></tbody></table>
                </div>
            </div>

            <!-- VIEW: INVENTORY -->
            <div id="view-inventory" class="hidden">
                <div class="card">
                    <h3>Data Inventory</h3>
                    <table><thead><tr><th>Nama</th><th>Kat</th><th>Stok</th><th>Min</th></tr></thead><tbody id="table-inv"></tbody></table>
                </div>
            </div>

            <!-- VIEW: USERS (ADMIN) -->
            <div id="view-users" class="hidden">
                <div class="card">
                    <h3>User Management</h3>
                    <table><thead><tr><th>User</th><th>Nama</th><th>Role</th><th>Status</th><th>Aksi</th></tr></thead><tbody id="table-users"></tbody></table>
                </div>
            </div>

        </main>
    </div>

    <!-- MODAL REGISTER -->
    <div class="modal" id="modal-register">
        <div class="modal-content">
            <h3>Daftar Akun</h3>
            <input type="text" id="reg-user" placeholder="Username">
            <input type="text" id="reg-name" placeholder="Nama Lengkap">
            <input type="password" id="reg-pass" placeholder="Password">
            <div style="text-align: right; margin-top: 10px;">
                <button class="btn btn-outline" onclick="UI.closeModal('modal-register')">Batal</button>
                <button class="btn btn-primary" onclick="Auth.register()">Daftar</button>
            </div>
        </div>
    </div>

    <!-- MODAL ADD -->
    <div class="modal" id="modal-add">
        <div class="modal-content">
            <h3>Tambah Data</h3>
            <div id="add-form-container"></div>
            <div style="text-align: right; margin-top: 10px;">
                <button class="btn btn-outline" onclick="UI.closeModal('modal-add')">Batal</button>
                <button class="btn btn-primary" id="btn-save-add">Simpan</button>
            </div>
        </div>
    </div>

    <div id="toast-box"></div>

    <script>
        // ==========================================
        // KONFIGURASI
        // ==========================================
        const CONFIG = {
            // GANTI URL INI DENGAN URL WEB APP BARU
            SCRIPT_URL: "https://script.google.com/macros/s/AKfycbz_Upbvn7CTWhOMnn6JYxKDCu4XMoD3y0eKGlHGLw8nLnl8yg0rmIXPaHYXpkN9_MoUjw/exec"
        };

        const State = { user: null, data: {} };

        // ==========================================
        // API CONNECTION
        // ==========================================
        const API = {
            post: async function(action, data) {
                UI.loading(true);
                try {
                    const res = await fetch(CONFIG.SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action, ...data })
                    });
                    const json = await res.json();
                    UI.loading(false);
                    return json;
                } catch (err) {
                    UI.loading(false);
                    console.error(err);
                    return { status: 'error', message: 'Koneksi Gagal: ' + err.message };
                }
            },
            
            load: async function() {
                const res = await this.post('get_all_data');
                if(res.status === 'success') {
                    State.data = res.data;
                    App.renderAll();
                }
            }
        };

        // ==========================================
        // LOGIC: AUTH
        // ==========================================
        const Auth = {
            init: function() {
                const u = localStorage.getItem('rs_user');
                if(u) this.loginSuccess(JSON.parse(u));
            },
            login: async function(e) {
                e.preventDefault();
                const u = document.getElementById('login-user').value;
                const p = document.getElementById('login-pass').value;
                const res = await API.post('login', { username: u, password: p });
                
                if(res.status === 'success') {
                    this.loginSuccess(res.user);
                } else {
                    UI.msg(res.message || 'Login gagal', 'error');
                }
            },
            register: async function() {
                const u = document.getElementById('reg-user').value;
                const n = document.getElementById('reg-name').value;
                const p = document.getElementById('reg-pass').value;
                if(!u || !n || !p) return UI.msg("Lengkapi data", "error");

                const res = await API.post('register', { username: u, fullname: n, password: p });
                UI.msg(res.message, res.status === 'success' ? 'success' : 'error');
                if(res.status === 'success') UI.closeModal('modal-register');
            },
            loginSuccess: function(user) {
                State.user = user;
                localStorage.setItem('rs_user', JSON.stringify(user));
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                document.getElementById('user-display').innerText = user.name;
                
                if(user.role === 'Admin') document.getElementById('menu-admin').classList.remove('hidden');
                else document.getElementById('menu-admin').classList.add('hidden');
                
                API.load();
            },
            logout: function() {
                localStorage.removeItem('rs_user');
                location.reload();
            },
            approve: async function(username) {
                if(!confirm("Approve user ini?")) return;
                const res = await API.post('approve_user', { adminRole: State.user.role, targetUsername: username });
                UI.msg(res.message, res.status === 'success' ? 'success' : 'error');
                if(res.status === 'success') API.load();
            }
        };

        // ==========================================
        // LOGIC: WORKFLOW
        // ==========================================
        const Workflow = {
            do: async function() {
                const id = document.getElementById('wf-id').value;
                const status = document.getElementById('wf-status').value;
                if(!id) return UI.msg("Masukkan ID Linen", "warning");

                const linen = State.data.linen.find(l => l['LinenID'] == id);
                if(!linen) return UI.msg("ID Linen tidak ditemukan", "error");
                
                const from = linen['Status(Active/Damage)'] || 'Unknown';
                
                const res = await API.post('workflow_process', {
                    linenId: id, fromStatus: from, toStatus: status,
                    operator: State.user.name
                });
                UI.msg(res.message, res.status === 'success' ? 'success' : 'error');
                if(res.status === 'success') API.load();
            }
        };

        // ==========================================
        // LOGIC: DATA MANAGER
        // ==========================================
        const DataMgr = {
            add: async function(type) {
                const container = document.getElementById('add-form-container');
                container.innerHTML = '';
                
                const fields = type === 'linen' 
                    ? [{id:'id',l:'ID'},{id:'name',l:'Nama'},{id:'cat',l:'Kat'},{id:'w',l:'Berat'},{id:'c',l:'Siklus'}]
                    : [{id:'name',l:'Nama'},{id:'cat',l:'Kat'},{id:'stock',l:'Stok'},{id:'unit',l:'Unit'},{id:'min',l:'Min'}];
                
                fields.forEach(f => container.innerHTML += `<label>${f.l}</label><input id="inp-${f.id}">`);
                
                document.getElementById('btn-save-add').onclick = async () => {
                    const d = {};
                    fields.forEach(f => d[f.id] = document.getElementById(`inp-${f.id}`).value);
                    
                    const action = type === 'linen' ? 'save_linen' : 'save_inventory';
                    const res = await API.post(action, d);
                    UI.msg(res.message, res.status === 'success' ? 'success' : 'error');
                    if(res.status === 'success') { UI.closeModal('modal-add'); API.load(); }
                };
                
                UI.openModal('modal-add');
            }
        };

        // ==========================================
        // UI & APP CONTROLLER
        // ==========================================
        const App = {
            renderAll: function() {
                // Stats
                document.getElementById('stat-linen').innerText = State.data.linen.length;
                document.getElementById('stat-trans').innerText = State.data.transactions.length;
                document.getElementById('stat-inv').innerText = State.data.inventory.length;

                // Tables
                this.fill('table-wf', [...State.data.transactions].reverse(), ['Timestamp','LinenID','Tostatus','Operator']);
                this.fill('table-linen', State.data.linen, ['LinenID','Name','Category','Status(Active/Damage)','CurrentLocation']);
                this.fill('table-inv', State.data.inventory, ['ItemName','Category','Stock','MinStock']);
                
                // Users Table Custom
                const t = document.getElementById('table-users'); t.innerHTML='';
                State.data.users.forEach(u => {
                    let btn = u['Status'] === 'Pending' ? `<button class="btn btn-primary" style="padding:5px 10px; font-size:12px;" onclick="Auth.approve('${u['Username']}')">Approve</button>` : '-';
                    t.innerHTML += `<tr><td>${u['Username']}</td><td>${u['Fullname']}</td><td>${u['Role']}</td><td>${u['Status']}</td><td>${btn}</td></tr>`;
                });
            },
            fill: function(id, data, keys) {
                const t = document.getElementById(id); t.innerHTML = '';
                data.forEach(r => {
                    let row = '<tr>';
                    keys.forEach(k => row += `<td>${r[k]||'-'}</td>`);
                    row += '</tr>';
                    t.innerHTML += row;
                });
                if(data.length===0) t.innerHTML = `<tr><td colspan="${keys.length}" style="text-align:center">Data Kosong</td></tr>`;
            },
            go: function(view) {
                document.querySelectorAll('div[id^="view-"]').forEach(e => e.classList.add('hidden'));
                document.getElementById('view-'+view).classList.remove('hidden');
                
                document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
                event.currentTarget.classList.add('active');
                
                document.getElementById('page-title').innerText = view.charAt(0).toUpperCase() + view.slice(1);
            },
            openAdd: function() {
                const v = document.querySelector('div[id^="view-"]:not(.hidden)').id.replace('view-','');
                if(v === 'linen') DataMgr.add('linen');
                else if(v === 'inventory') DataMgr.add('inventory');
                else UI.msg("Tambah data hanya tersedia di menu Linen/Inventory", "warning");
            }
        };

        const UI = {
            openModal: function(id) { document.getElementById(id).classList.add('active'); },
            closeModal: function(id) { document.getElementById(id).classList.remove('active'); },
            msg: function(txt, type='info') { // No Undefined Fix
                const t = document.createElement('div');
                t.className = `toast ${type}`;
                t.innerText = txt || "Terjadi kesalahan sistem."; 
                document.getElementById('toast-box').appendChild(t);
                setTimeout(() => t.remove(), 3000);
            },
            loading: function(show) {
                if(show) {
                    const l = document.createElement('div');
                    l.id = 'loader'; l.style = "position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.8);z-index:999;display:flex;align-items:center;justify-content:center;font-weight:bold;";
                    l.innerText = "Processing...";
                    document.body.appendChild(l);
                } else document.getElementById('loader')?.remove();
            }
        };

        // INIT
        document.getElementById('form-login').onsubmit = (e) => Auth.login(e);
        window.onload = () => Auth.init();
    </script>
</body>
</html>
