<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Linen RS Charlie (Versi Final)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary: #0284c7; --primary-dark: #0369a1;
            --bg-light: #f8fafc; --border: #e2e8f0;
            --text-main: #334155; --text-light: #64748b;
            --danger: #dc2626; --success: #16a34a;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-light); color: var(--text-main); font-size: 13px; line-height: 1.5; padding: 20px; }
        
        /* Header */
        header { margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; border-bottom: 2px solid var(--border); padding-bottom: 15px; }
        .brand h1 { font-size: 1.5rem; color: var(--primary-dark); font-weight: 700; }
        .brand p { color: var(--text-light); font-size: 0.9rem; }
        
        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid var(--border); }
        .tab-btn {
            padding: 10px 20px; background: none; border: none; border-bottom: 3px solid transparent;
            cursor: pointer; font-weight: 600; color: var(--text-light); font-size: 14px; transition: 0.3s;
        }
        .tab-btn:hover { color: var(--primary); }
        .tab-btn.active { border-bottom-color: var(--primary); color: var(--primary); }

        /* Sections */
        .section-view { display: none; animation: fadeIn 0.3s; }
        .section-view.active { display: block; }
        @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }

        /* Components */
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .card { background: white; padding: 15px; border-radius: 8px; border: 1px solid var(--border); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .card label { display: block; font-size: 0.8rem; color: var(--text-light); margin-bottom: 5px; }
        .card .value { font-size: 1.25rem; font-weight: 700; }
        
        .toolbar { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; background: white; padding: 10px; border-radius: 8px; border: 1px solid var(--border); align-items: center; }
        .search-box { flex-grow: 1; }
        .search-box input { width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; }
        
        .btn { padding: 8px 14px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 13px; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-dark); }
        .btn-success { background-color: var(--success); color: white; }
        .btn-secondary { background-color: #64748b; color: white; }
        .btn-danger { background-color: #fff1f2; color: var(--danger); border: 1px solid #fecdd3; }

        /* Table */
        .table-container { background: white; border-radius: 8px; border: 1px solid var(--border); overflow-x: auto; max-height: 75vh; position: relative; }
        table { width: 100%; border-collapse: collapse; min-width: 1200px; }
        thead { position: sticky; top: 0; background-color: #f1f5f9; z-index: 10; }
        th { text-align: left; padding: 10px 8px; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: var(--text-main); border-bottom: 2px solid var(--border); white-space: nowrap; }
        td { padding: 8px; border-bottom: 1px solid var(--border); color: var(--text-main); vertical-align: middle; }
        tr:hover { background-color: #f8fafc; }

        td input[type="number"] { width: 60px; padding: 4px; text-align: center; border: 1px solid #cbd5e1; border-radius: 4px; font-weight: 600; color: var(--primary); }
        .col-center { text-align: center; } .col-right { text-align: right; } .text-mono { font-family: monospace; }

        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; text-align: center; min-width: 60px; }
        .status-ok { background: #dcfce7; color: #166534; }
        .status-warning { background: #fef9c3; color: #854d0e; }
        .status-danger { background: #fee2e2; color: #991b1b; }
        .status-info { background: #e0f2fe; color: #075985; }

        /* Modal & Input */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; }

        /* Toast */
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 999; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 14px; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

        @media (max-width: 768px) {
            .toolbar { flex-direction: column; align-items: stretch; }
            .tabs { overflow-x: auto; }
        }
    </style>
</head>
<body>

    <!-- Notification Toast -->
    <div id="toast">Notifikasi</div>

    <header>
        <div class="brand">
            <h1>Sistem Linen RS Charlie</h1>
            <p>Opname ‚Ä¢ Mutasi ‚Ä¢ Analisa ‚Ä¢ Backup</p>
        </div>
        <div class="meta-info">
            <label>Tanggal: <input type="date" id="opnameDate"></label>
            <label>Petugas: <input type="text" id="officerName" placeholder="Nama"></label>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('opname')">üìä Stock Opname</button>
        <button class="tab-btn" onclick="switchTab('mutasi')">üîÑ Manajemen Stok (Mutasi)</button>
        <button class="tab-btn" onclick="switchTab('analisa')">üìâ Analisa Kebutuhan</button>
    </div>

    <!-- VIEW 1: STOCK OPNAME -->
    <section id="view-opname" class="section-view active">
        <div class="summary-cards">
            <div class="card"><label>Total Item</label><div class="value" id="op-totalItems">0</div></div>
            <div class="card"><label>Selisih Stok</label><div class="value" id="op-totalDiff">0</div></div>
            <div class="card"><label>Nilai Selisih</label><div class="value text-danger" id="op-totalVal">0</div></div>
        </div>

        <div class="toolbar">
            <div class="search-box"><input type="text" id="opSearch" placeholder="Cari item..." oninput="renderOpnameTable()"></div>
            <select id="opCategory" style="padding:8px; border-radius:6px; border:1px solid var(--border)" onchange="renderOpnameTable()"><option value="">Semua Kategori</option></select>
            
            <!-- Backup Buttons -->
            <button class="btn btn-secondary" onclick="downloadBackup()">üíæ Backup Data</button>
            <label class="btn btn-secondary" style="cursor:pointer">
                üìÇ Restore Data
                <input type="file" id="restoreFile" accept=".json" style="display:none" onchange="restoreBackup(this)">
            </label>

            <button class="btn btn-danger" onclick="resetOpname()">Reset Input</button>
            <button class="btn btn-primary" onclick="exportOpnameExcel()">Export Excel</button>
        </div>

        <div class="table-container">
            <table id="opTable">
                <thead>
                    <tr>
                        <th>Kode</th><th>Nama</th><th>Kategori</th><th>Ukuran/Warna</th>
                        <th class="col-center">Stok<br>Awal</th>
                        <th class="col-center" style="background:#e0f2fe">Stok<br>Fisik</th>
                        <th class="col-center">Selisih</th><th>Status</th><th class="col-right">Nilai Selisih</th>
                    </tr>
                </thead>
                <tbody id="opBody"></tbody>
            </table>
        </div>
    </section>

    <!-- VIEW 2: MUTASI STOK -->
    <section id="view-mutasi" class="section-view">
        <div class="card" style="margin-bottom: 20px;">
            <h3>Form Mutasi Stok (Penambahan / Pengurangan)</h3>
            <p style="margin-bottom:15px; color:var(--text-light)">Gunakan form ini jika ada pembelian baru, linen rusak, atau linen hilang.</p>
            
            <div class="form-group">
                <label>Pilih Item</label>
                <select id="mutasiItem" style="width:100%; padding:10px;"></select>
            </div>
            <div class="form-group">
                <label>Jenis Mutasi</label>
                <select id="mutasiType">
                    <option value="in">‚ûï Penambahan (Barang Masuk)</option>
                    <option value="out">‚ûñ Pengurangan (Rusak / Hilang / Afkir)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Jumlah</label>
                <input type="number" id="mutasiQty" min="1" value="1">
            </div>
            <div class="form-group">
                <label>Keterangan (Opsional)</label>
                <input type="text" id="mutasiDesc" placeholder="Contoh: Restock mingguan / Afkir karena sobek">
            </div>
            <button class="btn btn-primary" onclick="processMutasi()">Simpan Mutasi</button>
        </div>

        <h4>Riwayat Mutasi Terakhir (Sesi Ini)</h4>
        <div class="table-container" style="max-height: 300px; margin-top:10px;">
            <table id="historyTable">
                <thead><tr><th>Waktu</th><th>Item</th><th>Jenis</th><th>Jml</th><th>Ket</th></tr></thead>
                <tbody id="historyBody"></tbody>
            </table>
        </div>
    </section>

    <!-- VIEW 3: ANALISA KEBUTUHAN -->
    <section id="view-analisa" class="section-view">
        <div class="summary-cards">
            <div class="card"><label>Item Kurang (Defisit)</label><div class="value text-danger" id="an-deficitCount">0</div></div>
            <div class="card"><label>Item Lebih (Surplus)</label><div class="value text-success" id="an-surplusCount">0</div></div>
            <div class="card"><label>Total Estimasi Biaya Defisit</label><div class="value text-danger" id="an-deficitCost">Rp 0</div></div>
        </div>

        <div class="toolbar">
            <div class="search-box"><input type="text" id="anSearch" placeholder="Cari..." oninput="renderAnalysisTable()"></div>
            <div>
                <label style="margin-right:10px; font-weight:600">Filter:</label>
                <select id="anFilter" style="padding:8px;" onchange="renderAnalysisTable()">
                    <option value="all">Semua</option>
                    <option value="deficit">‚ö†Ô∏è Hanya Yang Kurang</option>
                    <option value="surplus">‚úÖ Hanya Yang Lebih</option>
                </select>
            </div>
            <button class="btn btn-primary" style="margin-left:auto" onclick="exportAnalysisExcel()">üì• Download Analisa Excel</button>
        </div>

        <div class="table-container">
            <table id="anTable">
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Kode</th><th>Nama Item</th>
                        <th class="col-center">Stok<br>Aktual*</th>
                        <th class="col-center">Stok<br>Standar</th>
                        <th class="col-center">Selisih<br>Kebutuhan</th>
                        <th class="col-right">Harga<br>Estimasi</th>
                    </tr>
                </thead>
                <tbody id="anBody"></tbody>
                <tfoot>
                    <tr style="font-weight:700; background:#f1f5f9;">
                        <td colspan="5" style="text-align:right; padding-right:15px;">GRAND TOTAL ESTIMASI BIAYA (ITEM KURANG):</td>
                        <td colspan="2" id="an-totalFooter" style="padding:15px; color:#dc2626; font-size:1.1em;">Rp 0</td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <p style="font-size:0.8rem; color:#666; margin-top:10px;">*Stok Aktual adalah hasil perhitungan: <b>Stok Fisik (Opname)</b> atau <b>Stok Awal (Sistem)</b> jika belum dihitung.</p>
    </section>

    <!-- Scripts -->
    <script>
        // --- 1. DATA MASTER (Hardcoded) ---
        const initialMasterData = [
            { kode: "BJOP001", nama: "BAJU PASIEN ANAK", stokAwal: 32, ukuran: "Kecil", warna: "Biru", satuan: "Pcs", kategori: "Baju / Pakaian", stdStok: 36, harga: 85000 },
            { kode: "BJOP002", nama: "BAJU PASIEN DEWASA", stokAwal: 41, ukuran: "Besar", warna: "Biru", satuan: "Pcs", kategori: "Baju / Pakaian", stdStok: 96, harga: 120000 },
            { kode: "B001", nama: "BANTAL", stokAwal: 105, ukuran: "standart", warna: "Putih", satuan: "Pcs", kategori: "Perlengkapan Tidur", stdStok: 366, harga: 30000 },
            { kode: "G001", nama: "GULING", stokAwal: 4, ukuran: "standart", warna: "Putih", satuan: "Pcs", kategori: "Perlengkapan Tidur", stdStok: 6, harga: 30000 },
            { kode: "PRL003", nama: "PERLAK", stokAwal: 88, ukuran: "75 X 110", warna: "Putih", satuan: "Pcs", kategori: "Pelindung", stdStok: 336, harga: 60000 },
            { kode: "SB001", nama: "SARUNG BANTAL", stokAwal: 62, ukuran: "70x50", warna: "Biru", satuan: "Pcs", kategori: "Perlengkapan Tidur", stdStok: 135, harga: 30000 },
            { kode: "SB002", nama: "SARUNG BANTAL", stokAwal: 53, ukuran: "70x50", warna: "Hijau Muda", satuan: "Pcs", kategori: "Perlengkapan Tidur", stdStok: 75, harga: 30000 },
            { kode: "SB003", nama: "SARUNG BANTAL", stokAwal: 92, ukuran: "70x50", warna: "Hijau tua", satuan: "Pcs", kategori: "Perlengkapan Tidur", stdStok: 75, harga: 30000 },
            { kode: "SB004", nama: "SARUNG BANTAL", stokAwal: 0, ukuran: "70x50", warna: "", satuan: "Pcs", kategori: "Perlengkapan Tidur", stdStok: 0, harga: 30000 },
            { kode: "SLM001", nama: "SELIMUT", stokAwal: 0, ukuran: "150 x 200", warna: "Lurik Hijau", satuan: "Pcs", kategori: "Selimut / Bed Cover", stdStok: 15, harga: 150000 },
            { kode: "SLM002", nama: "SELIMUT", stokAwal: 7, ukuran: "150 x 200", warna: "Coklat", satuan: "Pcs", kategori: "Selimut / Bed Cover", stdStok: 15, harga: 150000 },
            { kode: "SLM005", nama: "SELIMUT", stokAwal: 7, ukuran: "150 x 200", warna: "Hijau", satuan: "Pcs", kategori: "Selimut / Bed Cover", stdStok: 150, harga: 150000 },
            { kode: "SLM003", nama: "SELIMUT", stokAwal: 29, ukuran: "150 x 200", warna: "Biru", satuan: "Pcs", kategori: "Selimut / Bed Cover", stdStok: 231, harga: 150000 },
            { kode: "SLM004", nama: "SELIMUT", stokAwal: 18, ukuran: "150 x 200", warna: "Putih/List Biru", satuan: "Pcs", kategori: "Selimut / Bed Cover", stdStok: 36, harga: 150000 },
            { kode: "SP001", nama: "SPREY", stokAwal: 101, ukuran: "200x90x25", warna: "Biru", satuan: "Pcs", kategori: "Sprei / Laken", stdStok: 153, harga: 100000 },
            { kode: "SP002", nama: "SPREY", stokAwal: 77, ukuran: "200x90x25", warna: "Hijau tua", satuan: "Pcs", kategori: "Sprei / Laken", stdStok: 75, harga: 100000 },
            { kode: "SP003", nama: "SPREY", stokAwal: 34, ukuran: "200x90x25", warna: "Hijau Muda", satuan: "Pcs", kategori: "Sprei / Laken", stdStok: 75, harga: 100000 },
            { kode: "LKN001", nama: "STIK LAKEN", stokAwal: 23, ukuran: "160x75", warna: "Hijau Muda", satuan: "Pcs", kategori: "Sprei / Laken", stdStok: 75, harga: 25000 },
            { kode: "LKN002", nama: "STIK LAKEN", stokAwal: 46, ukuran: "160x75", warna: "Hijau tua", satuan: "Pcs", kategori: "Sprei / Laken", stdStok: 75, harga: 25000 },
            { kode: "LKN003", nama: "STIK LAKEN", stokAwal: 64, ukuran: "160x75", warna: "Biru", satuan: "Pcs", kategori: "Sprei / Laken", stdStok: 138, harga: 25000 },
            { kode: "IBSDUK008", nama: "ALAS MEJA OP NON STERIL", stokAwal: 30, ukuran: "145 x 145", warna: "Hijau tua", satuan: "Pcs", kategori: "LAINNYA", stdStok: 36, harga: 125000 },
            { kode: "IBSBJ001", nama: "BAJU PERAWAT-M", stokAwal: 4, ukuran: "M", warna: "Hijau tua", satuan: "Pcs", kategori: "Baju / Pakaian", stdStok: 30, harga: 100000 },
            { kode: "IBSBJ002", nama: "CELANA PERAWAT-M", stokAwal: 4, ukuran: "M", warna: "Hijau tua", satuan: "Pcs", kategori: "Baju / Pakaian", stdStok: 30, harga: 100000 },
            { kode: "IBSBJ003", nama: "BAJU PERAWAT-L", stokAwal: 25, ukuran: "L", warna: "Hijau tua", satuan: "Pcs", kategori: "Baju / Pakaian", stdStok: 30, harga: 100000 },
            { kode: "IBSBJ004", nama: "CELANA PERAWAT-L", stokAwal: 22, ukuran: "L", warna: "Hijau tua", satuan: "Pcs", kategori: "Baju / Pakaian", stdStok: 30, harga: 100000 },
            { kode: "IBSBJ005", nama: "BAJU PERAWAT-XL", stokAwal: 15, ukuran: "XL", warna: "Hijau tua", satuan: "Pcs", kategori: "Baju / Pakaian", stdStok: 30, harga: 100000 },
            { kode: "IBSBJ006", nama: "CELANA PERAWAT-XL", stokAwal: 13, ukuran: "XL", warna: "Hijau tua", satuan: "Pcs", kategori: "Baju / Pakaian", stdStok: 30, harga: 100000 },
            { kode: "IBSBJ007", nama: "BAJU PERAWAT-XXL", stokAwal: 17, ukuran: "XXL", warna: "Hijau tua", satuan: "Pcs", kategori: "Baju / Pakaian", stdStok: 30, harga: 100000 },
            { kode: "IBSBJ008", nama: "CELANA PERAWAT-XXL", stokAwal: 16, ukuran: "XXL", warna: "Hijau tua", satuan: "Pcs", kategori: "Baju / Pakaian", stdStok: 30, harga: 100000 },
            { kode: "APR001", nama: "APRON HITAM VK", stokAwal: 6, ukuran: "90 x 70", warna: "Hitam", satuan: "Pcs", kategori: "Pelindung", stdStok: 15, harga: 40000 },
            { kode: "APR002", nama: "APRON HIJAU OK", stokAwal: 5, ukuran: "90 x 70", warna: "Hijau", satuan: "Pcs", kategori: "Pelindung", stdStok: 15, harga: 40000 },
            { kode: "IBSDUK001", nama: "DUK BESAR", stokAwal: 4, ukuran: "135 x 160", warna: "Hijau", satuan: "Pcs", kategori: "LAINNYA", stdStok: 36, harga: 125000 },
            { kode: "IBSDUK002", nama: "DUK SEDANG", stokAwal: 1, ukuran: "95 x 135", warna: "Hijau", satuan: "Pcs", kategori: "LAINNYA", stdStok: 36, harga: 100000 },
            { kode: "IBSDUK003", nama: "DUK KECIL", stokAwal: 1, ukuran: "90 x 60", warna: "Hijau", satuan: "Pcs", kategori: "LAINNYA", stdStok: 36, harga: 40000 },
            { kode: "IBSDUK004", nama: "DUK SAMPING", stokAwal: 0, ukuran: "Bervariatif", warna: "Hijau", satuan: "Pcs", kategori: "LAINNYA", stdStok: 36, harga: 40000 },
            { kode: "IBSDUK009", nama: "DUK LUBANG", stokAwal: 3, ukuran: "10 Cm", warna: "Hijau", satuan: "Pcs", kategori: "LAINNYA", stdStok: 36, harga: 40000 },
            { kode: "IBSDUK005", nama: "DUK LUBANG", stokAwal: 3, ukuran: "5 Cm", warna: "Hijau", satuan: "Pcs", kategori: "LAINNYA", stdStok: 36, harga: 40000 },
            { kode: "IBSJAS001", nama: "JAS DOKTER", stokAwal: 5, ukuran: "Bervariatif", warna: "Hijau", satuan: "Pcs", kategori: "LAINNYA", stdStok: 36, harga: 250000 },
            { kode: "IBSDUK006", nama: "PEMBUNGKUS LINEN", stokAwal: 0, ukuran: "120x115", warna: "Hijau", satuan: "Pcs", kategori: "LAINNYA", stdStok: 51, harga: 100000 },
            { kode: "GWN001", nama: "GOWN", stokAwal: 61, ukuran: "Bervariatif", warna: "Hijau", satuan: "Pcs", kategori: "Baju / Pakaian", stdStok: 249, harga: 50000 },
            { kode: "SG001", nama: "SARUNG GULING", stokAwal: 0, ukuran: "35 x 75", warna: "Biru", satuan: "Pcs", kategori: "Perlengkapan Tidur", stdStok: 6, harga: 30000 },
            { kode: "IBSDUK007", nama: "SARUNG MEJA MAYO", stokAwal: 0, ukuran: "70 X 100", warna: "Hijau", satuan: "Pcs", kategori: "Sarung", stdStok: 36, harga: 60000 },
            { kode: "PRL001", nama: "PERLAK", stokAwal: 18, ukuran: "150 X 100", warna: "Hijau", satuan: "Pcs", kategori: "Pelindung", stdStok: 36, harga: 60000 },
            { kode: "PRL002", nama: "PERLAK", stokAwal: 5, ukuran: "75 X 110", warna: "Coklat", satuan: "Pcs", kategori: "Pelindung", stdStok: 15, harga: 60000 },
            { kode: "TP001", nama: "TOPI", stokAwal: 49, ukuran: "Bervariatif", warna: "Hijau", satuan: "Pcs", kategori: "LAINNYA", stdStok: 15, harga: 0 },
            { kode: "BPJ001", nama: "BAJU PEMULASARAAN JENAZAH", stokAwal: 0, ukuran: "XL", warna: "Abu-Abu", satuan: "Pcs", kategori: "Baju / Pakaian", stdStok: 6, harga: 100000 },
            { kode: "BPJ002", nama: "CELANA PEMULASARAN JENAZAH", stokAwal: 0, ukuran: "XL", warna: "Abu-Abu", satuan: "Pcs", kategori: "Baju / Pakaian", stdStok: 6, harga: 100000 },
            { kode: "SP004", nama: "SPREY", stokAwal: 0, ukuran: "200x90x25", warna: "Ungu", satuan: "Pcs", kategori: "Sprei / Laken", stdStok: 36, harga: 100000 },
            { kode: "SB005", nama: "SARUNG BANTAL", stokAwal: 0, ukuran: "70x50", warna: "Ungu", satuan: "Pcs", kategori: "Perlengkapan Tidur", stdStok: 36, harga: 30000 },
            { kode: "LKN005", nama: "STIK LAKEN", stokAwal: 0, ukuran: "160x75", warna: "Ungu", satuan: "Pcs", kategori: "Sprei / Laken", stdStok: 36, harga: 25000 },
            { kode: "SP005", nama: "SPREY", stokAwal: 8, ukuran: "200x90x25", warna: "Biru Tua", satuan: "Pcs", kategori: "Sprei / Laken", stdStok: 36, harga: 100000 },
            { kode: "SB006", nama: "SARUNG BANTAL", stokAwal: 19, ukuran: "70x50", warna: "Biru Tua", satuan: "Pcs", kategori: "Perlengkapan Tidur", stdStok: 36, harga: 30000 },
            { kode: "LKN004", nama: "STIK LAKEN", stokAwal: 6, ukuran: "160x75", warna: "Biru Tua", satuan: "Pcs", kategori: "Sprei / Laken", stdStok: 36, harga: 25000 },
            { kode: "SLM006", nama: "SELIMUT", stokAwal: 9, ukuran: "150 x 200", warna: "Biru Tua", satuan: "Pcs", kategori: "Selimut / Bed Cover", stdStok: 36, harga: 150000 },
            { kode: "KELAS1005", nama: "BED COVER", stokAwal: 6, ukuran: "150 x 230", warna: "Biru", satuan: "Set", kategori: "Selimut / Bed Cover", stdStok: 15, harga: 400000 },
            { kode: "KELAS1001", nama: "SPREY MUSTARD", stokAwal: 6, ukuran: "200x90x25", warna: "Mustard", satuan: "Pcs", kategori: "Sprei / Laken", stdStok: 15, harga: 0 },
            { kode: "KELAS1002", nama: "SARUNG BANTAL", stokAwal: 6, ukuran: "70x50", warna: "Mustard", satuan: "Pcs", kategori: "Perlengkapan Tidur", stdStok: 15, harga: 0 },
            { kode: "KELAS1003", nama: "LAKEN", stokAwal: 6, ukuran: "160x75", warna: "Mustard", satuan: "Pcs", kategori: "Sprei / Laken", stdStok: 15, harga: 0 },
            { kode: "KELAS1004", nama: "SARUNG BANTAL OSCAR", stokAwal: 69, ukuran: "80x60", warna: "Biru", satuan: "Pcs", kategori: "Perlengkapan Tidur", stdStok: 366, harga: 35000 },
            { kode: "IBSBJ009", nama: "BAJU PERAWAT-XXXL", stokAwal: 4, ukuran: "XXXL", warna: "Hijau", satuan: "Pcs", kategori: "Baju / Pakaian", stdStok: 9, harga: 100000 },
            { kode: "IBSBJ010", nama: "CELANA PERAWAT-XXXL", stokAwal: 4, ukuran: "XXXL", warna: "Hijau", satuan: "Pcs", kategori: "Baju / Pakaian", stdStok: 9, harga: 100000 },
            { kode: "VVIP001", nama: "SPREY BIRU SUITE ROOM & VVIP", stokAwal: 7, ukuran: "Set", warna: "Set", satuan: "Set", kategori: "Sprei / Laken", stdStok: 6, harga: 400000 },
            { kode: "VVIP002", nama: "SARUNG BANTAL SUITE ROOM & VVIP", stokAwal: 7, ukuran: "Set", warna: "Set", satuan: "Set", kategori: "Perlengkapan Tidur", stdStok: 6, harga: 0 },
            { kode: "VVIP003", nama: "SARUNG GULING SUITE ROOM & VVIP", stokAwal: 4, ukuran: "Set", warna: "Set", satuan: "Set", kategori: "Perlengkapan Tidur", stdStok: 6, harga: 0 },
            { kode: "BJOP003", nama: "BAJU PASIEN ICU/HCU", stokAwal: 3, ukuran: "M", warna: "Ungu", satuan: "Pcs", kategori: "Baju / Pakaian", stdStok: 36, harga: 120000 },
            { kode: "BJOP004", nama: "BAJU PASIEN ICU/HCU", stokAwal: 10, ukuran: "XL", warna: "Ungu", satuan: "Pcs", kategori: "Baju / Pakaian", stdStok: 36, harga: 120000 },
            { kode: "BJOP005", nama: "BAJU PASIEN ICU/HCU", stokAwal: 4, ukuran: "XXL", warna: "Ungu", satuan: "Pcs", kategori: "Baju / Pakaian", stdStok: 36, harga: 120000 },
            { kode: "BJOP006", nama: "BAJU PASIEN IGD", stokAwal: 4, ukuran: "Besar", warna: "Hijau", satuan: "Pcs", kategori: "Baju / Pakaian", stdStok: 3, harga: 120000 },
            { kode: "SLM007", nama: "SELIMUT", stokAwal: 7, ukuran: "150 x 200", warna: "Putih/List Hijau", satuan: "Pcs", kategori: "Selimut / Bed Cover", stdStok: 393, harga: 92000 }
        ];

        // --- STATE MANAGEMENT ---
        let masterData = [];
        let opnameResults = {}; // { kode: stokFisik }
        let mutasiHistory = []; 

        // --- LOCAL STORAGE ---
        function saveToLocal() {
            localStorage.setItem('rs_charlie_linen_v4', JSON.stringify({ master: masterData, opname: opnameResults }));
        }

        function loadFromLocal() {
            const saved = localStorage.getItem('rs_charlie_linen_v4');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    masterData = parsed.master || [];
                    opnameResults = parsed.opname || {};
                    return true;
                } catch (e) { return false; }
            }
            return false;
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('opnameDate').valueAsDate = new Date();
            const hasData = loadFromLocal();
            if (!hasData) masterData = JSON.parse(JSON.stringify(initialMasterData));

            populateCategoryFilter();
            populateMutasiDropdown();
            renderOpnameTable();
            renderAnalysisTable();
            updateOpnameSummary();
        });

        // --- TAB SWITCHING ---
        function switchTab(tabId) {
            document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById('view-' + tabId).classList.add('active');
            event.target.classList.add('active');

            if(tabId === 'opname') renderOpnameTable();
            if(tabId === 'analisa') renderAnalysisTable();
        }

        // --- VIEW 1: OPNAME FUNCTIONS ---
        function populateCategoryFilter() {
            const select = document.getElementById('opCategory');
            while (select.options.length > 1) select.remove(1);
            [...new Set(masterData.map(i => i.kategori))].sort().forEach(c => {
                const opt = document.createElement('option');
                opt.value = c; opt.textContent = c;
                select.appendChild(opt);
            });
        }

        function renderOpnameTable() {
            const key = document.getElementById('opSearch').value.toLowerCase();
            const cat = document.getElementById('opCategory').value;
            const tbody = document.getElementById('opBody');
            tbody.innerHTML = '';

            masterData.filter(i => 
                (cat === "" || i.kategori === cat) && 
                (i.nama.toLowerCase().includes(key) || i.kode.toLowerCase().includes(key))
            ).forEach(item => {
                const fisik = opnameResults[item.kode] || 0;
                const selisih = fisik - item.stokAwal;
                const valSelisih = selisih * item.harga;
                
                let badge = '', color = '';
                if(selisih === 0) { badge = 'Sesuai'; color='status-ok'; }
                else if(selisih > 0) { badge = 'Lebih'; color='status-warning'; }
                else { badge = 'Kurang'; color='status-danger'; }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="text-mono">${item.kode}</td>
                    <td>${item.nama}</td><td>${item.kategori}</td>
                    <td>${item.ukuran} / ${item.warna}</td>
                    <td class="col-center"><b>${item.stokAwal}</b></td>
                    <td class="col-center" style="background:#e0f2fe">
                        <input type="number" value="${fisik}" onchange="updateOpname('${item.kode}', this.value)" oninput="updateOpname('${item.kode}', this.value)">
                    </td>
                    <td class="col-center" class="${color === 'status-danger' ? 'text-danger' : (color==='status-warning'?'text-warning':'text-success')}">${selisih}</td>
                    <td><span class="badge ${color}">${badge}</span></td>
                    <td class="col-right">${formatRupiah(valSelisih)}</td>
                `;
                tbody.appendChild(tr);
            });
            updateOpnameSummary();
        }

        function updateOpname(kode, val) {
            opnameResults[kode] = parseInt(val) || 0;
            saveToLocal();
            // No full re-render needed for perf, just update DOM logic can be added here
            // But re-render ensures consistency easily in this scope
            renderOpnameTable(); 
        }

        function updateOpnameSummary() {
            let totalDiff = 0, totalVal = 0;
            masterData.forEach(item => {
                const diff = (opnameResults[item.kode] || 0) - item.stokAwal;
                totalDiff += diff;
                totalVal += (diff * item.harga);
            });
            document.getElementById('op-totalItems').innerText = masterData.length;
            document.getElementById('op-totalDiff').innerText = totalDiff;
            document.getElementById('op-totalVal').innerText = formatRupiah(totalVal);
        }

        function resetOpname() {
            if(confirm("Reset input stok fisik?")) {
                opnameResults = {};
                saveToLocal();
                renderOpnameTable();
            }
        }

        function exportOpnameExcel() {
            const date = document.getElementById('opnameDate').value;
            const officer = document.getElementById('officerName').value || "-";
            
            const exportData = masterData.map(item => {
                const fisik = opnameResults[item.kode] || 0;
                const selisih = fisik - item.stokAwal;
                let status = "Sesuai";
                if(selisih > 0) status = "Lebih";
                if(selisih < 0) status = "Kurang";
                return {
                    "Kode": item.kode, "Nama": item.nama, "Kategori": item.kategori,
                    "Stok Awal": item.stokAwal, "Stok Fisik": fisik, "Selisih": selisih,
                    "Status": status, "Nilai Selisih": selisih * item.harga
                };
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet([]);
            XLSX.utils.sheet_add_aoa(ws, [
                ["LAPORAN STOCK OPNAME LINEN RS CHARLIE"],
                [`Tanggal: ${date}`, `Petugas: ${officer}`],
                []
            ], { origin: "A1" });
            XLSX.utils.sheet_add_json(ws, exportData, { origin: "A4" });
            XLSX.utils.book_append_sheet(wb, ws, "Opname");
            XLSX.writeFile(wb, `Laporan_Opname_RS_Charlie_${date}.xlsx`);
        }

        // --- VIEW 2: MUTASI FUNCTIONS ---
        function populateMutasiDropdown() {
            const sel = document.getElementById('mutasiItem');
            sel.innerHTML = '';
            masterData.sort((a,b) => a.nama.localeCompare(b.nama)).forEach(i => {
                const opt = document.createElement('option');
                opt.value = i.kode;
                opt.textContent = `${i.kode} - ${i.nama} (Stok: ${i.stokAwal})`;
                sel.appendChild(opt);
            });
        }

        function processMutasi() {
            const kode = document.getElementById('mutasiItem').value;
            const type = document.getElementById('mutasiType').value;
            const qty = parseInt(document.getElementById('mutasiQty').value);
            const ket = document.getElementById('mutasiDesc').value || "-";

            if (!kode || qty <= 0) return alert("Isi data dengan benar");

            const item = masterData.find(i => i.kode === kode);
            
            // Validasi stok
            if (type === 'out' && item.stokAwal < qty) {
                return alert("Stok tidak mencukupi untuk pengurangan!");
            }

            if (type === 'in') item.stokAwal += qty;
            else item.stokAwal -= qty;

            const log = {
                date: new Date().toLocaleString(),
                kode: kode, nama: item.nama,
                type: type === 'in' ? 'MASUK' : 'KELUAR',
                qty: qty, ket: ket
            };
            mutasiHistory.unshift(log);

            saveToLocal();
            populateMutasiDropdown();
            renderHistoryTable();
            showToast(`Mutasi Berhasil: ${item.nama}`);
            
            document.getElementById('mutasiQty').value = 1;
            document.getElementById('mutasiDesc').value = "";
        }

        function renderHistoryTable() {
            const tbody = document.getElementById('historyBody');
            tbody.innerHTML = '';
            mutasiHistory.forEach(h => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-size:0.8rem">${h.date}</td>
                    <td>${h.nama}</td>
                    <td><span class="badge ${h.type==='MASUK'?'status-ok':'status-danger'}">${h.type}</span></td>
                    <td>${h.qty}</td>
                    <td style="font-size:0.8rem; color:#666">${h.ket}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- VIEW 3: ANALISA FUNCTIONS ---
        function renderAnalysisTable() {
            const key = document.getElementById('anSearch').value.toLowerCase();
            const filter = document.getElementById('anFilter').value; 
            const tbody = document.getElementById('anBody');
            tbody.innerHTML = '';

            let deficitCount = 0;
            let deficitCost = 0;
            let surplusCount = 0;

            masterData.forEach(item => {
                if (!item.nama.toLowerCase().includes(key)) return;

                // LOGIC FIX: Get Current Stock
                let stokAktual = getCurrentStock(item); 
                // getCurrentStock checks opnameResults first, then stokAwal

                const diff = stokAktual - item.stdStok; // Selisih Standar
                
                // Filter Logic
                if (filter === 'deficit' && diff >= 0) return;
                if (filter === 'surplus' && diff <= 0) return;

                // Stats
                if (diff < 0) {
                    deficitCount++;
                    deficitCost += (Math.abs(diff) * item.harga);
                } else if (diff > 0) {
                    surplusCount++;
                }

                const tr = document.createElement('tr');
                let statusBadge = '', statusColor = '';
                
                if (diff < 0) {
                    statusBadge = 'KURANG'; statusColor = 'status-danger';
                } else if (diff > 0) {
                    statusBadge = 'LEBIH'; statusColor = 'status-ok';
                } else {
                    statusBadge = 'PAS'; statusColor = 'status-info';
                }

                tr.innerHTML = `
                    <td><span class="badge ${statusColor}">${statusBadge}</span></td>
                    <td class="text-mono">${item.kode}</td>
                    <td>${item.nama}</td>
                    <td class="col-center"><b>${stokAktual}</b></td>
                    <td class="col-center">${item.stdStok}</td>
                    <td class="col-center" style="${diff < 0 ? 'color:red; font-weight:bold' : ''}">${diff}</td>
                    <td class="col-right">${diff < 0 ? formatRupiah(Math.abs(diff)*item.harga) : '-'}</td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('an-deficitCount').innerText = deficitCount;
            document.getElementById('an-surplusCount').innerText = surplusCount;
            document.getElementById('an-deficitCost').innerText = formatRupiah(deficitCost);
            document.getElementById('an-totalFooter').innerText = formatRupiah(deficitCost);
        }

        function exportAnalysisExcel() {
            const exportData = [];
            let totalDeficitCost = 0;

            masterData.forEach(item => {
                let stokAktual = getCurrentStock(item);
                const diff = stokAktual - item.stdStok;
                let status = (diff < 0) ? "KURANG" : ((diff > 0) ? "LEBIH" : "PAS");
                
                // Only include if filtered or show all? Let's export ALL for complete analysis
                let costEst = (diff < 0) ? (Math.abs(diff) * item.harga) : 0;
                if (diff < 0) totalDeficitCost += costEst;

                exportData.push({
                    "Status": status,
                    "Kode": item.kode,
                    "Nama Item": item.nama,
                    "Kategori": item.kategori,
                    "Stok Aktual (Fisik/Sistem)": stokAktual,
                    "Stok Standar": item.stdStok,
                    "Selisih Kebutuhan": diff,
                    "Estimasi Biaya Jika Kurang": costEst
                });
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet([]);
            
            // Headers
            XLSX.utils.sheet_add_aoa(ws, [
                ["ANALISA KEBUTUHAN LINEN RS CHARLIE"],
                [`Tanggal Analisa: ${new Date().toLocaleDateString()}`],
                []
            ], { origin: "A1" });
            
            // Data
            XLSX.utils.sheet_add_json(ws, exportData, { origin: "A4" });

            // Add Footer Total
            const lastRow = exportData.length + 4;
            XLSX.utils.sheet_add_aoa(ws, [
                ["", "", "", "", "", "TOTAL ESTIMASI BIAYA DEFISIT:", totalDeficitCost]
            ], { origin: `A${lastRow + 2}` });

            XLSX.utils.book_append_sheet(wb, ws, "Analisa");
            XLSX.writeFile(wb, `Analisa_Kebutuhan_Linen_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        // --- HELPER: Get Correct Stock ---
        function getCurrentStock(item) {
            // Jika ada input stok fisik (Opname), gunakan itu. 
            // Jika belum ada input (undefined), gunakan Stok Awal (Sistem).
            return (opnameResults[item.kode] !== undefined) ? opnameResults[item.kode] : item.stokAwal;
        }

        // --- BACKUP & RESTORE (JSON) ---
        function downloadBackup() {
            const data = { master: masterData, opname: opnameResults };
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const date = new Date().toISOString().slice(0,10);
            a.download = `Backup_Linen_RSCharlie_${date}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function restoreBackup(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const parsed = JSON.parse(e.target.result);
                    if(parsed.master && parsed.opname) {
                        masterData = parsed.master;
                        opnameResults = parsed.opname;
                        saveToLocal();
                        populateCategoryFilter();
                        populateMutasiDropdown();
                        renderOpnameTable();
                        updateOpnameSummary();
                        showToast("Data berhasil direstore!");
                    } else {
                        alert("Format file salah.");
                    }
                } catch (err) {
                    alert("File JSON korup.");
                }
            };
            reader.readAsText(file);
            input.value = ''; 
        }

        // --- UTILS ---
        function formatRupiah(num) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num);
        }

        function showToast(msg) {
            const x = document.getElementById("toast");
            x.innerText = msg; x.className = "show";
            setTimeout(() => x.className = x.className.replace("show", ""), 3000);
        }
    </script>
</body>
</html>
