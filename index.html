<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistem Manajemen Laundry RS Charlie (Enterprise)</title>
    
    <!-- External Assets (CDN) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* --- 1. CSS VARIABLES & RESET --- */
        :root {
            --primary: #0284c7; --primary-dark: #0369a1; --primary-light: #e0f2fe;
            --secondary: #64748b; --secondary-light: #f1f5f9;
            --success: #10b981; --success-bg: #dcfce7; --success-text: #166534;
            --warning: #f59e0b; --warning-bg: #fef3c7; --warning-text: #92400e;
            --danger: #ef4444; --danger-bg: #fee2e2; --danger-text: #991b1b;
            --bg-body: #f1f5f9; --bg-surface: #ffffff; --border: #e2e8f0;
            --text-main: #0f172a; --text-muted: #64748b;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --radius: 12px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); 
            font-size: 14px; line-height: 1.5; height: 100vh; overflow: hidden; 
        }

        /* --- 2. LOGIN SCREEN --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            z-index: 9999; display: flex; justify-content: center; align-items: center;
        }
        .login-card {
            background: white; padding: 40px; border-radius: 16px; width: 100%; max-width: 400px;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); text-align: center;
        }
        .login-logo { font-size: 3rem; color: var(--primary); margin-bottom: 20px; }

        /* --- 3. LAYOUT UTAMA --- */
        .app-layout { display: grid; grid-template-columns: 260px 1fr; height: 100vh; }
        
        /* Sidebar */
        .sidebar { 
            background: var(--bg-surface); border-right: 1px solid var(--border); 
            display: flex; flex-direction: column; height: 100%; z-index: 50;
        }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
        .sidebar-header h2 { font-size: 1.2rem; color: var(--primary-dark); font-weight: 800; }
        .nav-menu { flex: 1; overflow-y: auto; padding: 15px 10px; }
        
        .nav-category { font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); font-weight: 700; margin: 15px 10px 5px; letter-spacing: 0.5px; }
        .nav-item {
            display: flex; align-items: center; gap: 12px; padding: 12px 16px;
            color: var(--text-muted); text-decoration: none; border-radius: 8px;
            margin-bottom: 2px; transition: all 0.2s; cursor: pointer;
        }
        .nav-item:hover { background: var(--secondary-light); color: var(--primary); }
        .nav-item.active { background: var(--primary-light); color: var(--primary-dark); font-weight: 600; }
        .nav-item i { width: 20px; text-align: center; }

        .user-profile { padding: 15px; border-top: 1px solid var(--border); background: var(--secondary-light); display: flex; justify-content: space-between; align-items: center; }
        
        /* Main Content */
        .main-content { overflow-y: auto; height: 100%; padding: 20px; display: flex; flex-direction: column; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        h1.page-title { font-size: 1.5rem; font-weight: 700; color: var(--text-main); }

        /* --- 4. COMPONENTS --- */
        .card { background: var(--bg-surface); border-radius: var(--radius); border: 1px solid var(--border); padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow); }
        .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; }
        .stat-card { display: flex; align-items: center; gap: 15px; }
        .stat-icon { width: 50px; height: 50px; border-radius: 10px; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; }
        .stat-info h3 { font-size: 1.5rem; font-weight: 700; color: var(--text-main); }
        .stat-info p { font-size: 0.85rem; color: var(--text-muted); }

        /* Tables */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { text-align: left; padding: 12px 16px; border-bottom: 2px solid var(--border); color: var(--text-muted); font-size: 0.8rem; font-weight: 600; text-transform: uppercase; background: #f8fafc; }
        td { padding: 12px 16px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        tr:hover { background: #fdfdfd; }

        /* Forms & Buttons */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 0.9rem; }
        input, select, textarea { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-family: inherit; transition: border 0.2s; }
        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
        
        .btn { padding: 10px 16px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
        .btn:hover { filter: brightness(90%); opacity: 0.9; }

        /* Badges */
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; }
        .bg-success-light { background: var(--success-bg); color: var(--success-text); }
        .bg-warning-light { background: var(--warning-bg); color: var(--warning-text); }
        .bg-danger-light { background: var(--danger-bg); color: var(--danger-text); }
        .bg-info-light { background: var(--primary-light); color: var(--primary-dark); }

        /* --- 5. UTILS & MODALS --- */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-between { justify-content: space-between; }
        .items-center { align-items: center; }
        
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 2000; display: none;
            justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000; display: none;
            justify-content: center; align-items: center; backdrop-filter: blur(2px);
        }
        .modal.active { display: flex; }
        .modal-content { background: white; width: 100%; max-width: 500px; border-radius: 12px; padding: 24px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; }

        /* Toast */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 3000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: #333; color: white; padding: 12px 20px; border-radius: 8px; font-size: 0.9rem; animation: slideIn 0.3s; display: flex; align-items: center; gap: 10px; min-width: 250px; }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* --- 6. RESPONSIVE --- */
        @media (max-width: 768px) {
            .app-layout { grid-template-columns: 1fr; }
            .sidebar { position: fixed; left: -260px; width: 260px; transition: 0.3s; }
            .sidebar.active { left: 0; }
            .main-content { padding: 15px; padding-top: 70px; }
            #mobile-header { display: flex; padding: 15px; background: white; border-bottom: 1px solid var(--border); position: fixed; top: 0; width: 100%; z-index: 40; justify-content: space-between; align-items: center; }
        }
        @media (min-width: 769px) { #mobile-header { display: none; } }
    </style>
</head>
<body>

    <!-- LOGIN SCREEN -->
    <section id="login-screen">
        <div class="login-card">
            <div class="login-logo"><i class="fas fa-hospital-alt"></i></div>
            <h2 style="margin-bottom: 5px; color: var(--primary-dark);">Sistem Laundry RS</h2>
            <p style="color: var(--text-muted); margin-bottom: 30px;">RS Charlie Enterprise Edition</p>
            
            <form id="loginForm">
                <div class="form-group" style="text-align: left;">
                    <label>Username</label>
                    <input type="text" id="username" placeholder="admin / supervisor / operator" value="admin">
                </div>
                <div class="form-group" style="text-align: left;">
                    <label>Password</label>
                    <input type="password" id="password" placeholder="admin123" value="admin123">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">MASUK SISTEM</button>
            </form>
            <p style="margin-top: 20px; font-size: 0.8rem; color: var(--text-muted);">V6.0 Enterprise Build</p>
        </div>
    </section>

    <!-- MAIN APP -->
    <div class="app-layout hidden" id="main-app">
        <!-- Mobile Header -->
        <header id="mobile-header">
            <button class="btn btn-outline btn-sm" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
            <h3>RS Charlie Laundry</h3>
            <div class="avatar-small"><i class="fas fa-user-circle"></i></div>
        </header>

        <!-- Sidebar Navigation -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-hospital fa-lg" style="color: var(--primary);"></i>
                <h2>Laundry RS</h2>
            </div>
            
            <div class="nav-menu">
                <div class="nav-category">Utama</div>
                <a class="nav-item active" onclick="App.nav('dashboard')"><i class="fas fa-chart-line"></i> Dashboard</a>
                <a class="nav-item" onclick="App.nav('workflow')"><i class="fas fa-tasks"></i> Workflow Proses</a>
                
                <div class="nav-category">Master Data</div>
                <a class="nav-item" onclick="App.nav('linen')"><i class="fas fa-layer-group"></i> Master Linen</a>
                <a class="nav-item" onclick="App.nav('unit')"><i class="fas fa-procedures"></i> Unit RS</a>
                <a class="nav-item" onclick="App.nav('machine')"><i class="fas fa-cogs"></i> Mesin Laundry</a>
                <a class="nav-item" onclick="App.nav('inventory')"><i class="fas fa-flask"></i> Inventory Bahan</a>
                <a class="nav-item" onclick="App.nav('sdm')"><i class="fas fa-users"></i> Data SDM</a>
                
                <div class="nav-category">Laporan & Keuangan</div>
                <a class="nav-item" onclick="App.nav('finance')"><i class="fas fa-coins"></i> Keuangan</a>
                <a class="nav-item" onclick="App.nav('audit')"><i class="fas fa-shield-alt"></i> Audit Log</a>
            </div>

            <div class="user-profile">
                <div>
                    <div style="font-weight: 700;" id="user-display-name">Admin</div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);" id="user-role-display">Administrator</div>
                </div>
                <button class="btn btn-sm btn-danger" onclick="Auth.logout()"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="main-content">
            <header>
                <h1 class="page-title" id="page-title">Dashboard</h1>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-outline btn-sm" onclick="App.sync()"><i class="fas fa-sync-alt"></i> Sync Cloud</button>
                    <button class="btn btn-primary btn-sm" id="btn-add-action" onclick="App.actionAdd()"><i class="fas fa-plus"></i> Tambah Data</button>
                </div>
            </header>

            <!-- VIEWS CONTAINER -->
            <div id="views">
                <!-- 1. DASHBOARD -->
                <section id="view-dashboard" class="view-section">
                    <div class="grid-4">
                        <div class="card stat-card">
                            <div class="stat-icon bg-success-light"><i class="fas fa-tshirt text-success"></i></div>
                            <div class="stat-info"><h3 id="stat-linen-ok">0</h3><p>Linen Siap Pakai</p></div>
                        </div>
                        <div class="card stat-card">
                            <div class="stat-icon bg-warning-light"><i class="fas fa-clock text-warning"></i></div>
                            <div class="stat-info"><h3 id="stat-process">0</h3><p>Sedang Proses Cuci</p></div>
                        </div>
                        <div class="card stat-card">
                            <div class="stat-icon bg-danger-light"><i class="fas fa-first-aid text-danger"></i></div>
                            <div class="stat-info"><h3 id="stat-infected">0</h3><p>Linen Infeksius</p></div>
                        </div>
                        <div class="card stat-card">
                            <div class="stat-icon bg-info-light"><i class="fas fa-user-nurse text-info"></i></div>
                            <div class="stat-info"><h3 id="stat-staff">0</h3><p>Staff Shift Aktif</p></div>
                        </div>
                    </div>

                    <div class="grid-4" style="grid-template-columns: 2fr 1fr;">
                        <div class="card">
                            <h3><i class="fas fa-chart-bar"></i> Aktivitas Mencuci (7 Hari Terakhir)</h3>
                            <div style="height: 200px; display: flex; align-items: flex-end; justify-content: space-around; padding-top: 20px;">
                                <!-- Simple CSS Bar Chart -->
                                <div class="bar" style="width: 10%; height: 60%; background: var(--primary); border-radius: 4px 4px 0 0;" title="Senin"></div>
                                <div class="bar" style="width: 10%; height: 80%; background: var(--primary); border-radius: 4px 4px 0 0;" title="Selasa"></div>
                                <div class="bar" style="width: 10%; height: 40%; background: var(--primary); border-radius: 4px 4px 0 0;" title="Rabu"></div>
                                <div class="bar" style="width: 10%; height: 90%; background: var(--primary); border-radius: 4px 4px 0 0;" title="Kamis"></div>
                                <div class="bar" style="width: 10%; height: 50%; background: var(--primary); border-radius: 4px 4px 0 0;" title="Jumat"></div>
                                <div class="bar" style="width: 10%; height: 70%; background: var(--primary); border-radius: 4px 4px 0 0;" title="Sabtu"></div>
                                <div class="bar" style="width: 10%; height: 30%; background: var(--primary); border-radius: 4px 4px 0 0;" title="Minggu"></div>
                            </div>
                            <div class="flex-between" style="margin-top: 10px; font-size: 0.8rem; color: var(--text-muted);">
                                <span>Sen</span><span>Sel</span><span>Rab</span><span>Kam</span><span>Jum</span><span>Sab</span><span>Min</span>
                            </div>
                        </div>
                        <div class="card">
                            <h3><i class="fas fa-exclamation-triangle text-warning"></i> Peringatan Stok</h3>
                            <ul id="dashboard-warnings" style="list-style: none; margin-top: 15px; font-size: 0.9rem;">
                                <!-- Populated by JS -->
                            </ul>
                        </div>
                    </div>
                </section>

                <!-- 2. WORKFLOW -->
                <section id="view-workflow" class="view-section hidden">
                    <div class="card">
                        <h3><i class="fas fa-random"></i> Pemindahan Status Linen</h3>
                        <div class="form-group flex-between items-center" style="background: #f8fafc; padding: 15px; border-radius: 8px;">
                            <div>
                                <label>Scan/Input ID Linen</label>
                                <input type="text" id="wf-linen-id" placeholder="Scan Barcode atau ketik ID..." style="width: 300px;">
                            </div>
                            <div>
                                <label>Pindah Status Ke:</label>
                                <select id="wf-target-status" style="width: 200px;">
                                    <option value="sorting">1. Sorting (Kotor Masuk)</option>
                                    <option value="washing">2. Washing (Cuci)</option>
                                    <option value="drying">3. Drying (Pengeringan)</option>
                                    <option value="ironing">4. Ironing (Setrika)</option>
                                    <option value="packing">5. Packing</option>
                                    <option value="ready">6. Ready (Siap Distribusi)</option>
                                    <option value="distributed">7. Distributed (Terkirim)</option>
                                    <option value="damaged">X. Rusak/Afkir</option>
                                </select>
                            </div>
                            <div>
                                <label>Petugas</label>
                                <input type="text" id="wf-operator" value="Operator" readonly style="width: 150px; background: #e2e8f0;">
                            </div>
                            <button class="btn btn-primary" onclick="Workflow.processStep()"><i class="fas fa-arrow-right"></i> Proses</button>
                        </div>
                    </div>

                    <div class="card">
                        <h3>Riwayat Proses Hari Ini</h3>
                        <div class="table-responsive">
                            <table id="table-workflow-log">
                                <thead><tr><th>Waktu</th><th>ID Linen</th><th>Nama Linen</th><th>Status</th><th>Petugas</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- 3. MASTER LINEN -->
                <section id="view-linen" class="view-section hidden">
                    <div class="card">
                        <div class="table-responsive">
                            <table id="table-linen">
                                <thead><tr><th>Kode</th><th>Nama</th><th>Kategori</th><th>Unit Asal</th><th>Status</th><th>Lokasi</th><th>Aksi</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- 4. UNIT RS -->
                <section id="view-unit" class="view-section hidden">
                    <div class="card">
                        <div class="table-responsive">
                            <table id="table-unit">
                                <thead><tr><th>Kode</th><th>Nama Unit</th><th>Jenis</th><th>Kontak</th><th>Jadwal Ambil</th><th>Aksi</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- 5. MESIN -->
                <section id="view-machine" class="view-section hidden">
                    <div class="card">
                        <div class="table-responsive">
                            <table id="table-machine">
                                <thead><tr><th>Kode</th><th>Nama Mesin</th><th>Tipe</th><th>Kap. (Kg)</th><th>Status</th><th>Maintenance</th><th>Aksi</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- 6. INVENTORY -->
                <section id="view-inventory" class="view-section hidden">
                    <div class="card">
                        <div class="table-responsive">
                            <table id="table-inventory">
                                <thead><tr><th>Nama Bahan</th><th>Kategori</th><th>Stok</th><th>Unit</th><th>Min. Stok</th><th>Status</th><th>Aksi</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- 7. SDM -->
                <section id="view-sdm" class="view-section hidden">
                    <div class="card">
                        <div class="table-responsive">
                            <table id="table-sdm">
                                <thead><tr><th>NIP</th><th>Nama</th><th>Role</th><th>Shift</th><th>Status</th><th>Sertifikat</th><th>Aksi</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- 8. FINANCE -->
                <section id="view-finance" class="view-section hidden">
                    <div class="card">
                        <h3>Laporan Biaya Operasional</h3>
                        <div class="form-group flex-between" style="max-width: 400px;">
                            <label>Periode</label>
                            <select id="fin-period" onchange="Finance.render()"><option value="current">Bulan Ini</option><option value="last">Bulan Lalu</option></select>
                        </div>
                        <div class="grid-4" style="margin-bottom: 20px;">
                            <div class="stat-card">
                                <div class="stat-info"><h3 id="fin-electric">Rp 0</h3><p>Listrik</p></div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-info"><h3 id="fin-chemical">Rp 0</h3><p>Bahan Kimia</p></div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-info"><h3 id="fin-labor">Rp 0</h3><p>SDM (Lembur)</p></div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-info"><h3 id="fin-kg-cost">Rp 0</h3><p>Cost / Kg</p></div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table id="table-finance">
                                <thead><tr><th>Tanggal</th><th>Kategori</th><th>Deskripsi</th><th>Jumlah (Rp)</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- 9. AUDIT -->
                <section id="view-audit" class="view-section hidden">
                    <div class="card">
                        <h3><i class="fas fa-history"></i> Log Aktivitas Sistem</h3>
                        <div class="table-responsive">
                            <table id="table-audit">
                                <thead><tr><th>Timestamp</th><th>User</th><th>Role</th><th>Aksi</th><th>Detail</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </section>

            </div>
        </main>
    </div>

    <!-- GENERIC MODAL -->
    <div class="modal" id="generic-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Form Data</h3>
                <button class="btn btn-sm btn-outline" onclick="UI.closeModal()"><i class="fas fa-times"></i></button>
            </div>
            <div id="modal-body">
                <!-- Dynamic Content -->
            </div>
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn btn-outline" onclick="UI.closeModal()">Batal</button>
                <button class="btn btn-primary" id="modal-save-btn">Simpan</button>
            </div>
        </div>
    </div>

    <!-- UTILS: LOADING & TOAST -->
    <div id="loading-overlay"><div class="spinner"></div><p style="margin-top:15px; font-weight:600;">Memproses...</p></div>
    <div id="toast-container"></div>

    <script>
        /**
         * ==========================================
         * CORE SYSTEM CONFIGURATION & STATE
         * ==========================================
         */
        const CONFIG = {
            APP_NAME: "Sistem Laundry RS Charlie V6.0",
            GOOGLE_SCRIPT_URL: "https://script.google.com/macros/s/AKfycbxL3d88GrbIv7iCpJu_IR2JPvV-SNmuUnxNPuwimlJe43XjV43wHnFuNECParQw3sPOFQ/exec", 
            DB_VERSION: 1.0
        };

        // Global State
        const State = {
            currentUser: null,
            data: {
                linen: [],
                units: [],
                machines: [],
                inventory: [],
                sdm: [],
                transactions: [], // For workflow logs & finance
                audit: []
            }
        };

        /**
         * ==========================================
         * MODULE 1: AUTHENTICATION & ROLE
         * ==========================================
         */
        const Auth = {
            users: [
                { user: "admin", pass: "admin123", role: "admin", name: "Administrator" },
                { user: "spv", pass: "spv123", role: "supervisor", name: "Supervisor Laundry" },
                { user: "op", pass: "op123", role: "operator", name: "Operator Cuci" }
            ],

            init: function() {
                const sess = sessionStorage.getItem('rs_laundry_user');
                if (sess) {
                    this.loginSuccess(JSON.parse(sess));
                } else {
                    document.getElementById('login-screen').classList.remove('hidden');
                }
            },

            login: function(u, p) {
                const found = this.users.find(x => x.user === u && x.pass === p);
                if (found) {
                    this.loginSuccess(found);
                } else {
                    UI.showToast("Username atau password salah!", "error");
                }
            },

            loginSuccess: function(userObj) {
                State.currentUser = userObj;
                sessionStorage.setItem('rs_laundry_user', JSON.stringify(userObj));
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                
                // Update UI User Info
                document.getElementById('user-display-name').innerText = userObj.name;
                document.getElementById('user-role-display').innerText = userObj.role.toUpperCase();
                document.getElementById('wf-operator').value = userObj.name;

                // Log & Init Data
                Audit.log("LOGIN", "User login berhasil");
                DataStore.loadLocal();
                App.initDashboard();
            },

            logout: function() {
                Audit.log("LOGOUT", "User keluar sistem");
                sessionStorage.removeItem('rs_laundry_user');
                location.reload();
            }
        };

        /**
         * ==========================================
         * MODULE 2: DATA STORE & SYNC
         * ==========================================
         */
        const DataStore = {
            loadLocal: function() {
                const stored = localStorage.getItem('rs_laundry_db_v6');
                if (stored) {
                    State.data = JSON.parse(stored);
                } else {
                    // SEED DATA (DUMMY DATA FOR DEMO)
                    this.seedData();
                }
            },

            saveLocal: function() {
                localStorage.setItem('rs_laundry_db_v6', JSON.stringify(State.data));
            },

            seedData: function() {
                State.data.units = [
                    { code: 'ICU', name: 'ICU (Intensive Care Unit)', type: 'Infeksius', contact: 'Ibu Siti', schedule: '08:00 & 16:00' },
                    { code: 'INAP', name: 'Rawat Inap Lt. 3', type: 'Non-Infeksius', contact: 'Budi', schedule: '09:00' }
                ];
                State.data.linen = [
                    { id: 'L001', name: 'Sprei Bed 180', category: 'Bed', unit: 'INAP', status: 'ready', location: 'Gudang Linen' },
                    { id: 'L002', name: 'Sarung Bantal', category: 'Bed', unit: 'INAP', status: 'ready', location: 'Gudang Linen' },
                    { id: 'L003', name: 'Baju Pasien (M)', category: 'Pakaian', unit: 'ICU', status: 'dirty', location: 'ICU' }
                ];
                State.data.machines = [
                    { code: 'MW01', name: 'Washer 01', type: 'Washer', cap: 50, status: 'running', maint: 'OK' },
                    { code: 'DR01', name: 'Dryer 01', type: 'Dryer', cap: 50, status: 'idle', maint: 'OK' }
                ];
                State.data.inventory = [
                    { name: 'Deterjen A', cat: 'Chemical', stock: 100, unit: 'Liter', min: 20 },
                    { name: 'Softener', cat: 'Chemical', stock: 15, unit: 'Liter', min: 10 }, // Low stock example
                ];
                State.data.sdm = [
                    { nip: 'E001', name: 'Joko', role: 'Operator', shift: 'Pagi', status: 'Active', cert: 'K3' }
                ];
                this.saveLocal();
            },

            syncToCloud: async function() {
                // Simulasi Sync ke Google Spreadsheet
                UI.showLoading(true);
                await new Promise(r => setTimeout(r, 1500)); // Fake delay
                
                // Di sini kita akan melakukan fetch POST ke Google Apps Script
                /* 
                try {
                    await fetch(CONFIG.GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify(State.data) });
                } catch(e) { ... }
                */
                
                UI.showLoading(false);
                UI.showToast("Sinkronisasi Cloud Berhasil!", "success");
                Audit.log("SYNC", "Data disinkronisasi ke Cloud");
            }
        };

        /**
         * ==========================================
         * MODULE 3: WORKFLOW ENGINE
         * ==========================================
         */
        const Workflow = {
            processStep: function() {
                const linenId = document.getElementById('wf-linen-id').value.trim();
                const targetStatus = document.getElementById('wf-target-status').value;
                const operator = State.currentUser.name;

                if(!linenId) return UI.showToast("Scan/ID Linen wajib diisi!", "error");

                const linenItem = State.data.linen.find(l => l.id === linenId);
                
                if (!linenItem) {
                    // Auto create if new? No, strict for hospital
                    return UI.showToast("Linen ID tidak ditemukan di Master Data!", "error");
                }

                // Update Status
                const oldStatus = linenItem.status;
                linenItem.status = targetStatus;
                linenItem.location = (targetStatus === 'distributed') ? linenItem.unit : 'Laundry';
                
                if(targetStatus === 'ready') linenItem.location = 'Gudang Linen';

                // Log Transaction
                const log = {
                    timestamp: new Date().toLocaleString('id-ID'),
                    id: linenId,
                    name: linenItem.name,
                    status: this.getStatusLabel(targetStatus),
                    operator: operator
                };
                
                State.data.transactions.unshift(log); // Add to top
                DataStore.saveLocal();
                
                // UI Feedback
                UI.renderTable('table-workflow-log', State.data.transactions, ['timestamp', 'id', 'name', 'status', 'operator']);
                document.getElementById('wf-linen-id').value = '';
                document.getElementById('wf-linen-id').focus();
                
                UI.showToast(`Linen ${linenId} dipindah ke ${log.status}`, "success");
                Audit.log("WORKFLOW", `Update status ${linenId} -> ${targetStatus}`);
                App.initDashboard(); // Refresh stats
            },

            getStatusLabel: function(key) {
                const map = {
                    'sorting': '<span class="badge bg-warning-light">Sorting</span>',
                    'washing': '<span class="badge bg-info-light">Washing</span>',
                    'drying': '<span class="badge bg-info-light">Drying</span>',
                    'ironing': '<span class="badge bg-info-light">Ironing</span>',
                    'packing': '<span class="badge bg-info-light">Packing</span>',
                    'ready': '<span class="badge bg-success-light">Ready</span>',
                    'distributed': '<span class="badge bg-secondary">Distributed</span>',
                    'damaged': '<span class="badge bg-danger-light">Rusak</span>'
                };
                return map[key] || key;
            }
        };

        /**
         * ==========================================
         * MODULE 4: FINANCE LOGIC
         * ==========================================
         */
        const Finance = {
            render: function() {
                // Simulasi Kalkulasi Keuangan
                // Di sistem nyata, ini dihitung dari log pemakaian mesin & inventory keluar
                
                const dummyCost = {
                    electric: 4500000,
                    chemical: 1200000,
                    labor: 1500000
                };
                
                document.getElementById('fin-electric').innerText = UI.formatRupiah(dummyCost.electric);
                document.getElementById('fin-chemical').innerText = UI.formatRupiah(dummyCost.chemical);
                document.getElementById('fin-labor').innerText = UI.formatRupiah(dummyCost.labor);
                
                const total = dummyCost.electric + dummyCost.chemical + dummyCost.labor;
                const totalKg = 1200; // Dummy
                
                document.getElementById('fin-kg-cost').innerText = UI.formatRupiah(total / totalKg);

                const transactions = [
                    { date: '2023-10-25', cat: 'Inventory', desc: 'Beli Deterjen 50L', amount: 500000 },
                    { date: '2023-10-24', cat: 'Listrik', desc: 'Token Listrik MW01', amount: 200000 },
                ];
                UI.renderTable('table-finance', transactions, ['date', 'cat', 'desc', 'amount']);
            }
        };

        /**
         * ==========================================
         * MODULE 5: AUDIT LOG
         * ==========================================
         */
        const Audit = {
            log: function(action, details) {
                const entry = {
                    timestamp: new Date().toLocaleString('id-ID'),
                    user: State.currentUser ? State.currentUser.name : 'System',
                    role: State.currentUser ? State.currentUser.role : '-',
                    action: action,
                    details: details
                };
                State.data.audit.unshift(entry);
                // Keep last 100 logs only
                if(State.data.audit.length > 100) State.data.audit.pop();
                DataStore.saveLocal();
            },
            
            renderTable: function() {
                UI.renderTable('table-audit', State.data.audit, ['timestamp', 'user', 'role', 'action', 'details']);
            }
        };

        /**
         * ==========================================
         * APP CONTROLLER & UI UTILS
         * ==========================================
         */
        const App = {
            initDashboard: function() {
                // Kalkulasi Statistik Dashboard
                const totalLinen = State.data.linen.length;
                const readyLinen = State.data.linen.filter(l => l.status === 'ready').length;
                const processLinen = State.data.linen.filter(l => ['washing','drying','ironing'].includes(l.status)).length;
                const infectedLinen = State.data.linen.filter(l => l.status === 'dirty' && State.data.units.find(u=>u.code===l.unit)?.type==='Infeksius').length;
                const staffActive = State.data.sdm.filter(s => s.status === 'Active').length;

                document.getElementById('stat-linen-ok').innerText = readyLinen;
                document.getElementById('stat-process').innerText = processLinen;
                document.getElementById('stat-infected').innerText = infectedLinen;
                document.getElementById('stat-staff').innerText = staffActive;

                // Warnings
                const warnings = document.getElementById('dashboard-warnings');
                warnings.innerHTML = '';
                
                State.data.inventory.forEach(item => {
                    if(item.stock <= item.min) {
                        warnings.innerHTML += `<li style="margin-bottom:5px; color:var(--danger);"><i class="fas fa-exclamation-circle"></i> Stok <b>${item.name}</b> menipis (${item.stock} ${item.unit})</li>`;
                    }
                });
                if(warnings.innerHTML === '') warnings.innerHTML = '<li style="color:var(--success);"><i class="fas fa-check"></i> Sistem normal, tidak ada peringatan.</li>';

                // Refresh Workflow Table
                UI.renderTable('table-workflow-log', State.data.transactions.slice(0, 5), ['timestamp', 'id', 'name', 'status', 'operator']);
            },

            nav: function(viewId) {
                // Hide all sections
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

                // Show target
                document.getElementById('view-' + viewId).classList.remove('hidden');
                
                // Set active nav
                // Find nav item containing onclick with viewId (simple approach)
                const navs = document.querySelectorAll('.nav-item');
                navs.forEach(nav => {
                    if(nav.getAttribute('onclick').includes(viewId)) nav.classList.add('active');
                });

                // Update Header Title
                const titles = {
                    'dashboard': 'Dashboard Monitoring',
                    'workflow': 'Workflow & Proses',
                    'linen': 'Master Data Linen',
                    'unit': 'Master Unit RS',
                    'machine': 'Manajemen Mesin',
                    'inventory': 'Gudang Bahan (Inventory)',
                    'sdm': 'Sumber Daya Manusia (SDM)',
                    'finance': 'Laporan Keuangan',
                    'audit': 'Audit Log & Security'
                };
                document.getElementById('page-title').innerText = titles[viewId];

                // Render specific view data
                if(viewId === 'linen') UI.renderTable('table-linen', State.data.linen, ['id', 'name', 'category', 'unit', 'status', 'location']);
                if(viewId === 'unit') UI.renderTable('table-unit', State.data.units, ['code', 'name', 'type', 'contact', 'schedule']);
                if(viewId === 'machine') UI.renderTable('table-machine', State.data.machines, ['code', 'name', 'type', 'cap', 'status', 'maint']);
                if(viewId === 'inventory') UI.renderTable('table-inventory', State.data.inventory, ['name', 'cat', 'stock', 'unit', 'min']); // Special render for status badge needed?
                if(viewId === 'sdm') UI.renderTable('table-sdm', State.data.sdm, ['nip', 'name', 'role', 'shift', 'status', 'cert']);
                if(viewId === 'finance') Finance.render();
                if(viewId === 'audit') Audit.renderTable();

                // Mobile sidebar handling
                if(window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('active');
            },

            actionAdd: function() {
                // Logic for opening modal based on current view
                // For simplicity in this single-file demo, we'll just alert
                // But let's implement a simple prompt for adding items
                
                const currentView = document.querySelector('.view-section:not(.hidden)').id.replace('view-', '');
                let msg = "";
                if(currentView === 'linen') msg = "Masukkan Nama Linen Baru:";
                if(currentView === 'unit') msg = "Masukkan Nama Unit Baru:";
                if(currentView === 'inventory') msg = "Masukkan Nama Bahan:";
                
                if(msg) {
                    const val = prompt(msg);
                    if(val) {
                        UI.showToast(`Fitur tambah data untuk '${val}' akan membuka Form Modal (Next Version)`, "info");
                        // Implement logic here...
                    }
                } else {
                    UI.showToast("Fitur tambah data tidak tersedia untuk halaman ini.", "warning");
                }
            },

            sync: function() {
                DataStore.syncToCloud();
            }
        };

        const UI = {
            renderTable: function(tableId, data, fields) {
                const tbody = document.querySelector(`#${tableId} tbody`);
                if(!tbody) return;
                tbody.innerHTML = '';
                
                if(data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="${fields.length}" class="text-center text-muted" style="text-align:center; padding:20px;">Tidak ada data</td></tr>`;
                    return;
                }

                data.forEach(row => {
                    const tr = document.createElement('tr');
                    fields.forEach(f => {
                        const td = document.createElement('td');
                        // Formatting based on field name or value
                        if(f === 'stock') {
                            const item = row; // reference
                            if(item.stock <= item.min) td.innerHTML = `<span class="badge bg-danger-light">${row[f]}</span>`;
                            else td.innerHTML = row[f];
                        } else if (f === 'status') {
                            td.innerHTML = Workflow.getStatusLabel(row[f]);
                        } else if (f === 'amount') {
                            td.innerHTML = this.formatRupiah(row[f]);
                        } else {
                            td.innerHTML = row[f] || '-';
                        }
                        tr.appendChild(td);
                    });
                    // Add Action Column (Hardcoded for this demo)
                    const tdAct = document.createElement('td');
                    tdAct.innerHTML = `<button class="btn btn-sm btn-outline" onclick="UI.showToast('Edit clicked', 'info')"><i class="fas fa-edit"></i></button>`;
                    tr.appendChild(tdAct);

                    tbody.appendChild(tr);
                });
            },

            formatRupiah: function(num) {
                return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(num);
            },

            showToast: function(msg, type = 'success') {
                const div = document.createElement('div');
                div.className = `toast ${type}`;
                div.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check' : 'fa-info-circle'}"></i> ${msg}`;
                document.getElementById('toast-container').appendChild(div);
                setTimeout(() => div.remove(), 3000);
            },

            showLoading: function(show) {
                document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
            },

            closeModal: function() {
                document.getElementById('generic-modal').classList.remove('active');
            }
        };

        // Helper for mobile sidebar
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        // --- EVENT LISTENERS ---
        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            Auth.login(u, p);
        });

        // --- INIT ---
        window.onload = function() {
            Auth.init();
        };

    </script>
</body>
</html>
