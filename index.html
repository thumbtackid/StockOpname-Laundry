<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Linen RS Charlie (V4.2 Refined)</title>
    
    <!-- Assets -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --primary: #0284c7; --primary-dark: #0369a1; --primary-light: #e0f2fe;
            --success: #10b981; --success-bg: #dcfce7; --success-text: #166534;
            --warning: #f59e0b; --warning-bg: #fef3c7; --warning-text: #92400e;
            --danger: #ef4444; --danger-bg: #fee2e2; --danger-text: #991b1b;
            --info: #64748b; --info-bg: #f1f5f9; --info-text: #475569;
            --bg-body: #f8fafc; --bg-surface: #ffffff; --border: #e2e8f0;
            --text-main: #0f172a; --text-muted: #64748b;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05); --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); font-size: 14px; line-height: 1.5; -webkit-font-smoothing: antialiased; padding: 20px; }

        /* --- LAYOUT --- */
        .app-container { max-width: 1440px; margin: 0 auto; display: grid; grid-template-columns: 250px 1fr; gap: 24px; min-height: 90vh; }
        
        /* Sidebar */
        .sidebar { background: var(--bg-surface); border-radius: 12px; border: 1px solid var(--border); padding: 20px; height: fit-content; box-shadow: var(--shadow-sm); display: flex; flex-direction: column; gap: 8px; }
        .nav-item { padding: 12px 16px; border-radius: 8px; cursor: pointer; font-weight: 500; color: var(--text-muted); transition: all 0.2s; display: flex; align-items: center; gap: 10px; }
        .nav-item:hover { background: var(--info-bg); color: var(--primary); }
        .nav-item.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(2, 132, 199, 0.2); font-weight: 600; }

        /* Main Content */
        .main-content { display: flex; flex-direction: column; gap: 20px; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        h1 { font-size: 1.5rem; font-weight: 800; color: var(--primary-dark); }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* Cards & Tables */
        .card { background: var(--bg-surface); border-radius: 12px; border: 1px solid var(--border); padding: 24px; box-shadow: var(--shadow-sm); }
        .grid-dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: #fff; padding: 20px; border-radius: 10px; border: 1px solid var(--border); display: flex; flex-direction: column; position: relative; overflow: hidden; }
        .stat-card::after { content:''; position: absolute; right: -10px; bottom: -10px; width: 60px; height: 60px; border-radius: 50%; opacity: 0.1; }
        .stat-card:nth-child(1)::after { background: var(--primary); }
        .stat-card:nth-child(2)::after { background: var(--danger); }
        .stat-card:nth-child(3)::after { background: var(--success); }
        .stat-val { font-size: 1.8rem; font-weight: 800; color: var(--text-main); margin-top: 5px; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border); vertical-align: middle; }
        th { background: var(--info-bg); font-weight: 700; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; }
        tr:hover { background: #f8fafc; }

        /* Forms & Inputs */
        .form-group { margin-bottom: 16px; }
        label { display: block; font-weight: 600; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-family: inherit; transition: border 0.2s; background: #fff; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
        
        /* Buttons */
        .btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
        .btn:hover { filter: brightness(90%); transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }

        /* Utilities */
        .hidden { display: none !important; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .font-bold { font-weight: 700; }
        .text-success { color: var(--success); } .text-danger { color: var(--danger); } .text-warning { color: var(--warning); } .text-primary { color: var(--primary); }
        
        /* Toast */
        #toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { min-width: 300px; padding: 16px; background: white; border-left: 4px solid var(--primary); box-shadow: var(--shadow-md); border-radius: 4px; animation: slideIn 0.3s; display: flex; justify-content: space-between; align-items: center; pointer-events: auto; }
        .toast.error { border-left-color: var(--danger); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15,23,42,0.6); z-index: 1000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-overlay.open { display: flex; }
        .modal-content { background: white; width: 100%; max-width: 550px; border-radius: 12px; padding: 24px; box-shadow: var(--shadow-lg); max-height: 90vh; overflow-y: auto; }
        
        /* Loading Overlay */
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 2000; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Custom Helpers */
        .helper-text { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; display: block; }
        .composition-tag { display: inline-block; background: var(--info-bg); padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; margin-right: 4px; margin-bottom: 4px; }
        
        @media (max-width: 768px) {
            .app-container { grid-template-columns: 1fr; }
            .sidebar { flex-direction: row; overflow-x: auto; padding: 10px; }
            .nav-item { white-space: nowrap; }
        }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="spinner"></div>
        <h3 style="color:var(--primary); font-weight:600;">Sistem Linen RS Charlie</h3>
        <p class="text-muted" style="font-size:0.9rem;">Menyinkronkan data keamanan...</p>
    </div>

    <div class="app-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div style="padding-bottom: 15px; border-bottom: 1px solid var(--border); margin-bottom: 10px; padding-left: 12px;">
                <div style="display:flex; align-items:center; gap:8px; color: var(--primary-dark);">
                    <i class="fas fa-hospital fa-lg"></i>
                    <h3 style="line-height:1;">Sistem Linen</h3>
                </div>
                <small style="color: var(--text-muted); font-weight:500;">V4.2 Refined Hybrid</small>
            </div>
            <div class="nav-item active" onclick="App.switchView('dashboard')">
                <i class="fas fa-chart-pie" style="width:20px;"></i> Dashboard
            </div>
            <div class="nav-item" onclick="App.switchView('master')">
                <i class="fas fa-layer-group" style="width:20px;"></i> Master Data
            </div>
            <div class="nav-item" onclick="App.switchView('opname')">
                <i class="fas fa-clipboard-list" style="width:20px;"></i> Stock Opname
            </div>
            <div class="nav-item" onclick="App.switchView('analisa')">
                <i class="fas fa-brain" style="width:20px;"></i> Analisa Cerdas
            </div>
            <div class="nav-item" onclick="App.switchView('config')">
                <i class="fas fa-sliders-h" style="width:20px;"></i> Konfigurasi RS
            </div>
            <div class="nav-item" onclick="App.switchView('audit')">
                <i class="fas fa-shield-alt" style="width:20px;"></i> Audit Log
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <header>
                <div>
                    <h1 id="pageTitle">Dashboard</h1>
                    <p id="currentDate" class="text-muted" style="font-size: 0.9rem;"></p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-outline" onclick="App.backupData()"><i class="fas fa-download"></i> Backup</button>
                    <button class="btn btn-success" onclick="CloudManager.syncToCloud()"><i class="fas fa-cloud-upload-alt"></i> Sync Cloud</button>
                </div>
            </header>

            <!-- VIEW: DASHBOARD -->
            <section id="view-dashboard" class="view-section">
                <div class="grid-dashboard">
                    <div class="stat-card">
                        <label>Total Item Linen</label>
                        <div class="stat-val" id="dash-total-items">0</div>
                    </div>
                    <div class="stat-card">
                        <label>Item Rusak/Afkir</label>
                        <div class="stat-val text-danger" id="dash-damaged-items">0</div>
                        <small class="text-muted helper-text">Perlu penggantian</small>
                    </div>
                    <div class="stat-card">
                        <label>Ketersediaan Set</label>
                        <div class="stat-val text-success" id="dash-sets-ready">0</div>
                        <small class="text-muted helper-text">Siap dipakai</small>
                    </div>
                    <div class="stat-card">
                        <label>Estimasi Biaya Ganti</label>
                        <div class="stat-val text-warning" id="dash-replacement-cost" style="font-size:1.4rem;">Rp 0</div>
                    </div>
                </div>
                
                <div class="card">
                    <h3 style="margin-bottom:15px;"><i class="fas fa-bell text-warning"></i> Status Pemantauan</h3>
                    <div id="dashboard-warnings"></div>
                </div>
            </section>

            <!-- VIEW: MASTER LINEN -->
            <section id="view-master" class="view-section hidden">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items:center; margin-bottom: 20px;">
                        <div style="display:flex; gap:10px; flex:1;">
                            <input type="text" id="masterSearch" placeholder="Cari kode atau nama linen..." style="max-width:300px;" oninput="AppUI.renderMasterTable()">
                        </div>
                        <button class="btn btn-primary" onclick="AppUI.openModal('add')"><i class="fas fa-plus"></i> Tambah Baru</button>
                    </div>
                    <div style="overflow-x:auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Kode</th><th>Nama Item</th><th>Kategori</th><th>Tipe</th>
                                    <th title="Stok fisik baik">Stok Baik</th>
                                    <th title="Stok rusak/afkir">Rusak</th>
                                    <th title="Jumlah set yang bisa disusun (otomatis)">Stok Set</th>
                                    <th>Harga Satuan</th><th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="masterTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- VIEW: STOCK OPNAME -->
            <section id="view-opname" class="view-section hidden">
                <div class="card">
                    <div class="alert-box" style="background: var(--info-bg); border: 1px solid var(--border); padding: 15px; border-radius: 8px; margin-bottom: 20px; color: var(--text-main);">
                        <strong><i class="fas fa-info-circle"></i> Petunjuk:</strong> Masukkan jumlah item yang <b>Rusak</b> atau <b>Hilang</b>. Sisa stok baik akan otomatis dihitung.
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items:center; margin-bottom: 20px;">
                        <input type="text" id="opnameSearch" placeholder="Filter item opname..." style="width: 300px;" oninput="AppUI.renderOpnameTable()">
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-outline" onclick="AppUI.resetOpname()"><i class="fas fa-undo"></i> Reset</button>
                            <button class="btn btn-success" onclick="AppUI.finalizeOpname()"><i class="fas fa-save"></i> Finalisasi Data</button>
                        </div>
                    </div>
                    <div style="overflow-x:auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Kode</th><th>Nama Item</th>
                                    <th>Stok Baik (Sistem)</th>
                                    <th>Input Rusak/Hilang</th>
                                    <th>Sisa Baik (Hasil)</th>
                                    <th>Catatan</th>
                                </tr>
                            </thead>
                            <tbody id="opnameTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- VIEW: ANALISA -->
            <section id="view-analisa" class="view-section hidden">
                <div class="card">
                    <h3>Parameter Perhitungan</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; background: #f8fafc; padding: 20px; border-radius: 8px; border:1px solid var(--border);">
                        <div>
                            <label>Faktor Kehilangan (%)</label>
                            <input type="number" id="param-loss-factor" value="5" min="0" max="100">
                        </div>
                        <div>
                            <label>Umur Pakai (Bulan)</label>
                            <input type="number" id="param-linen-age" value="24" readonly class="text-muted" title="Saat ini hardcoded, akan update di versi next">
                        </div>
                        <div style="display: flex; align-items: flex-end;">
                            <button class="btn btn-primary" onclick="App.runAnalysis()" style="width:100%; justify-content:center;"><i class="fas fa-calculator"></i> Mulai Analisa</button>
                        </div>
                    </div>
                    <div style="overflow-x:auto;">
                        <table id="analysisTable">
                            <thead>
                                <tr>
                                    <th>Status</th><th>Kode</th><th>Nama Item</th><th>Stok Saat Ini</th><th>Kebutuhan Ideal</th><th>Selisih (Defisit/Surplus)</th><th>Rekomendasi</th>
                                </tr>
                            </thead>
                            <tbody id="analysisBody"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- VIEW: CONFIG -->
            <section id="view-config" class="view-section hidden">
                <div class="card">
                    <h3>Konfigurasi Fasilitas RS</h3>
                    <p class="text-muted helper-text" style="margin-bottom:20px;">Data ini digunakan untuk menghitung analisa kebutuhan linen secara otomatis.</p>
                    <div style="max-width: 500px; margin-top: 20px;">
                        <div class="form-group">
                            <label>Jumlah Bed Rawat Inap (Aktif)</label>
                            <input type="number" id="cfg-beds" min="1">
                        </div>
                        <div class="form-group">
                            <label>BOR (Bed Occupancy Rate) %</label>
                            <input type="number" id="cfg-bor" min="0" max="100">
                        </div>
                        <div class="form-group">
                            <label>Rata-rata Operasi / Hari</label>
                            <input type="number" id="cfg-ops" min="0">
                        </div>
                        <div class="form-group">
                            <label>Buffer Laundry (Siklus Cuci)</label>
                            <input type="number" id="cfg-buffer" min="1">
                            <small class="helper-text">Contoh: 3 artinya butuh 3 set cadangan selama 1 set dicuci.</small>
                        </div>
                        <button class="btn btn-primary" onclick="App.saveConfig()"><i class="fas fa-save"></i> Simpan Konfigurasi</button>
                    </div>
                </div>
            </section>

            <!-- VIEW: AUDIT -->
            <section id="view-audit" class="view-section hidden">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>Riwayat Keamanan Data</h3>
                        <small class="text-muted">Log ini tidak dapat diedit manual</small>
                    </div>
                    <div style="max-height: 600px; overflow-y: auto;">
                        <table style="font-size: 0.85rem;">
                            <thead>
                                <tr><th style="position:sticky; top:0; background:#f1f5f9;">Waktu (WIB)</th><th style="position:sticky; top:0; background:#f1f5f9;">Aksi</th><th style="position:sticky; top:0; background:#f1f5f9;">Detail</th><th style="position:sticky; top:0; background:#f1f5f9;">User</th></tr>
                            </thead>
                            <tbody id="auditTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- MODAL FORM -->
    <div id="itemModal" class="modal-overlay">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px; color:var(--primary-dark);" id="modalTitle">Tambah Linen</h2>
            <form id="linenForm" onsubmit="AppUI.saveItem(event)">
                <input type="hidden" id="inp-code">
                
                <div class="form-group">
                    <label>Tipe Data</label>
                    <select id="inp-type" onchange="AppUI.toggleSetInput(this.value)">
                        <option value="item">Item Satuan (Contoh: Sprei)</option>
                        <option value="set">Set / Paket (Contoh: Set Bed Pasien)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Nama Item / Nama Set</label>
                    <input type="text" id="inp-name" required placeholder="Nama barang...">
                </div>

                <div class="form-group">
                    <label>Kategori</label>
                    <input type="text" id="inp-category" list="listCategory" required placeholder="Contoh: Bed, Operasi, Bayi">
                    <datalist id="listCategory"></datalist>
                </div>

                <div class="form-group">
                    <label>Harga Satuan (Rp)</label>
                    <input type="number" id="inp-price" min="0" placeholder="0 jika tidak ada harga">
                </div>
                
                <!-- LOGIC AREA: SET -->
                <div id="set-logic-area" class="hidden" style="background: var(--info-bg); padding: 15px; border-radius: 8px; margin-bottom: 15px; border:1px dashed var(--primary);">
                    <label style="color:var(--primary-dark);">Komposisi Set</label>
                    <textarea id="inp-composition" rows="3" placeholder="Contoh: Sprei 180, Sarung Bantal, Selimut Tipis" style="font-family:monospace;"></textarea>
                    <small class="helper-text">
                        <i class="fas fa-info-circle"></i> Pisahkan item dengan tanda koma (,). Item harus sudah ada di Master Linen.
                    </small>
                    <div id="composition-preview" style="margin-top:10px; font-size:0.85rem;"></div>
                </div>

                <!-- LOGIC AREA: ITEM -->
                <div id="item-logic-area">
                    <div class="form-group">
                        <label>Stok Awal (Baik)</label>
                        <input type="number" id="inp-stock" min="0">
                    </div>
                    <div class="form-group">
                        <label>Rasio Rotasi (Per Bed/Per Hari)</label>
                        <input type="number" id="inp-rotation" value="1.0" step="0.5" min="0.1">
                        <small class="helper-text">Berapa kali item ini diganti dalam sehari?</small>
                    </div>
                </div>

                <div style="text-align: right; margin-top: 25px; border-top: 1px solid var(--border); padding-top:15px;">
                    <button type="button" class="btn btn-outline" onclick="AppUI.closeModal()">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan Data</button>
                </div>
            </form>
        </div>
    </div>

    <!-- TOAST CONTAINER -->
    <div id="toast-container"></div>

    <script>
        /**
         * ==========================================
         * CONFIGURATION & CONSTANTS
         * ==========================================
         */
        // PENTING: Ganti URL ini dengan URL Web App Google Script Anda (Deploy sebagai Web App)
        const BASE_URL = `https://script.google.com/macros/s/AKfycbxLpyDCnfLXWXggQIiMYzOPiJxX6iHPPyQ1YAud0fKfIjmAuM8gvku_FuihRIMtDzUduw/exec`;
        
        // Default Data jika LocalStorage kosong
        const defaults = {
            items: [
                { code: 'LIN-SPR-001', name: 'Sprei 180', type: 'item', category: 'Bed', stock: 50, damaged: 0, price: 85000, rotation: 1.0, composition: '' },
                { code: 'LIN-SB-001', name: 'Sarung Bantal', type: 'item', category: 'Bed', stock: 60, damaged: 2, price: 25000, rotation: 1.0, composition: '' },
                { code: 'SET-BED-001', name: 'Set Bed Pasien', type: 'set', category: 'Bed', stock: 0, damaged: 0, price: 0, rotation: 0, composition: 'Sprei 180, Sarung Bantal' }
            ],
            config: { beds: 100, bor: 70, ops: 10, buffer: 3 }
        };

        // Main App State
        let appData = {
            items: [],
            config: {},
            audit: []
        };

        /**
         * ==========================================
         * MODULE: CLOUD MANAGER (SYNC LOGIC)
         * ==========================================
         */
        const CloudManager = {
            isLoading: false,

            // Load Strategy: Try Cloud -> Fallback to Local -> Init Defaults
            loadFromCloud: function() {
                this.showLoading(true);
                const callbackName = 'cb_' + Math.floor(Math.random() * 1000000);
                const url = `${BASE_URL}?callback=${callbackName}&action=get`;
                const script = document.createElement('script');
                script.src = url;
                script.onerror = () => {
                    console.warn("Cloud connection failed. Using LocalStorage.");
                    this.finishLoading(false); 
                };
                document.body.appendChild(script);

                window[callbackName] = (response) => {
                    document.body.removeChild(script);
                    delete window[callbackName];
                    try {
                        if (response && response.status === 'success') {
                            appData.items = response.data.items || [];
                            appData.config = response.data.config || defaults.config;
                            appData.audit = response.data.audit || [];
                            this.saveToLocal(); // Update cache
                            this.finishLoading(true, "Data dimuat dari Cloud");
                        } else {
                            throw new Error("Invalid format");
                        }
                    } catch (e) {
                        console.error("Cloud parsing error", e);
                        this.finishLoading(false);
                    }
                };
            },

            finishLoading: function(isCloudSuccess, msg) {
                this.showLoading(false);
                if (!isCloudSuccess) {
                    this.loadFromLocal();
                    AppUI.showToast("Mode Offline: Data diambil dari LocalStorage.", "warning");
                } else {
                    AppUI.showToast("✅ " + (msg || "Sinkronisasi Berhasil"), "success");
                }
                AppUI.init();
            },

            syncToCloud: function() {
                if(!confirm("Kirim data lokal ke Spreadsheet Google? Pastikan koneksi internet stabil.")) return;
                
                this.showLoading(true);
                const payload = {
                    action: "update",
                    data: {
                        items: appData.items,
                        config: appData.config,
                        audit: appData.audit
                    }
                };

                // Gunakan fetch 'no-cors' untuk simpelnya JSONP tidak perlu di handle kompleks di GAS
                fetch(BASE_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                .then(() => {
                    this.showLoading(false);
                    AppUI.showToast("✅ Data berhasil dikirim ke Server!", "success");
                })
                .catch(err => {
                    this.showLoading(false);
                    AppUI.showToast("❌ Gagal sinkronisasi. Data tersimpan di Local.", "error");
                    console.error(err);
                });
            },

            loadFromLocal: function() {
                const stored = localStorage.getItem('linen_hybrid_v4_2');
                if (stored) {
                    const parsed = JSON.parse(stored);
                    // Simple migration check
                    appData = parsed.items ? parsed : { items: [], config: {}, audit: [] };
                } else {
                    appData = { 
                        items: JSON.parse(JSON.stringify(defaults.items)), 
                        config: JSON.parse(JSON.stringify(defaults.config)), 
                        audit: [] 
                    };
                }
            },

            saveToLocal: function() {
                localStorage.setItem('linen_hybrid_v4_2', JSON.stringify(appData));
            },

            showLoading: function(show) {
                const el = document.getElementById('loadingOverlay');
                el.style.display = show ? 'flex' : 'none';
            }
        };

        /**
         * ==========================================
         * MODULE: DATA STORE & BUSINESS LOGIC
         * ==========================================
         */
        const DataStore = {
            saveData: function() {
                CloudManager.saveToLocal();
            },

            addItem: function(newItem) {
                // Normalisasi input
                newItem.name = newItem.name.trim();
                newItem.category = newItem.category.trim();

                // Validasi Nama Duplikat (abaikan diri sendiri saat edit)
                const dup = appData.items.find(i => 
                    i.name.toLowerCase() === newItem.name.toLowerCase() && 
                    i.code !== newItem.code
                );
                if (dup) throw new Error(`Nama "${newItem.name}" sudah terdaftar! Gunakan nama unik.`);

                // Jika Edit
                if (newItem.code) {
                    const idx = appData.items.findIndex(i => i.code === newItem.code);
                    if(idx !== -1) {
                        // Pertahankan stok fisik, hanya update atribut master
                        newItem.stock = appData.items[idx].stock;
                        newItem.damaged = appData.items[idx].damaged;
                        appData.items[idx] = newItem;
                        AuditLog.add('EDIT', `Update Master: ${newItem.code} (${newItem.name})`);
                    }
                } 
                // Jika Add Baru
                else {
                    newItem.code = this.generateCode(newItem.category, newItem.type);
                    if (newItem.type === 'item') newItem.stock = newItem.stock || 0;
                    newItem.damaged = 0;
                    appData.items.push(newItem);
                    AuditLog.add('CREATE', `Tambah Master: ${newItem.code} (${newItem.name})`);
                }
                this.saveData();
            },

            deleteItem: function(code) {
                // Cek apakah item ini dipakai di Set lain
                const usedInSet = appData.items.find(i => 
                    i.type === 'set' && 
                    i.composition.toLowerCase().includes(code.toLowerCase())
                );
                
                if(usedInSet) {
                    throw new Error(`Gagal! Item ini adalah komponen dari Set: "${usedInSet.name}". Hapus/Hapus Set tersebut terlebih dahulu.`);
                }

                appData.items = appData.items.filter(i => i.code !== code);
                AuditLog.add('DELETE', `Hapus Master: ${code}`);
                this.saveData();
            },

            processOpname: function(opnameData) {
                let changedCount = 0;
                let logs = [];
                
                for (const code in opnameData) {
                    const input = opnameData[code];
                    const item = appData.items.find(i => i.code === code);
                    
                    if (item && input.damaged > 0) {
                        if (input.damaged > item.stock) throw new Error(`Stok tidak cukup untuk ${item.name}. Maksimal rusak: ${item.stock}`);
                        
                        item.stock -= input.damaged;
                        item.damaged = (item.damaged || 0) + input.damaged;
                        changedCount++;
                        logs.push(`${item.name}: -${input.damaged}`);
                    }
                }
                
                if (changedCount > 0) {
                    AuditLog.add('OPNAME', `Proses Opname: ${changedCount} item berubah. (${logs.join(', ')})`);
                }
                this.saveData();
                return changedCount;
            },

            // Cek validitas komposisi set (apakah itemnya ada?)
            validateComposition: function(text) {
                const errors = [];
                const foundItems = [];
                if (!text) return { errors, foundItems };
                
                const parts = text.split(',').map(s => s.trim()).filter(s => s);
                parts.forEach(part => {
                    // Cari item yang namanya mengandung string tersebut (fuzzy match sederhana)
                    const component = appData.items.find(i => 
                        i.type === 'item' && 
                        part.toLowerCase() === i.name.toLowerCase()
                    );
                    
                    if (component) {
                        foundItems.push(component.name);
                    } else {
                        errors.push(`Item "${part}" tidak ditemukan di Master Data.`);
                    }
                });
                return { errors, foundItems };
            },

            generateCode: function(cat, type) {
                const prefix = type === 'set' ? 'SET' : 'LIN';
                // Filter item by prefix
                const items = appData.items.filter(i => i.code.startsWith(prefix));
                let max = 0;
                items.forEach(i => {
                    const num = parseInt(i.code.split('-').pop());
                    if (!isNaN(num) && num > max) max = num;
                });
                return `${prefix}-${cat.substring(0,3).toUpperCase()}-${String(max + 1).padStart(3, '0')}`;
            }
        };

        /**
         * ==========================================
         * MODULE: AUDIT LOG
         * ==========================================
         */
        const AuditLog = {
            add: function(action, details) {
                const newLog = {
                    timestamp: new Date().toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' }),
                    action: action,
                    details: details,
                    user: 'Admin' // Hardcoded untuk simpel, bisa diganti session user nanti
                };
                // Tambahkan ke awal array (unshift)
                appData.audit.unshift(newLog);
                // Batasi logs 500 terakhir agar storage tidak penuh
                if (appData.audit.length > 500) appData.audit.pop();
                CloudManager.saveToLocal();
            }
        };

        /**
         * ==========================================
         * MODULE: LINEN LOGIC (CALCULATIONS)
         * ==========================================
         */
        const LinenLogic = {
            // Hitung berapa set yang bisa dibentuk dari stok item
            calculateSetStock: function(setItem) {
                if (!setItem.composition) return 0;
                const parts = setItem.composition.split(',').map(s => s.trim()).filter(s => s);
                let minStock = Infinity;
                
                parts.forEach(part => {
                    const component = appData.items.find(i => 
                        i.type === 'item' && 
                        i.name.toLowerCase() === part.toLowerCase()
                    );
                    if (component) {
                        const avail = Math.floor(component.stock / 1); // Asumsi 1 butuh per set
                        if (avail < minStock) minStock = avail;
                    } else {
                        // Jika komponen tidak ditemukan di master, anggap set tidak bisa dibuat (0)
                        minStock = 0;
                    }
                });
                return minStock === Infinity ? 0 : minStock;
            },

            runAnalysis: function(lossFactor) {
                const results = [];
                const activeBeds = Math.ceil(appData.config.beds * (appData.config.bor / 100));
                const buffer = appData.config.buffer;

                // 1. Analisa ITEM SATUAN
                appData.items.forEach(item => {
                    if (item.type === 'set') return; // Set dianalisa terpisah

                    // Kebutuhan = (Bed Aktif * Rotasi) * Buffer * (1 + Loss%)
                    const neededPerCycle = activeBeds * (item.rotation || 1);
                    const totalNeeded = Math.ceil(neededPerCycle * buffer * (1 + (lossFactor/100)));
                    const diff = item.stock - totalNeeded;
                    
                    let status = 'AMAN';
                    let colorClass = 'success';
                    if (diff < 0) {
                        status = diff < -(totalNeeded * 0.2) ? 'KRITIS' : 'DEFISIT';
                        colorClass = status === 'KRITIS' ? 'danger' : 'warning';
                    } else if (diff > totalNeeded) {
                        status = 'SURPLUS';
                        colorClass = 'info';
                    }

                    results.push({ 
                        code: item.code, name: item.name, stock: item.stock, 
                        needed: totalNeeded, diff: diff, status: status, color: colorClass, isSet: false
                    });
                });

                // 2. Analisa SET (Berdasarkan Operasi/Hari atau Bed)
                appData.items.filter(i => i.type === 'set').forEach(set => {
                    const setStock = this.calculateSetStock(set);
                    // Kebutuhan Set diasumsikan berdasarkan konfigurasi OPS (Operasi) atau Bed default
                    // Di sini kita gunakan config.ops sebagai kebutuhan harian untuk set
                    const setNeeded = appData.config.ops * buffer; 
                    const diff = setStock - setNeeded;
                    
                    let status = 'AMAN';
                    let colorClass = 'success';
                    if (diff < 0) {
                        status = 'KRITIS';
                        colorClass = 'danger';
                    }

                    results.push({ 
                        code: set.code, name: set.name + ' (SET)', stock: setStock, 
                        needed: setNeeded, diff: diff, status: status, color: colorClass, isSet: true
                    });
                });

                return results;
            }
        };

        /**
         * ==========================================
         * MODULE: APP UI CONTROLLER
         * ==========================================
         */
        const AppUI = {
            currentEditCode: null,
            tempOpnameData: {},

            init: function() {
                // Set tanggal header
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                document.getElementById('currentDate').innerText = new Date().toLocaleDateString('id-ID', options);
                
                this.populateCategoryDatalist();
                this.renderDashboard();
            },

            switchView: function(viewId) {
                // Hide all sections
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                // Show target
                document.getElementById('view-' + viewId).classList.remove('hidden');
                // Update Nav
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                
                // Trick to get clicked element if triggered by onclick, else find by id logic
                const targetNav = Array.from(document.querySelectorAll('.nav-item')).find(el => el.getAttribute('onclick').includes(viewId));
                if(targetNav) targetNav.classList.add('active');
                
                // Set Title
                const titles = { 
                    'dashboard': 'Dashboard Monitoring', 
                    'master': 'Master Data Linen', 
                    'opname': 'Stock Opname Harian', 
                    'analisa': 'Analisa Kebutuhan Cerdas', 
                    'config': 'Konfigurasi RS', 
                    'audit': 'Audit Log Sistem' 
                };
                document.getElementById('pageTitle').innerText = titles[viewId];

                // Trigger refresh functions
                if(viewId === 'dashboard') this.renderDashboard();
                if(viewId === 'master') this.renderMasterTable();
                if(viewId === 'opname') { this.tempOpnameData = {}; this.renderOpnameTable(); }
                if(viewId === 'audit') this.renderAuditTable();
                if(viewId === 'config') this.loadConfigForm();
            },

            /* --- DASHBOARD RENDERER --- */
            renderDashboard: function() {
                let totalDamaged = 0, replacementCost = 0, setsReady = 0, warnings = [];
                
                appData.items.forEach(item => {
                    totalDamaged += (item.damaged || 0);
                    replacementCost += ((item.damaged || 0) * item.price);
                    
                    if (item.type === 'set') {
                        const stock = LinenLogic.calculateSetStock(item);
                        if (stock < 5) warnings.push(`<div class="badge" style="background:var(--danger-bg); color:var(--danger-text); display:inline-block; margin-right:5px;">KRITIS</div> <b>${item.name}</b> sisa ${stock} set.`);
                        else if (stock < 15) warnings.push(`<div class="badge" style="background:var(--warning-bg); color:var(--warning-text); display:inline-block; margin-right:5px;">WARNING</div> <b>${item.name}</b> sisa ${stock} set.`);
                        
                        setsReady += stock;
                    }
                });

                document.getElementById('dash-total-items').innerText = appData.items.length;
                document.getElementById('dash-damaged-items').innerText = totalDamaged;
                document.getElementById('dash-sets-ready').innerText = setsReady;
                document.getElementById('dash-replacement-cost').innerText = this.formatRupiah(replacementCost);
                
                const warnContainer = document.getElementById('dashboard-warnings');
                if (warnings.length) {
                    warnContainer.innerHTML = warnings.map(w => `<div style="margin-bottom:8px; font-size:0.9rem;">${w}</div>`).join('');
                } else {
                    warnContainer.innerHTML = '<div class="text-success" style="font-weight:600;"><i class="fas fa-check-circle"></i> Semua stok dalam kondisi aman.</div>';
                }
            },

            /* --- MASTER TABLE RENDERER --- */
            renderMasterTable: function() {
                const search = document.getElementById('masterSearch').value.toLowerCase();
                const tbody = document.getElementById('masterTableBody');
                tbody.innerHTML = '';

                appData.items.forEach(item => {
                    if (!item.name.toLowerCase().includes(search) && !item.code.toLowerCase().includes(search)) return;
                    
                    const setStock = item.type === 'set' ? LinenLogic.calculateSetStock(item) : '-';
                    const typeBadge = item.type === 'set' 
                        ? `<span class="badge" style="background:var(--warning-bg); color:var(--warning-text)">SET</span>`
                        : `<span class="badge" style="background:var(--info-bg); color:var(--info-text)">ITEM</span>`;

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><span style="font-family:monospace; font-weight:700;">${item.code}</span></td>
                        <td><b>${item.name}</b></td>
                        <td>${item.category}</td>
                        <td>${typeBadge}</td>
                        <td class="font-bold text-primary">${item.stock}</td>
                        <td class="text-danger">${item.damaged || 0}</td>
                        <td class="font-bold ${item.type==='set' ? 'text-success' : 'text-muted'}">${setStock}</td>
                        <td>${this.formatRupiah(item.price)}</td>
                        <td>
                            <button class="btn btn-sm btn-outline" style="padding:4px 8px; font-size:0.8rem;" onclick="AppUI.openModal('edit', '${item.code}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger" style="padding:4px 8px; font-size:0.8rem;" onclick="AppUI.deleteItem('${item.code}')"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            },

            /* --- OPNAME RENDERER --- */
            renderOpnameTable: function() {
                const search = document.getElementById('opnameSearch').value.toLowerCase();
                const tbody = document.getElementById('opnameTableBody');
                tbody.innerHTML = '';
                
                appData.items.forEach(item => {
                    if (item.type === 'set') return; // Opname item fisik saja, set terhitung otomatis
                    if (!item.name.toLowerCase().includes(search) && !item.code.toLowerCase().includes(search)) return;
                    
                    const temp = this.tempOpnameData[item.code] || { damaged: 0, note: '' };
                    const sisaBaik = Math.max(0, item.stock - temp.damaged); // Cegah minus visual

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><span style="font-family:monospace;">${item.code}</span></td>
                        <td>${item.name}</td>
                        <td class="font-bold">${item.stock}</td>
                        <td>
                            <input type="number" min="0" style="width:100px;" 
                                value="${temp.damaged}" 
                                onchange="AppUI.updateOpnameInput('${item.code}', 'damaged', this.value)"
                                onkeyup="AppUI.updateOpnameInput('${item.code}', 'damaged', this.value)">
                        </td>
                        <td class="font-bold text-primary" id="res-${item.code}">${sisaBaik}</td>
                        <td>
                            <input type="text" placeholder="Keterangan..." style="border:none; background:transparent;" 
                                value="${temp.note}" 
                                onblur="AppUI.updateOpnameInput('${item.code}', 'note', this.value)">
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            },

            updateOpnameInput: function(code, field, val) {
                if (!this.tempOpnameData[code]) this.tempOpnameData[code] = { damaged: 0, note: '' };
                
                if (field === 'damaged') {
                    let numVal = parseInt(val) || 0;
                    if(numVal < 0) numVal = 0;
                    this.tempOpnameData[code][field] = numVal;
                    
                    // Live Update Sisa
                    const item = appData.items.find(i => i.code === code);
                    if(item) {
                        const sisa = Math.max(0, item.stock - numVal);
                        const el = document.getElementById(`res-${code}`);
                        if(el) {
                            el.innerText = sisa;
                            el.className = numVal > item.stock ? "text-danger font-bold" : "font-bold text-primary";
                        }
                    }
                } else {
                    this.tempOpnameData[code][field] = val;
                }
            },

            resetOpname: function() {
                if(confirm('Reset semua input opname?')) { 
                    this.tempOpnameData = {}; 
                    this.renderOpnameTable(); 
                }
            },

            finalizeOpname: function() {
                try {
                    const count = DataStore.processOpname(this.tempOpnameData);
                    if(count === 0) {
                        AppUI.showToast("Tidak ada perubahan stok yang disimpan.", "info");
                    } else {
                        AppUI.showToast(`✅ Opname Selesai. ${count} item diperbarui.`, "success");
                    }
                    this.tempOpnameData = {};
                    this.renderOpnameTable();
                    this.renderDashboard();
                } catch (e) { 
                    AppUI.showToast(e.message, "error"); 
                }
            },

            /* --- ANALISA RENDERER --- */
            renderAnalysisResults: function(results) {
                const tbody = document.getElementById('analysisBody');
                tbody.innerHTML = '';
                
                results.forEach(r => {
                    const badgeColor = r.color === 'danger' ? 'var(--danger-bg)' : (r.color === 'warning' ? 'var(--warning-bg)' : (r.color === 'info' ? 'var(--info-bg)' : 'var(--success-bg)'));
                    const textColor = r.color === 'danger' ? 'var(--danger-text)' : (r.color === 'warning' ? 'var(--warning-text)' : (r.color === 'info' ? 'var(--info-text)' : 'var(--success-text)'));
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><span class="badge" style="background:${badgeColor}; color:${textColor}">${r.status}</span></td>
                        <td><span style="font-family:monospace;">${r.code}</span></td>
                        <td><b>${r.name}</b></td>
                        <td class="font-bold">${r.stock}</td>
                        <td>${r.needed}</td>
                        <td class="font-bold" style="color:${r.color}">${r.diff > 0 ? '+' : ''}${r.diff}</td>
                        <td>
                            ${r.diff < 0 
                                ? `<b class="text-danger">BELI ${Math.abs(r.diff)}</b>` 
                                : `<span class="text-muted">Cukup</span>`}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            },

            /* --- AUDIT RENDERER --- */
            renderAuditTable: function() {
                const tbody = document.getElementById('auditTableBody');
                tbody.innerHTML = appData.audit.map(l => `
                    <tr>
                        <td>${l.timestamp}</td>
                        <td><span class="badge" style="background:var(--info-bg);">${l.action}</span></td>
                        <td>${l.details}</td>
                        <td class="text-muted">${l.user}</td>
                    </tr>
                `).join('');
            },

            /* --- CONFIG --- */
            loadConfigForm: function() {
                document.getElementById('cfg-beds').value = appData.config.beds;
                document.getElementById('cfg-bor').value = appData.config.bor;
                document.getElementById('cfg-ops').value = appData.config.ops;
                document.getElementById('cfg-buffer').value = appData.config.buffer;
            },

            /* --- MODAL LOGIC --- */
            openModal: function(mode, code) {
                const modal = document.getElementById('itemModal'); 
                modal.classList.add('open');
                document.getElementById('linenForm').reset();
                this.currentEditCode = code;
                
                // Populate Categories
                this.populateCategoryDatalist();

                if(mode==='edit' && code) {
                    const item = appData.items.find(i => i.code === code);
                    document.getElementById('modalTitle').innerText = 'Edit Data Linen';
                    document.getElementById('inp-code').value = item.code; 
                    document.getElementById('inp-code').disabled = true;
                    document.getElementById('inp-name').value = item.name;
                    document.getElementById('inp-type').value = item.type;
                    document.getElementById('inp-category').value = item.category;
                    document.getElementById('inp-price').value = item.price;
                    document.getElementById('inp-composition').value = item.composition || '';
                    document.getElementById('inp-rotation').value = item.rotation || 1.0;
                } else {
                    document.getElementById('modalTitle').innerText = 'Tambah Linen Baru';
                    document.getElementById('inp-code').disabled = false;
                    // Default values
                    document.getElementById('inp-type').value = 'item';
                }
                this.toggleSetInput(document.getElementById('inp-type').value);
            },

            closeModal: function() { 
                document.getElementById('itemModal').classList.remove('open'); 
            },

            toggleSetInput: function(type) {
                const setArea = document.getElementById('set-logic-area');
                const itemArea = document.getElementById('item-logic-area');
                
                if(type==='set') { 
                    setArea.classList.remove('hidden'); 
                    itemArea.classList.add('hidden'); 
                } else { 
                    setArea.classList.add('hidden'); 
                    itemArea.classList.remove('hidden'); 
                }
            },

            validateAndPreviewComposition: function() {
                const text = document.getElementById('inp-composition').value;
                const preview = document.getElementById('composition-preview');
                const check = DataStore.validateComposition(text);
                
                if(check.errors.length > 0) {
                    preview.innerHTML = `<span class="text-danger"><i class="fas fa-times-circle"></i> ${check.errors[0]}</span>`;
                    return false;
                } else {
                    const tags = check.foundItems.map(i => `<span class="composition-tag"><i class="fas fa-check"></i> ${i}</span>`).join('');
                    preview.innerHTML = tags || `<small class="text-muted">Belum ada komponen</small>`;
                    return true;
                }
            },

            saveItem: function(e) {
                e.preventDefault();
                const type = document.getElementById('inp-type').value;
                const newItem = {
                    code: this.currentEditCode, 
                    type: type, 
                    name: document.getElementById('inp-name').value,
                    category: document.getElementById('inp-category').value, 
                    price: parseInt(document.getElementById('inp-price').value)||0,
                    rotation: parseFloat(document.getElementById('inp-rotation').value)||1.0, 
                    composition: document.getElementById('inp-composition').value, 
                    stock:0, damaged:0
                };

                if(type==='set') {
                    if(!this.validateAndPreviewComposition()) return; // Stop if invalid
                }

                try { 
                    DataStore.addItem(newItem); 
                    AppUI.showToast('Data berhasil disimpan', 'success'); 
                    this.closeModal(); 
                    this.renderMasterTable(); 
                    this.renderDashboard(); 
                } catch (err) { 
                    AppUI.showToast(err.message, 'error'); 
                }
            },

            deleteItem: function(code) {
                if(confirm('Yakin ingin menghapus item ini secara permanen?')) { 
                    try {
                        DataStore.deleteItem(code); 
                        this.renderMasterTable(); 
                        this.renderDashboard(); 
                        AppUI.showToast('Item dihapus', 'success');
                    } catch(err) {
                        AppUI.showToast(err.message, 'error');
                    }
                }
            },

            populateCategoryDatalist: function() {
                const cats = [...new Set(appData.items.map(i => i.category))];
                document.getElementById('listCategory').innerHTML = cats.map(c=>`<option value="${c}">`).join('');
            },

            formatRupiah: function(num) { 
                return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num); 
            },

            showToast: function(msg, type='info') {
                const div = document.createElement('div');
                div.className = `toast ${type}`; 
                div.innerHTML = `<span>${msg}</span> <i class="fas fa-times" style="cursor:pointer; margin-left:10px;" onclick="this.parentElement.remove()"></i>`;
                document.getElementById('toast-container').appendChild(div);
                setTimeout(()=>div.remove(), 4000);
            }
        };

        /**
         * ==========================================
         * MAIN APP CONTROLLER
         * ==========================================
         */
        const App = {
            init: function() {
                CloudManager.loadFromCloud();
            },
            switchView: function(id) { AppUI.switchView(id); },
            syncToCloud: function() { CloudManager.syncToCloud(); },
            saveConfig: function() {
                appData.config = {
                    beds: parseInt(document.getElementById('cfg-beds').value) || 0,
                    bor: parseInt(document.getElementById('cfg-bor').value) || 0,
                    ops: parseInt(document.getElementById('cfg-ops').value) || 0,
                    buffer: parseInt(document.getElementById('cfg-buffer').value) || 3
                };
                CloudManager.saveToLocal();
                AuditLog.add('CONFIG', 'Update konfigurasi RS');
                AppUI.showToast('Konfigurasi tersimpan', 'success');
            },
            runAnalysis: function() {
                const loss = parseInt(document.getElementById('param-loss-factor').value) || 0;
                const results = LinenLogic.runAnalysis(loss);
                AppUI.renderAnalysisResults(results);
                AppUI.showToast('Analisa selesai', 'success');
            },
            backupData: function() {
                const blob = new Blob([JSON.stringify(appData, null, 2)], {type:'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `backup_linen_rs_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                AppUI.showToast('Backup file didownload', 'success');
            }
        };

        // Event Listener for composition preview
        document.getElementById('inp-composition').addEventListener('input', function() {
            AppUI.validateAndPreviewComposition();
        });

        // Start
        document.addEventListener('DOMContentLoaded', () => App.init());

    </script>
</body>
</html>
