<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RS Laundry OS Enterprise</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Chart.js for Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-dark: #0f172a; --bg-card: #1e293b; --text-main: #f8fafc; --text-muted: #94a3b8;
            --primary: #3b82f6; --primary-glow: rgba(59, 130, 246, 0.5);
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
            --border: rgba(255,255,255,0.1);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Inter', sans-serif; background: var(--bg-dark); color: var(--text-main);
            font-size: 13px; height: 100vh; overflow: hidden;
        }
        h1, h2, h3 { font-family: 'Rajdhani', sans-serif; text-transform: uppercase; letter-spacing: 1px; }

        /* LOGIN */
        #login-screen {
            position: fixed; inset: 0; background: linear-gradient(135deg, #020617, #1e1b4b);
            z-index: 9999; display: flex; justify-content: center; align-items: center;
        }
        .login-box {
            width: 90%; max-width: 340px; background: rgba(15, 23, 42, 0.9); border: 1px solid var(--border);
            backdrop-filter: blur(20px); padding: 30px; border-radius: 16px; text-align: center;
        }

        /* LAYOUT */
        .app-layout { display: grid; grid-template-columns: 250px 1fr; height: 100vh; }
        .sidebar {
            background: var(--bg-card); border-right: 1px solid var(--border); display: flex;
            flex-direction: column; padding: 20px 0; overflow-y: auto;
        }
        .brand { padding: 0 24px 20px; font-size: 1.2rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        
        .nav-group { padding: 15px 24px 5px; font-size: 0.7rem; color: #64748b; font-weight: 700; letter-spacing: 1px; }
        .nav-item {
            padding: 12px 24px; color: var(--text-muted); display: flex; align-items: center; gap: 12px;
            cursor: pointer; transition: 0.3s; border-left: 3px solid transparent;
        }
        .nav-item:hover, .nav-item.active {
            background: rgba(59, 130, 246, 0.1); color: var(--primary); border-left-color: var(--primary);
        }

        /* CONTENT */
        .main-content { padding: 24px; overflow-y: auto; height: 100%; }
        .card {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px;
            padding: 20px; margin-bottom: 20px;
        }
        .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .stat-value { font-size: 2rem; font-weight: 700; font-family: 'Rajdhani'; margin: 5px 0; }
        .stat-label { color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; }

        /* FORMS & BUTTONS */
        input, select, textarea {
            width: 100%; background: rgba(0,0,0,0.2); border: 1px solid var(--border);
            color: white; padding: 10px; border-radius: 6px; font-family: inherit; margin-bottom: 10px;
        }
        .btn {
            background: var(--primary); color: white; border: none; padding: 10px 16px;
            border-radius: 6px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; }
        .btn-danger { background: var(--danger); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }

        /* TABLES */
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        th { text-align: left; padding: 10px; color: var(--text-muted); border-bottom: 1px solid var(--border); font-size: 0.7rem; }
        td { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }

        /* BADGES */
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; }
        .bg-success { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .bg-warning { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .bg-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .bg-info { background: rgba(59, 130, 246, 0.2); color: var(--primary); }

        /* UTILS */
        .hidden { display: none !important; }
        .flex { display: flex; gap: 10px; align-items: center; }
        .flex-between { justify-content: space-between; }
        #loading-overlay {
            position: fixed; inset: 0; background: rgba(15,23,42,0.95); z-index: 5000;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }

        /* MOBILE */
        @media (max-width: 768px) {
            .app-layout { grid-template-columns: 1fr; }
            .sidebar { position: fixed; left: -250px; top: 0; bottom: 0; z-index: 1000; transition: 0.3s; width: 250px; }
            .sidebar.active { left: 0; }
            .mobile-header { display: flex !important; padding: 15px; background: var(--bg-dark); justify-content: space-between; border-bottom: 1px solid var(--border); }
        }
        @media (min-width: 769px) { .mobile-header { display: none; } }
    </style>
</head>
<body>

<!-- LOADING -->
<div id="loading-overlay">
    <div style="font-size: 3rem; color: var(--primary);"><i class="fas fa-spinner fa-spin"></i></div>
    <p style="margin-top:10px;">SYNCING ENTERPRISE DATA...</p>
</div>

<!-- LOGIN -->
<section id="login-screen">
    <div class="login-box">
        <i class="fas fa-hospital-alt fa-3x" style="color:var(--primary); margin-bottom:15px;"></i>
        <h1 style="margin-bottom:5px;">RS LAUNDRY OS</h1>
        <p style="color:var(--text-muted); margin-bottom:20px; font-size:0.8rem;">ENTERPRISE EDITION</p>
        <form id="loginForm">
            <input type="text" id="username" placeholder="Username" required>
            <input type="password" id="password" placeholder="Password" required>
            <button type="submit" class="btn" style="width:100%;">LOGIN</button>
        </form>
    </div>
</section>

<!-- APP -->
<div class="app-layout hidden" id="main-app">
    <div class="mobile-header">
        <button class="btn-outline" style="border:none; color:white; padding:0;" onclick="toggleSidebar()"><i class="fas fa-bars fa-lg"></i></button>
        <span style="font-weight:700;">LAUNDRY OS</span>
        <i class="fas fa-user-circle fa-lg"></i>
    </div>

    <nav class="sidebar" id="sidebar">
        <div class="brand"><i class="fas fa-hospital-alt"></i> RS LAUNDRY</div>
        
        <div class="nav-group">MONITORING</div>
        <div class="nav-item active" onclick="App.nav('dashboard')"><i class="fas fa-chart-line"></i> Executive Dashboard</div>
        
        <div class="nav-group">OPERATIONS</div>
        <div class="nav-item" onclick="App.nav('workflow')"><i class="fas fa-qrcode"></i> Linen Scan Workflow</div>
        <div class="nav-item" onclick="App.nav('opname')"><i class="fas fa-clipboard-check"></i> Stock Opname</div>
        <div class="nav-item" onclick="App.nav('handover')"><i class="fas fa-exchange-alt"></i> Room Handover</div>

        <div class="nav-group">RESOURCES</div>
        <div class="nav-item" onclick="App.nav('chemical')"><i class="fas fa-flask"></i> Chemical & Usage</div>
        <div class="nav-item" onclick="App.nav('maintenance')"><i class="fas fa-tools"></i> Machine Maintenance</div>

        <div style="margin-top:auto; padding:20px;">
            <div style="font-size:0.7rem; color:var(--text-muted);">LOGGED IN:</div>
            <div id="user-display" style="font-weight:600;">-</div>
            <button class="btn btn-danger" style="width:100%; margin-top:10px; justify-content:center;" onclick="Auth.logout()">LOGOUT</button>
        </div>
    </nav>

    <main class="main-content">
        <!-- DASHBOARD -->
        <section id="view-dashboard" class="view-section">
            <header class="flex-between" style="margin-bottom:20px;">
                <h2>Executive Dashboard</h2>
                <span class="badge bg-info" id="clock">--:--</span>
            </header>
            
            <div class="grid-4">
                <div class="card">
                    <div class="stat-label">Total Linen Asset</div>
                    <div class="stat-value" id="dash-linen-total">0</div>
                    <div class="stat-label">Items Managed</div>
                </div>
                <div class="card">
                    <div class="stat-label">Chemical Cost (MTD)</div>
                    <div class="stat-value" style="color:var(--success);">Rp 0</div>
                    <div class="stat-label">Optimized Usage</div>
                </div>
                <div class="card">
                    <div class="stat-label">Machine Issues</div>
                    <div class="stat-value" style="color:var(--danger);" id="dash-maintenance">0</div>
                    <div class="stat-label">Pending Repairs</div>
                </div>
                <div class="card">
                    <div class="stat-label">Critical Linen</div>
                    <div class="stat-value" id="dash-critical">0</div>
                    <div class="stat-label">Need Replacement</div>
                </div>
            </div>

            <div class="card">
                <h3>System Health</h3>
                <canvas id="dashboardChart" height="100"></canvas>
            </div>
        </section>

        <!-- WORKFLOW -->
        <section id="view-workflow" class="view-section hidden">
            <h2>Linen Workflow</h2>
            <div class="card">
                <div class="flex">
                    <input type="text" id="wf-scan" placeholder="Scan Linen ID (QR/RFID)" style="flex:2;">
                    <select id="wf-action" style="flex:1;">
                        <option value="WASHING">Washing</option>
                        <option value="READY">Ready</option>
                        <option value="DISTRIBUTED">Distributed</option>
                        <option value="DAMAGED">Damaged</option>
                    </select>
                    <button class="btn" onclick="Workflow.submit()">Process</button>
                </div>
                <div id="wf-preview" style="margin-top:15px; padding:10px; background:rgba(0,0,0,0.2); border-radius:6px; display:none;"></div>
            </div>
        </section>

        <!-- OPNAME -->
        <section id="view-opname" class="view-section hidden">
            <h2>Stock Opname</h2>
            <div class="card">
                <div class="grid-4">
                    <input type="text" id="op-scan" placeholder="Scan Item">
                    <input type="text" id="op-unit" placeholder="Unit Code">
                    <button class="btn btn-outline" onclick="StockOpname.add()">Add List</button>
                    <button class="btn btn-danger" onclick="StockOpname.submit()">Submit Audit</button>
                </div>
                <div style="max-height:200px; overflow-y:auto; margin-top:15px;">
                    <table id="table-opname">
                        <thead><tr><th>ID</th><th>Unit</th><th>System</th><th>Physical</th><th>Diff</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- CHEMICAL -->
        <section id="view-chemical" class="view-section hidden">
            <h2>Chemical Usage Log</h2>
            <div class="card">
                <div class="grid-4">
                    <div><input type="date" id="chem-date"></div>
                    <div><select id="chem-shift"><option value="I">Shift I</option><option value="II">Shift II</option></select></div>
                    <div><input type="number" id="chem-kg" placeholder="Total Linen (Kg)"></div>
                    <div><input type="number" id="chem-lpg" placeholder="LPG (Tabung)"></div>
                </div>
                <h4 style="margin:10px 0;">Chemical Consumption (Auto-Calc)</h4>
                <div class="grid-4">
                    <input type="number" id="c-detergent" placeholder="Deterjen (ml)" readonly>
                    <input type="number" id="c-disinfectant" placeholder="Disinfektan (ml)" readonly>
                    <input type="number" id="c-alkali" placeholder="Alkali (ml)" readonly>
                    <input type="number" id="c-softener" placeholder="Softener (ml)" readonly>
                </div>
                <button class="btn" onclick="Chemical.submit()">Log Usage</button>
            </div>
        </section>

        <!-- MAINTENANCE -->
        <section id="view-maintenance" class="view-section hidden">
            <h2>Machine Maintenance</h2>
            <div class="card">
                <div class="flex">
                    <input type="text" id="m-machine" placeholder="Machine Name" style="flex:1;">
                    <input type="text" id="m-desc" placeholder="Issue Description" style="flex:2;">
                    <button class="btn btn-danger" onclick="Maintenance.submit()">Report</button>
                </div>
            </div>
            <div class="card">
                <h3>Recent Logs</h3>
                <table id="table-maint">
                    <thead><tr><th>Date</th><th>Machine</th><th>Issue</th><th>Status</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <!-- HANDOVER -->
        <section id="view-handover" class="view-section hidden">
            <h2>Room Handover</h2>
            <div class="card">
                <div class="flex"><input type="text" id="ho-from" placeholder="From Unit"></div>
                <div class="flex"><input type="text" id="ho-to" placeholder="To Unit"></div>
                <div class="flex"><input type="text" id="ho-id" placeholder="Linen ID"></div>
                <div class="flex"><input type="number" id="ho-qty" placeholder="Qty"></div>
                <button class="btn" onclick="Handover.submit()">Record Handover</button>
            </div>
        </section>
    </main>
</div>

<script>
// CONFIG: GANTI DENGAN URL DEPLOYMENT APPS SCRIPT KAMU
const CONFIG = {
    SCRIPT_URL: "https://script.google.com/macros/s/AKfycbyZWftgh7VHubW-flXJb_Y3PMbvLSKBKj-3S1e7TWH5MKqBXaguJeErVU4oF_mHG6iDyg/exec"
};

const State = {
    user: null,
    data: { linen:[], units:[], chemicals:[], machines:[], transactions:[], maintenance:[] },
    opnameList: []
};

// AUTH
const Auth = {
    login: async function(u, p) {
        UI.showLoading(true);
        try {
            const res = await fetch(CONFIG.SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'login', username: u, password: p })
            });
            const json = await res.json();
            if (json.status === 'success') {
                State.user = json.user;
                AndroidNative.saveToLocal('user', JSON.stringify(json.user));
                this.success();
            } else { UI.showToast(json.message, 'error'); }
        } catch (e) { UI.showToast("Connection Failed", 'error'); }
        UI.showLoading(false);
    },
    success: function() {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        document.getElementById('user-display').innerText = State.user.name;
        Data.sync();
    },
    logout: function() { location.reload(); }
};

// DATA
const Data = {
    sync: async function() {
        UI.showLoading(true);
        try {
            const res = await fetch(CONFIG.SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'get_initial_data' })
            });
            const json = await res.json();
            if (json.status === 'success') {
                State.data = json;
                App.renderDashboard();
                App.renderMaintenance();
                UI.showToast("Data Synced", 'success');
            }
        } catch (e) { UI.showToast("Sync Error", 'warning'); }
        UI.showLoading(false);
    },
    post: async function(payload) {
        UI.showLoading(true);
        try {
            const res = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
            const json = await res.json();
            UI.showLoading(false);
            if(json.status === 'success') {
                UI.showToast("Success", 'success');
                this.sync(); // Refresh data
                return true;
            }
            UI.showToast(json.message, 'error');
        } catch(e) { UI.showLoading(false); }
        return false;
    }
};

// MODULES
const Workflow = {
    queue: [],
    scan: function() {
        const id = document.getElementById('wf-scan').value.trim();
        if(!id) return;
        const linen = State.data.linen.find(l => l.LinenID == id);
        if(!linen) return UI.showToast("Linen not found", 'error');
        
        const preview = document.getElementById('wf-preview');
        preview.style.display = 'block';
        preview.innerHTML = `<strong>${linen.Name}</strong> - Status: ${linen.Status}`;
        this.queue.push({ linenId: id, newStatus: document.getElementById('wf-action').value });
        document.getElementById('wf-scan').value = '';
    },
    submit: function() {
        if(this.queue.length === 0) return UI.showToast("Scan item first", 'warning');
        Data.post({ action: 'process_linen_scan', scans: this.queue, user: State.user, location: 'LAUNDRY' })
        .then(() => { this.queue = []; document.getElementById('wf-preview').style.display='none'; });
    }
};

const StockOpname = {
    add: function() {
        const id = document.getElementById('op-scan').value.trim();
        if(!id) return;
        // Simple logic: Assume system count is 1. 
        State.opnameList.push({ linenId: id, systemCount: 1, physicalCount: 1, diff: 0, unit: document.getElementById('op-unit').value });
        this.render();
        document.getElementById('op-scan').value = '';
    },
    submit: function() {
        if(State.opnameList.length === 0) return UI.showToast("List empty", 'warning');
        Data.post({ action: 'submit_stock_opname', items: State.opnameList, user: State.user, auditor: State.user.name })
        .then(() => { State.opnameList = []; this.render(); });
    },
    render: function() {
        const tbody = document.querySelector('#table-opname tbody');
        tbody.innerHTML = '';
        State.opnameList.forEach((item, idx) => {
            tbody.innerHTML += `<tr>
                <td>${item.linenId}</td><td>${item.unit}</td><td>${item.systemCount}</td>
                <td><input type="number" style="width:50px; padding:5px;" value="${item.physicalCount}" onchange="StockOpname.update(${idx}, this.value)"></td>
                <td>${item.diff}</td>
            </tr>`;
        });
    },
    update: function(idx, val) {
        State.opnameList[idx].physicalCount = parseInt(val);
        State.opnameList[idx].diff = State.opnameList[idx].systemCount - parseInt(val);
        this.render();
    }
};

const Chemical = {
    submit: function() {
        const kg = document.getElementById('chem-kg').value;
        if(!kg) return UI.showToast("Enter KG", 'warning');
        
        // Auto calculation logic based on typical recipe (Example: 10ml/kg)
        document.getElementById('c-detergent').value = kg * 10;
        document.getElementById('c-disinfectant').value = kg * 15; 
        // ... other calc logic ...

        Data.post({
            action: 'submit_daily_chemical',
            date: document.getElementById('chem-date').value,
            shift: document.getElementById('chem-shift').value,
            totalKg: kg, nonInfecKg: kg, infecKg: 0,
            detergent: kg * 10, disinfectant: kg * 15, alkali: 0, softener: 0,
            lpg: document.getElementById('chem-lpg').value,
            operator: State.user.name
        });
    }
};

const Maintenance = {
    submit: function() {
        Data.post({
            action: 'submit_maintenance',
            machineName: document.getElementById('m-machine').value,
            issueDesc: document.getElementById('m-desc').value,
            reportedBy: State.user.name
        });
    }
};

const Handover = {
    submit: function() {
        Data.post({
            action: 'submit_room_handover',
            fromUnit: document.getElementById('ho-from').value,
            toUnit: document.getElementById('ho-to').value,
            linenId: document.getElementById('ho-id').value,
            qty: document.getElementById('ho-qty').value
        });
    }
};

// APP CONTROLLER
const App = {
    nav: function(id) {
        document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden'));
        document.getElementById('view-' + id).classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        event.currentTarget.classList.add('active');
    },
    renderDashboard: function() {
        document.getElementById('dash-linen-total').innerText = State.data.linen.length;
        document.getElementById('dash-maintenance').innerText = State.data.maintenance.filter(m => m.Status === 'REPORTED').length;
        document.getElementById('dash-critical').innerText = State.data.linen.filter(l => l.HealthStatus === 'CRITICAL').length;
        
        // Simple Chart Render
        if(window.myChart) window.myChart.destroy();
        const ctx = document.getElementById('dashboardChart').getContext('2d');
        window.myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Total', 'Ready', 'Critical', 'Missing'],
                datasets: [{
                    label: '# of Linen',
                    data: [
                        State.data.linen.length,
                        State.data.linen.filter(l => l.Status === 'READY').length,
                        State.data.linen.filter(l => l.HealthStatus === 'CRITICAL').length,
                        State.data.linen.filter(l => l.Status === 'MISSING').length
                    ],
                    backgroundColor: ['#3b82f6', '#10b981', '#ef4444', '#f59e0b']
                }]
            },
            options: { plugins: { legend: { labels: { color: 'white' } } }, scales: { y: { ticks: { color: '#94a3b8' } }, x: { ticks: { color: '#94a3b8' } } } }
        });
    },
    renderMaintenance: function() {
        const tbody = document.querySelector('#table-maint tbody');
        tbody.innerHTML = '';
        State.data.maintenance.forEach(m => {
            tbody.innerHTML += `<tr>
                <td>${new Date(m.ReportDate).toLocaleDateString()}</td>
                <td>${m.MachineName}</td>
                <td>${m.IssueDescription}</td>
                <td><span class="badge bg-warning">${m.Status}</span></td>
            </tr>`;
        });
    }
};

const UI = {
    showLoading: function(show) {
        document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
    },
    showToast: function(msg, type='info') {
        const el = document.createElement('div');
        el.style.cssText = `position:fixed; bottom:20px; right:20px; background:${type=='error'?'var(--danger)':'var(--success)'}; color:white; padding:10px 20px; border-radius:8px; z-index:9999; animation:slideIn 0.3s;`;
        el.innerText = msg;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 3000);
    }
};

function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }

// INIT
document.getElementById('loginForm').addEventListener('submit', (e) => { e.preventDefault(); Auth.login(document.getElementById('username').value, document.getElementById('password').value); });
document.getElementById('wf-scan').addEventListener('keypress', e => { if(e.key==='Enter') Workflow.scan(); });
document.getElementById('op-scan').addEventListener('keypress', e => { if(e.key==='Enter') StockOpname.add(); });
setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString(), 1000);
</script>
</body>
</html>


