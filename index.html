<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <title>RS Laundry OS Enterprise</title>
    
    <!-- External Assets -->
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-dark: #0f172a; --bg-card: #1e293b; --bg-input: #0f172a;
            --text-main: #f8fafc; --text-muted: #94a3b8;
            --primary: #3b82f6; --primary-hover: #2563eb; --primary-glow: rgba(59, 130, 246, 0.5);
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
            --border: rgba(255,255,255,0.1);
            --radius: 8px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            font-family: 'Inter', sans-serif; background: var(--bg-dark); color: var(--text-main);
            font-size: 13px; height: 100vh; overflow: hidden;
        }

        h1, h2, h3, h4 { font-family: 'Rajdhani', sans-serif; text-transform: uppercase; letter-spacing: 1px; }

        /* --- COMPONENTS --- */
        
        /* Buttons */
        .btn {
            background: var(--primary); color: white; border: none; padding: 10px 16px;
            border-radius: var(--radius); font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;
            transition: all 0.2s; font-size: 0.9rem;
        }
        .btn:hover { background: var(--primary-hover); transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }
        .btn-danger { background: var(--danger); }
        .btn-danger:hover { background: #dc2626; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
        .btn-outline:hover { border-color: var(--text-main); color: var(--text-main); background: rgba(255,255,255,0.05); }
        .btn-full { width: 100%; justify-content: center; }

        /* Inputs */
        input, select, textarea {
            width: 100%; background: var(--bg-input); border: 1px solid var(--border);
            color: white; padding: 10px; border-radius: var(--radius); font-family: inherit; margin-bottom: 10px;
            transition: border-color 0.2s;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); }
        
        /* Cards & Layout */
        .card {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px;
            padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow);
        }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        
        .flex { display: flex; gap: 10px; align-items: center; }
        .flex-between { justify-content: space-between; }
        .flex-col { flex-direction: column; align-items: stretch; }
        .flex-1 { flex: 1; }

        /* Badges */
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .bg-success { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .bg-warning { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .bg-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .bg-info { background: rgba(59, 130, 246, 0.2); color: var(--primary); }

        /* Tables */
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        th { text-align: left; padding: 12px 10px; color: var(--text-muted); border-bottom: 1px solid var(--border); font-size: 0.7rem; text-transform: uppercase; }
        td { padding: 12px 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: rgba(255,255,255,0.02); }

        /* Stats */
        .stat-value { font-size: 2rem; font-weight: 700; font-family: 'Rajdhani'; margin: 5px 0; line-height: 1; }
        .stat-label { color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; }

        /* --- SPECIFIC VIEWS --- */
        
        /* Login */
        #login-screen {
            position: fixed; inset: 0; background: linear-gradient(135deg, #020617, #1e1b4b);
            z-index: 9999; display: flex; justify-content: center; align-items: center;
        }
        .login-box {
            width: 90%; max-width: 380px; background: rgba(15, 23, 42, 0.95); border: 1px solid var(--border);
            backdrop-filter: blur(20px); padding: 40px 30px; border-radius: 20px; text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        /* Sidebar */
        .app-layout { display: grid; grid-template-columns: 260px 1fr; height: 100vh; }
        .sidebar {
            background: var(--bg-card); border-right: 1px solid var(--border); display: flex;
            flex-direction: column; padding: 20px 0; overflow-y: auto; z-index: 100;
        }
        .brand { padding: 0 24px 30px; font-size: 1.3rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 12px; }
        
        .nav-group { padding: 20px 24px 5px; font-size: 0.7rem; color: #475569; font-weight: 700; letter-spacing: 1.2px; margin-top: 10px;}
        .nav-item {
            padding: 12px 24px; color: var(--text-muted); display: flex; align-items: center; gap: 12px;
            cursor: pointer; transition: 0.2s; border-left: 3px solid transparent; font-weight: 500;
        }
        .nav-item:hover, .nav-item.active {
            background: rgba(59, 130, 246, 0.08); color: var(--primary); border-left-color: var(--primary);
        }

        /* Main Content */
        .main-content { padding: 30px; overflow-y: auto; height: 100%; }
        .section-header { margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }

        /* Loader */
        #loading-overlay {
            position: fixed; inset: 0; background: rgba(15,23,42,0.9); z-index: 10000;
            display: none; justify-content: center; align-items: center; flex-direction: column; backdrop-filter: blur(5px);
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-left-color: var(--primary);
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Utilities */
        .hidden { display: none !important; }
        .text-right { text-align: right; }

        /* Toast Notification */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; }
        .toast {
            background: var(--bg-card); border-left: 4px solid var(--primary); color: white;
            padding: 15px 20px; border-radius: 4px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            min-width: 300px; animation: slideIn 0.3s ease-out; display: flex; align-items: center; justify-content: space-between;
        }
        .toast.success { border-color: var(--success); }
        .toast.error { border-color: var(--danger); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Responsive */
        @media (max-width: 900px) {
            .app-layout { grid-template-columns: 1fr; }
            .sidebar { position: fixed; left: -260px; top: 0; bottom: 0; width: 260px; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
            .sidebar.active { left: 0; box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
            .mobile-header { display: flex !important; padding: 15px 20px; background: var(--bg-dark); justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
            .main-content { padding: 20px; }
        }
        @media (min-width: 901px) { .mobile-header { display: none; } }
    </style>
</head>
<body>

<!-- LOADING OVERLAY -->
<div id="loading-overlay">
    <div class="spinner"></div>
    <p style="letter-spacing: 2px; font-weight: 600; font-size: 0.9rem;">MENGHUBUNGKAN KE SERVER...</p>
</div>

<!-- TOAST CONTAINER -->
<div id="toast-container"></div>

<!-- LOGIN SCREEN -->
<section id="login-screen">
    <div class="login-box">
        <i class="fas fa-hospital-alt fa-3x" style="color:var(--primary); margin-bottom:20px;"></i>
        <h1 style="margin-bottom:5px; font-size: 1.8rem;">RS LAUNDRY OS</h1>
        <p style="color:var(--text-muted); margin-bottom:30px; font-size:0.85rem;">ENTERPRISE EDITION v1.0</p>
        
        <form id="loginForm">
            <div style="text-align: left;">
                <label style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 5px; display: block;">USERNAME</label>
                <input type="text" id="username" placeholder="Username" required autocomplete="off">
                
                <label style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 5px; display: block;">PASSWORD</label>
                <input type="password" id="password" placeholder="Password" required>
            </div>
            <button type="submit" class="btn btn-full" style="margin-top: 15px; padding: 12px;">LOGIN SYSTEM</button>
        </form>
    </div>
</section>

<!-- MAIN APPLICATION -->
<div class="app-layout hidden" id="main-app">
    
    <!-- Mobile Header -->
    <div class="mobile-header">
        <button class="btn" style="background:transparent; padding:5px; color:white;" onclick="UI.toggleSidebar()">
            <i class="fas fa-bars fa-lg"></i>
        </button>
        <div style="display:flex; align-items:center; gap:10px;">
            <i class="fas fa-hospital-alt" style="color:var(--primary);"></i>
            <span style="font-weight:700; letter-spacing: 1px;">LAUNDRY OS</span>
        </div>
        <div style="width: 32px;"></div> <!-- Spacer -->
    </div>

    <!-- Sidebar Navigation -->
    <nav class="sidebar" id="sidebar">
        <div class="brand">
            <i class="fas fa-hospital-alt"></i> 
            <div>
                RS LAUNDRY
                <div style="font-size:0.6rem; color:var(--text-muted); font-weight:400; letter-spacing: 0.5px;">ENTERPRISE</div>
            </div>
        </div>
        
        <div class="nav-group">MONITORING</div>
        <div class="nav-item active" onclick="App.nav('dashboard')"><i class="fas fa-chart-line"></i> Dashboard</div>
        
        <div class="nav-group">OPERATIONS</div>
        <div class="nav-item" onclick="App.nav('workflow')"><i class="fas fa-qrcode"></i> Linen Scan</div>
        <div class="nav-item" onclick="App.nav('opname')"><i class="fas fa-clipboard-check"></i> Stock Opname</div>
        <div class="nav-item" onclick="App.nav('handover')"><i class="fas fa-exchange-alt"></i> Room Handover</div>

        <div class="nav-group">RESOURCES</div>
        <div class="nav-item" onclick="App.nav('chemical')"><i class="fas fa-flask"></i> Chemical Log</div>
        <div class="nav-item" onclick="App.nav('maintenance')"><i class="fas fa-tools"></i> Maintenance</div>
        <div class="nav-item" onclick="App.nav('masterdata')"><i class="fas fa-plus-circle"></i> Add New Linen</div>

        <div style="margin-top:auto; padding:20px; border-top: 1px solid var(--border);">
            <div style="font-size:0.7rem; color:var(--text-muted); margin-bottom: 5px;">LOGGED IN:</div>
            <div id="user-display" style="font-weight:600; color:white; display:flex; align-items:center; gap:8px;">
                <i class="fas fa-user-circle"></i> <span>-</span>
            </div>
            <button class="btn btn-danger btn-full" style="margin-top:15px; justify-content:center;" onclick="Auth.logout()">
                <i class="fas fa-sign-out-alt"></i> LOGOUT
            </button>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="main-content" onclick="UI.closeSidebarOnMobile(event)">
        
        <!-- DASHBOARD VIEW -->
        <section id="view-dashboard" class="view-section">
            <header class="section-header">
                <h2><i class="fas fa-chart-pie" style="margin-right:10px; color:var(--primary);"></i> Executive Dashboard</h2>
                <div class="flex">
                    <button class="btn btn-outline" style="padding: 5px 10px;" onclick="Data.sync()"><i class="fas fa-sync-alt"></i> Refresh</button>
                </div>
            </header>

            <div class="grid-4">
                <div class="card">
                    <div class="stat-label">Total Linen</div>
                    <div class="stat-value" id="dash-linen">0</div>
                    <div style="font-size: 0.75rem; color: var(--success);"><i class="fas fa-check"></i> Inventory Tracked</div>
                </div>
                <div class="card">
                    <div class="stat-label">Critical Health</div>
                    <div class="stat-value" style="color:var(--danger);" id="dash-critical">0</div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">Max Cycle Reached</div>
                </div>
                <div class="card">
                    <div class="stat-label">Active Maintenance</div>
                    <div class="stat-value" style="color:var(--warning);" id="dash-maint">0</div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">Requires Attention</div>
                </div>
                <div class="card">
                    <div class="stat-label">Chemical Stock</div>
                    <div class="stat-value" style="color:var(--primary);" id="dash-chem">OK</div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">Inventory Status</div>
                </div>
            </div>

            <div class="grid-2" style="grid-template-columns: 2fr 1fr;">
                <div class="card">
                    <h3 style="margin-bottom:15px;">Linen Status Distribution</h3>
                    <div style="height: 250px; position: relative;">
                        <canvas id="dashChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h3 style="margin-bottom:15px;">Recent Activity</h3>
                    <div style="overflow-y: auto; max-height: 250px;">
                        <table id="dash-recent-table">
                            <thead><tr><th>Time</th><th>Action</th><th>User</th></tr></thead>
                            <tbody><!-- Populated via JS --></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- WORKFLOW / SCAN VIEW -->
        <section id="view-workflow" class="view-section hidden">
            <header class="section-header">
                <h2>Linen Workflow</h2>
                <div class="badge bg-info">SCANNING MODE</div>
            </header>
            
            <div class="grid-2">
                <div class="card">
                    <h3 style="margin-bottom:15px; color:var(--text-muted);">Process Item</h3>
                    <div class="flex">
                        <input type="text" id="wf-scan" placeholder="Scan RFID / Barcode..." style="flex:2;" autofocus>
                        <select id="wf-action" style="flex:1;">
                            <option value="WASHING">Washing</option>
                            <option value="DRYING">Drying</option>
                            <option value="READY">Ready</option>
                            <option value="DAMAGED">Damaged</option>
                            <option value="IN_USE">In Use</option>
                        </select>
                    </div>
                    <button class="btn btn-full" onclick="Workflow.submit()">Process Transaction</button>
                    
                    <div id="wf-preview" style="margin-top:20px; padding:15px; background:rgba(59, 130, 246, 0.1); border:1px solid rgba(59, 130, 246, 0.3); border-radius:8px; display:none;">
                        <div style="font-size:0.7rem; color:var(--text-muted); text-transform:uppercase;">Last Scanned</div>
                        <div style="font-weight:700; font-size:1.1rem; margin-bottom:5px;" id="preview-name">-</div>
                        <div class="flex flex-between">
                            <span class="badge bg-info" id="preview-id">ID: -</span>
                            <span style="font-size:0.8rem;" id="preview-cycle">Cycle: 0/50</span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom:15px; color:var(--text-muted);">Batch Queue</h3>
                    <div style="background:rgba(0,0,0,0.2); border-radius:8px; padding:10px; min-height: 150px;">
                        <ul id="wf-queue-list" style="list-style:none; padding:0; margin:0; font-size:0.8rem;">
                            <li style="color:var(--text-muted); text-align:center; padding-top:40px;">Queue is empty</li>
                        </ul>
                    </div>
                    <div class="flex" style="margin-top:10px;">
                        <button class="btn btn-outline flex-1" onclick="Workflow.clearQueue()">Clear</button>
                        <button class="btn btn-success flex-1" onclick="Workflow.processQueue()">Submit All</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- STOCK OPNAME -->
        <section id="view-opname" class="view-section hidden">
            <header class="section-header">
                <h2>Stock Opname</h2>
                <span class="badge bg-warning">AUDIT MODE</span>
            </header>
            <div class="card">
                <div class="grid-3">
                    <input type="text" id="op-scan" placeholder="Scan Linen ID">
                    <input type="text" id="op-unit" placeholder="Unit / Location">
                    <select id="op-condition">
                        <option value="GOOD">Condition: Good</option>
                        <option value="STAINED">Condition: Stained</option>
                        <option value="TORN">Condition: Torn</option>
                    </select>
                </div>
                <div class="flex">
                    <button class="btn btn-outline" onclick="StockOpname.add()"><i class="fas fa-plus"></i> Add Item</button>
                    <button class="btn btn-danger" style="margin-left:auto;" onclick="StockOpname.submit()">Finalize Audit</button>
                </div>
            </div>

            <div class="card">
                <h3>Audit List</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Linen ID</th>
                            <th>Name</th>
                            <th>Unit</th>
                            <th>Condition</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="table-opname"></tbody>
                </table>
            </div>
        </section>

        <!-- ROOM HANDOVER -->
        <section id="view-handover" class="view-section hidden">
            <header class="section-header">
                <h2>Room Handover</h2>
            </header>
            <div class="card" style="max-width: 800px; margin: 0 auto;">
                <div class="grid-3">
                    <div>
                        <label class="stat-label">From Unit</label>
                        <input type="text" id="ho-from" placeholder="e.g. Laundry">
                    </div>
                    <div>
                        <label class="stat-label">To Unit</label>
                        <input type="text" id="ho-to" placeholder="e.g. ICU">
                    </div>
                    <div>
                        <label class="stat-label">Date</label>
                        <input type="date" id="ho-date">
                    </div>
                </div>
                
                <div class="grid-4" style="margin-top:10px;">
                    <input type="text" id="ho-id" placeholder="Linen ID (Item Code)">
                    <input type="number" id="ho-qty" placeholder="Qty" value="1">
                    <input type="text" id="ho-cond" placeholder="Condition Note">
                    <button class="btn" onclick="Handover.addLine()"><i class="fas fa-plus"></i> Add</button>
                </div>

                <div style="margin-top:20px;">
                    <table>
                        <thead><tr><th>ID</th><th>Qty</th><th>Condition</th><th>Action</th></tr></thead>
                        <tbody id="table-handover"></tbody>
                    </table>
                </div>

                <div style="margin-top:20px; text-align:right;">
                     <button class="btn btn-success" onclick="Handover.submit()">Record Handover</button>
                </div>
            </div>
        </section>

        <!-- CHEMICAL -->
        <section id="view-chemical" class="view-section hidden">
            <header class="section-header">
                <h2>Daily Chemical Log</h2>
            </header>
            <div class="grid-2">
                <div class="card">
                    <h3>Input Usage</h3>
                    <div class="grid-2">
                        <input type="date" id="c-date">
                        <select id="c-shift">
                            <option value="I">Shift I (Morning)</option>
                            <option value="II">Shift II (Afternoon)</option>
                            <option value="III">Shift III (Night)</option>
                        </select>
                    </div>
                    
                    <div style="margin-top:15px;">
                        <label class="stat-label">Production Data (KG)</label>
                        <div class="grid-3">
                            <input type="number" id="c-kg-total" placeholder="Total">
                            <input type="number" id="c-kg-noninf" placeholder="Non-Infection">
                            <input type="number" id="c-kg-inf" placeholder="Infection">
                        </div>
                    </div>

                    <div style="margin-top:15px;">
                        <label class="stat-label">Chemicals (ml)</label>
                        <div class="grid-2">
                            <input type="number" id="c-detergent" placeholder="Detergent (Brodklin)">
                            <input type="number" id="c-disinfectant" placeholder="Disinfectant (Hevklir)">
                            <input type="number" id="c-alkali" placeholder="Alkali">
                            <input type="number" id="c-softener" placeholder="Softener (Softy)">
                        </div>
                    </div>
                    
                    <div class="grid-2" style="margin-top:15px;">
                         <input type="number" id="c-lpg" placeholder="LPG Tabung">
                    </div>

                    <button class="btn btn-full" style="margin-top:20px;" onclick="Chemical.submit()">Log Usage</button>
                </div>

                <div class="card">
                    <h3>Inventory Status</h3>
                    <table id="chem-inventory-table">
                        <thead><tr><th>Chemical</th><th>Stock (L)</th><th>Status</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- MAINTENANCE -->
        <section id="view-maintenance" class="view-section hidden">
            <header class="section-header">
                <h2>Machine Maintenance</h2>
            </header>
            <div class="grid-2">
                <div class="card">
                    <h3>Report Issue</h3>
                    <label class="stat-label">Machine</label>
                    <select id="m-machine">
                        <!-- Populated by JS -->
                    </select>
                    
                    <label class="stat-label" style="margin-top:10px;">Issue Description</label>
                    <textarea id="m-desc" rows="3" placeholder="Describe the problem..."></textarea>
                    
                    <label class="stat-label" style="margin-top:10px;">Priority</label>
                    <select id="m-priority">
                        <option value="LOW">Low</option>
                        <option value="MEDIUM">Medium</option>
                        <option value="HIGH">High</option>
                    </select>

                    <button class="btn btn-danger btn-full" style="margin-top:20px;" onclick="Maintenance.submit()">Submit Ticket</button>
                </div>

                <div class="card">
                    <h3>Active Tickets</h3>
                    <table id="maint-table">
                        <thead><tr><th>Date</th><th>Machine</th><th>Issue</th><th>Status</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- ADD NEW LINEN -->
        <section id="view-masterdata" class="view-section hidden">
            <header class="section-header">
                <h2>Add New Linen Master</h2>
            </header>
            <div class="card" style="max-width: 600px; margin: 0 auto;">
                <div class="grid-2">
                    <div>
                        <label class="stat-label">Linen Name</label>
                        <input type="text" id="nl-name" placeholder="e.g. Bed Sheet King">
                    </div>
                    <div>
                        <label class="stat-label">Type</label>
                        <input type="text" id="nl-type" placeholder="e.g. Sheet">
                    </div>
                </div>
                
                <div class="grid-2" style="margin-top:10px;">
                    <div>
                        <label class="stat-label">Unit Origin</label>
                        <input type="text" id="nl-origin" placeholder="e.g. ICU">
                    </div>
                    <div>
                        <label class="stat-label">Current Location</label>
                        <input type="text" id="nl-loc" placeholder="e.g. STORAGE">
                    </div>
                </div>

                <div class="grid-2" style="margin-top:10px;">
                    <div>
                        <label class="stat-label">Max Cycle</label>
                        <input type="number" id="nl-maxcycle" value="50">
                    </div>
                    <div>
                        <label class="stat-label">Unit Cost (Rp)</label>
                        <input type="number" id="nl-cost" placeholder="0">
                    </div>
                </div>

                <div style="margin-top:10px;">
                    <label class="stat-label">Quantity</label>
                    <input type="number" id="nl-qty" value="1">
                </div>

                <button class="btn btn-success btn-full" style="margin-top:20px;" onclick="MasterData.add()">Register Linen</button>
            </div>
        </section>

    </main>
</div>

<script>
/**
 * FRONTEND CONFIGURATION
 * PENTING: Ganti URL di bawah ini dengan URL Web App dari Google Script Anda
 */
const CONFIG = {
    // Masukkan URL Deployment Apps Script Anda di sini
    SCRIPT_URL: "https://script.google.com/macros/s/AKfycbyT14PAJfB9l0cmKKRDm_-0CJh5K12G3socfMXST2pQUt92fvFFJo07gruxf9AykuE8GA/exec" 
};

// --- STATE MANAGEMENT ---
const State = {
    user: null,
    data: { 
        linen:[], 
        units:[], 
        chemicals:[], 
        machines:[], 
        transactions:[], 
        maintenance:[],
        opnameLogs: [],
        chemicalUsage: []
    },
    opnameList: [],
    handoverList: []
};

// --- AUTHENTICATION ---
const Auth = {
    login: async function(u, p) {
        UI.showLoading(true);
        try {
            const res = await fetch(CONFIG.SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'login', username: u, password: p })
            });
            const json = await res.json();
            
            if (json.status === 'success') {
                State.user = json.user;
                localStorage.setItem('rs_user', JSON.stringify(json.user));
                this.success();
            } else { 
                UI.showToast(json.message, 'error'); 
            }
        } catch (e) { 
            UI.showToast("Connection Failed: " + e.message, 'error'); 
        }
        UI.showLoading(false);
    },
    checkSession: function() {
        const stored = localStorage.getItem('rs_user');
        if(stored) {
            State.user = JSON.parse(stored);
            this.success();
        }
    },
    success: function() {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        document.getElementById('user-display').innerHTML = `<i class="fas fa-user-circle"></i> <span>${State.user.name}</span>`;
        Data.sync();
    },
    logout: function() { 
        localStorage.removeItem('rs_user');
        location.reload(); 
    }
};

// --- DATA SYNCING ---
const Data = {
    sync: async function() {
        UI.showLoading(true);
        try {
            const res = await fetch(CONFIG.SCRIPT_URL, {
                method: 'POST', 
                body: JSON.stringify({ action: 'get_initial_data' })
            });
            const json = await res.json();
            if (json.status === 'success') {
                State.data = json.data;
                App.render();
                UI.showToast("Data Synced", 'success');
            } else {
                UI.showToast(json.message, 'error');
            }
        } catch (e) { UI.showToast("Sync Error: " + e.message, 'warning'); }
        UI.showLoading(false);
    },
    post: async function(action, payload) {
        UI.showLoading(true);
        try {
            // Append user info automatically if not present
            if(!payload.user) payload.user = State.user;
            
            const res = await fetch(CONFIG.SCRIPT_URL, { 
                method: 'POST', 
                body: JSON.stringify({ ...payload, action: action }) 
            });
            const json = await res.json();
            UI.showLoading(false);
            
            if(json.status === 'success') {
                UI.showToast("Success", 'success');
                this.sync();
                return true;
            }
            UI.showToast(json.message || "Error occurred", 'error');
        } catch(e) { 
            UI.showLoading(false); 
            UI.showToast("Network Error", 'error');
        }
        return false;
    }
};

// --- FEATURE LOGIC ---

const Workflow = {
    queue: [],
    submit: function() {
        const id = document.getElementById('wf-scan').value.trim();
        if(!id) return;
        const linen = State.data.linen.find(l => l.LinenID === id);
        if(!linen) return UI.showToast("Linen ID not found", 'error');
        
        // Visual feedback
        this.queue.push({ linenId: id, newStatus: document.getElementById('wf-action').value });
        this.renderQueue();
        this.previewLinen(linen);
        document.getElementById('wf-scan').value = '';
        document.getElementById('wf-scan').focus();
    },
    processQueue: function() {
        if(this.queue.length === 0) return UI.showToast("Queue empty", 'warning');
        Data.post('process_linen_scan', { scans: this.queue, location: 'LAUNDRY' })
        .then(success => { if(success) { this.clearQueue(); }});
    },
    clearQueue: function() {
        this.queue = [];
        this.renderQueue();
        document.getElementById('wf-preview').style.display='none';
    },
    previewLinen: function(linen) {
        document.getElementById('wf-preview').style.display = 'block';
        document.getElementById('preview-name').innerText = linen.Name;
        document.getElementById('preview-id').innerText = "ID: " + linen.LinenID;
        document.getElementById('preview-cycle').innerText = `Cycle: ${linen.CycleCount}/${linen.MaxCycle}`;
        
        // Color code cycle
        const cycleEl = document.getElementById('preview-cycle');
        if(linen.HealthStatus === 'CRITICAL') cycleEl.style.color = 'var(--danger)';
        else if(linen.HealthStatus === 'WARNING') cycleEl.style.color = 'var(--warning)';
        else cycleEl.style.color = 'var(--success)';
    },
    renderQueue: function() {
        const list = document.getElementById('wf-queue-list');
        list.innerHTML = '';
        this.queue.forEach((item, index) => {
            const l = State.data.linen.find(x => x.LinenID === item.linenId);
            list.innerHTML += `
                <li style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.05);">
                    <span><span style="color:var(--primary);">${item.linenId}</span> <small>(${l ? l.Name : '?'})</small></span>
                    <span class="badge bg-warning">${item.newStatus}</span>
                </li>`;
        });
    }
};

const StockOpname = {
    add: function() {
        const id = document.getElementById('op-scan').value.trim();
        if(!id) return;
        const l = State.data.linen.find(x => x.LinenID === id);
        const name = l ? l.Name : 'Unknown Item';
        
        State.opnameList.push({ 
            linenId: id, 
            linenName: name, 
            unit: document.getElementById('op-unit').value, 
            physicalCount: 1,
            notes: document.getElementById('op-condition').value
        });
        this.render();
        document.getElementById('op-scan').value = '';
        document.getElementById('op-scan').focus();
    },
    submit: function() {
        if(State.opnameList.length === 0) return UI.showToast("List empty", 'warning');
        Data.post('submit_stock_opname', { 
            items: State.opnameList, 
            unit: 'LAUNDRY', // Default unit if specific unit not scanned per item
            auditor: State.user.name 
        })
        .then(() => { State.opnameList = []; this.render(); });
    },
    render: function() {
        const tbody = document.querySelector('#table-opname');
        tbody.innerHTML = '';
        State.opnameList.forEach((item, idx) => {
            tbody.innerHTML += `<tr>
                <td>${item.linenId}</td>
                <td>${item.linenName}</td>
                <td>${item.unit}</td>
                <td>${item.notes}</td>
                <td><span class="badge bg-success">Pending</span></td>
            </tr>`;
        });
    }
};

const Chemical = {
    submit: function() {
        const totalKg = document.getElementById('c-kg-total').value;
        if(!totalKg) return UI.showToast("Enter Total KG", 'warning');
        
        Data.post({
            date: document.getElementById('c-date').value,
            shift: document.getElementById('c-shift').value,
            totalLinen: totalKg, 
            nonInfectionLinen: document.getElementById('c-kg-noninf').value,
            infectionLinen: document.getElementById('c-kg-inf').value,
            detergent_ml: document.getElementById('c-detergent').value || 0,
            disinfectant_ml: document.getElementById('c-disinfectant').value || 0,
            alkali_ml: document.getElementById('c-alkali').value || 0,
            softener_ml: document.getElementById('c-softener').value || 0,
            lpg: document.getElementById('c-lpg').value, 
            operator: State.user.name
        });
    }
};

const Maintenance = {
    submit: function() {
        Data.post({
            machineName: document.getElementById('m-machine').value,
            issueDescription: document.getElementById('m-desc').value,
            status: 'REPORTED',
            reportedBy: State.user.name
        });
    },
    populateMachines: function() {
        const sel = document.getElementById('m-machine');
        sel.innerHTML = '<option value="">Select Machine...</option>';
        State.data.machines.forEach(m => {
            sel.innerHTML += `<option value="${m.Name}">${m.Name} (${m.Status})</option>`;
        });
    }
};

const Handover = {
    addLine: function() {
        const id = document.getElementById('ho-id').value;
        const qty = document.getElementById('ho-qty').value;
        const cond = document.getElementById('ho-cond').value;
        if(!id || !qty) return UI.showToast("Fill ID & Qty", 'warning');

        State.handoverList.push({ linenId: id, quantity: qty, condition: cond });
        this.render();
        document.getElementById('ho-id').value = '';
        document.getElementById('ho-id').focus();
    },
    submit: function() {
        if(State.handoverList.length === 0) return UI.showToast("List empty", 'warning');
        
        // Assuming handling one item for now based on UI
        const item = State.handoverList[0]; 
        
        Data.post({
            fromUnit: document.getElementById('ho-from').value,
            toUnit: document.getElementById('ho-to').value,
            linenId: item.linenId,
            linenName: "Scanned Item", // Backend will resolve name if needed
            quantity: item.quantity,
            condition: item.condition,
            handoverTime: new Date().toLocaleTimeString()
        }).then(() => { State.handoverList = []; this.render(); });
    },
    render: function() {
        const tbody = document.querySelector('#table-handover');
        tbody.innerHTML = '';
        State.handoverList.forEach((item, idx) => {
            tbody.innerHTML += `<tr>
                <td>${item.linenId}</td>
                <td>${item.quantity}</td>
                <td>${item.condition}</td>
                <td><button class="btn btn-danger" style="padding:2px 6px; font-size:0.7rem;" onclick="Handover.remove(${idx})">X</button></td>
            </tr>`;
        });
    },
    remove: function(idx) {
        State.handoverList.splice(idx, 1);
        this.render();
    }
};

const MasterData = {
    add: function() {
        Data.post({
            name: document.getElementById('nl-name').value,
            type: document.getElementById('nl-type').value,
            unitOrigin: document.getElementById('nl-origin').value,
            currentLocation: document.getElementById('nl-loc').value,
            maxCycle: document.getElementById('nl-maxcycle').value,
            unitCost: document.getElementById('nl-cost').value,
            quantity: document.getElementById('nl-qty').value
        });
    }
};

// --- APP CONTROLLER ---
const App = {
    nav: function(id) {
        document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden'));
        document.getElementById('view-' + id).classList.remove('hidden');
        
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        if(event && event.currentTarget) event.currentTarget.classList.add('active');

        if(id === 'maintenance') Maintenance.populateMachines();
        if(id === 'dashboard') this.render(); 
    },
    render: function() {
        // Dashboard Stats
        const linens = State.data.linen || [];
        document.getElementById('dash-linen').innerText = linens.length;
        document.getElementById('dash-critical').innerText = linens.filter(l => l.HealthStatus === 'CRITICAL').length;
        document.getElementById('dash-maint').innerText = State.data.maintenance.filter(m => m.Status === 'REPORTED' || m.Status === 'IN_PROGRESS').length;
        
        // Chemical Check
        const chems = State.data.chemicals || [];
        const lowStock = chems.filter(c => parseFloat(c.StockQuantity) <= parseFloat(c.MinimumStock)).length;
        const chemBadge = document.getElementById('dash-chem');
        chemBadge.innerText = lowStock > 0 ? 'LOW' : 'OK';
        chemBadge.style.color = lowStock > 0 ? 'var(--danger)' : 'var(--success)';

        // Chart
        if(window.myChart) window.myChart.destroy();
        const ctx = document.getElementById('dashChart').getContext('2d');
        window.myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Ready', 'Washing', 'Critical', 'Damaged'],
                datasets: [{
                    data: [
                        linens.filter(l => l.Status === 'READY').length,
                        linens.filter(l => l.Status === 'WASHING').length,
                        linens.filter(l => l.HealthStatus === 'CRITICAL').length,
                        linens.filter(l => l.Status === 'DAMAGED').length
                    ],
                    backgroundColor: ['#10b981', '#3b82f6', '#ef4444', '#f59e0b'],
                    borderWidth: 0
                }]
            },
            options: { 
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { position: 'right', labels: { color: '#94a3b8' } } } 
            }
        });

        // Recent Activity Table
        const tbody = document.querySelector('#dash-recent-table tbody');
        tbody.innerHTML = '';
        (State.data.transactions || []).slice(0, 5).forEach(t => {
            const time = t.Timestamp ? new Date(t.Timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '-';
            tbody.innerHTML += `<tr><td>${time}</td><td>${t.TransactionType || 'SCAN'}</td><td>${t.User || 'Sys'}</td></tr>`;
        });

        // Chemical Inventory Table
        const chemBody = document.querySelector('#chem-inventory-table tbody');
        chemBody.innerHTML = '';
        chems.forEach(c => {
            let status = 'OK';
            const stock = parseFloat(c.StockQuantity || 0);
            const min = parseFloat(c.MinimumStock || 0);
            if(stock <= min) status = 'LOW';
            chemBody.innerHTML += `<tr><td>${c.ChemicalName}</td><td>${stock.toFixed(1)} ${c.Unit || 'L'}</td><td><span class="badge ${status==='LOW'?'bg-danger':'bg-success'}">${status}</span></td></tr>`;
        });

        // Maintenance Table
        const maintBody = document.querySelector('#maint-table tbody');
        maintBody.innerHTML = '';
        State.data.maintenance.forEach(m => {
            maintBody.innerHTML += `<tr><td>${new Date(m.ReportDate).toLocaleDateString()}</td><td>${m.MachineName}</td><td>${m.IssueDescription}</td><td><span class="badge bg-warning">${m.Status}</span></td></tr>`;
        });
    },
    initClock: function() {
        setInterval(() => {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }, 1000);
    }
};

// --- UI UTILS ---
const UI = {
    showLoading: function(show) {
        document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
    },
    showToast: function(msg, type='info') {
        const container = document.getElementById('toast-container');
        const el = document.createElement('div');
        el.className = `toast ${type}`;
        el.innerHTML = `<span>${msg}</span> <i class="fas fa-times" style="cursor:pointer;" onclick="this.parentElement.remove()"></i>`;
        container.appendChild(el);
        setTimeout(() => { if(el.parentElement) el.remove(); }, 4000);
    },
    toggleSidebar: function() {
        document.getElementById('sidebar').classList.toggle('active');
    },
    closeSidebarOnMobile: function(e) {
        const sidebar = document.getElementById('sidebar');
        const btn = document.querySelector('.mobile-header button');
        if (window.innerWidth <= 900 && 
            sidebar.classList.contains('active') && 
            !sidebar.contains(e.target) && 
            !btn.contains(e.target)) {
            sidebar.classList.remove('active');
        }
    }
};

// --- INITIALIZATION ---
window.onload = function() {
    // Check if Script URL is configured
    if(CONFIG.SCRIPT_URL.includes("PASTE")) {
        alert("PERHATIAN: Anda belum memasukkan URL Deployment Google Script di file HTML ini (Line ~500). Silakan edit file ini dan masukkan URL yang benar.");
    }

    Auth.checkSession();
    App.initClock();
    
    // Set default date inputs
    const today = new Date().toISOString().slice(0,10);
    document.querySelectorAll('input[type="date"]').forEach(i => i.value = today);

    // Login Form Handler
    document.getElementById('loginForm').addEventListener('submit', (e) => { 
        e.preventDefault(); 
        Auth.login(document.getElementById('username').value, document.getElementById('password').value); 
    });
    
    // Enter key listeners for scan inputs
    document.getElementById('wf-scan').addEventListener('keypress', e => { if(e.key==='Enter') Workflow.submit(); });
    document.getElementById('op-scan').addEventListener('keypress', e => { if(e.key==='Enter') StockOpname.add(); });
};
</script>
</body>
</html>
