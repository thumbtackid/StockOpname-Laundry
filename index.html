<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RS Charlie Laundry System</title>
    
    <!-- LIBRARIES -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

    <style>
        :root {
            --primary: #0ea5e9; --dark: #0f172a; --bg: #f8fafc; --surface: #ffffff;
            --border: #e2e8f0; --danger: #ef4444; --success: #22c55e; --warning: #f59e0b;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--dark); height: 100vh; overflow: hidden; font-size: 14px; }

        .app-container { display: grid; grid-template-columns: 260px 1fr; height: 100vh; }
        .sidebar { background: var(--surface); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 20; }
        .main-content { overflow-y: auto; height: 100%; padding: 20px; display: flex; flex-direction: column; }
        
        .nav-item { padding: 12px 20px; color: #64748b; cursor: pointer; display: flex; align-items: center; gap: 12px; border-radius: 8px; transition: 0.2s; margin-bottom: 2px; }
        .nav-item:hover, .nav-item.active { background: #f0f9ff; color: var(--primary); font-weight: 600; }
        
        .card { background: var(--surface); border-radius: 12px; border: 1px solid var(--border); padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .btn { padding: 10px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; font-size: 13px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--dark); }
        .btn:hover { opacity: 0.9; }
        
        input, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; font-family: inherit; }
        
        .kanban { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px; padding-bottom: 10px; overflow-x: auto; }
        .kanban-col { background: #f1f5f9; border-radius: 12px; padding: 15px; border: 1px solid var(--border); min-height: 200px; display: flex; flex-direction: column; }
        .kanban-cards { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        
        .l-card { background: white; padding: 12px; border-radius: 8px; border: 1px solid var(--border); cursor: pointer; transition: 0.2s; border-left: 4px solid transparent; font-size: 13px; }
        .l-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .l-card.dirty { border-left-color: var(--danger); }
        .l-card.process { border-left-color: var(--warning); }
        .l-card.ready { border-left-color: var(--success); }
        .l-card.alert { border-left-color: #8b5cf6; background: #fff1f2; }

        #login-screen { position: fixed; inset: 0; background: linear-gradient(135deg, var(--primary), #3b82f6); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .login-box { background: white; padding: 40px; border-radius: 16px; width: 100%; max-width: 380px; text-align: center; box-shadow: 0 20px 25px rgba(0,0,0,0.2); }
        .hidden { display: none !important; }
        
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 100; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; }

        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: #f8fafc; color: #64748b; font-weight: 600; text-transform: uppercase; font-size: 11px; }
        
        .toast { position: fixed; bottom: 20px; right: 20px; background: #333; color: white; padding: 12px 20px; border-radius: 8px; z-index: 10000; animation: slide 0.3s; }
        @keyframes slide { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .error-box { position: fixed; inset: 0; background: white; z-index: 2000; display: flex; align-items: center; justify-content: center; flex-direction: column; text-align: center; padding: 50px; }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-screen">
        <div class="login-box">
            <h2 style="color: var(--primary); margin-bottom: 20px;">RS Charlie Laundry</h2>
            <form id="loginForm">
                <input type="text" id="username" placeholder="Username" required>
                <input type="password" id="password" placeholder="Password" required>
                <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center; margin-bottom: 10px;">MASUK</button>
            </form>
            <p style="color: #94a3b8; font-size: 12px; margin-bottom: 10px;">atau</p>
            <button class="btn btn-outline" style="width: 100%; justify-content: center;" onclick="UI.openModal('regModal')">DAFTAR AKUN BARU</button>
        </div>
    </div>

    <!-- APP -->
    <div class="app-container hidden" id="app">
        <nav class="sidebar">
            <div style="padding: 20px; border-bottom: 1px solid var(--border);">
                <h3 style="color: var(--primary);">Laundry Pro</h3>
            </div>
            <div style="padding: 10px;">
                <div class="nav-item active" onclick="App.nav('workflow')"><i class="fas fa-columns"></i> Workflow</div>
                <div class="nav-item" onclick="App.nav('inventory')"><i class="fas fa-boxes"></i> Inventory</div>
                <div class="nav-item" onclick="App.nav('machines')"><i class="fas fa-cogs"></i> Mesin</div>
                <div id="adminMenu" class="hidden" style="margin-top: 20px; border-top: 1px solid var(--border); padding-top: 10px;">
                    <small style="color: #94a3b8; padding: 0 20px;">ADMIN AREA</small>
                    <div class="nav-item" onclick="App.nav('admin')"><i class="fas fa-users-cog"></i> User Management</div>
                </div>
            </div>
            <div style="margin-top: auto; padding: 20px; border-top: 1px solid var(--border);">
                <div id="userInfo" class="font-bold text-primary">User</div>
                <button class="btn btn-outline" style="width: 100%; margin-top: 10px;" onclick="location.reload()">Logout</button>
            </div>
        </nav>

        <main class="main-content">
            <!-- VIEW: WORKFLOW -->
            <div id="view-workflow">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Live Workflow</h2>
                    <button class="btn btn-primary btn-sm" onclick="App.refresh()"><i class="fas fa-sync"></i> Refresh</button>
                </div>
                
                <div class="kanban">
                    <div class="kanban-col">
                        <div style="font-weight: 700; margin-bottom: 10px; display: flex; justify-content: space-between;">
                            <span style="color: var(--danger);"><i class="fas fa-inbox"></i> INBOUND</span>
                            <span id="c-inbound" class="badge bg-red">0</span>
                        </div>
                        <div id="k-inbound" class="kanban-cards"></div>
                    </div>
                    
                    <div class="kanban-col">
                        <div style="font-weight: 700; margin-bottom: 10px; display: flex; justify-content: space-between;">
                            <span style="color: var(--warning);"><i class="fas fa-tshirt"></i> PROCESS</span>
                            <span id="c-process" class="badge bg-yellow">0</span>
                        </div>
                        <div id="k-process" class="kanban-cards"></div>
                    </div>

                    <div class="kanban-col">
                        <div style="font-weight: 700; margin-bottom: 10px; display: flex; justify-content: space-between;">
                            <span style="color: var(--success);"><i class="fas fa-check-circle"></i> OUTBOUND</span>
                            <span id="c-outbound" class="badge bg-green">0</span>
                        </div>
                        <div id="k-outbound" class="kanban-cards"></div>
                    </div>
                    
                    <div class="kanban-col" style="background: #fff1f2;">
                        <div style="font-weight: 700; margin-bottom: 10px; color: #be123c;">
                            <i class="fas fa-exclamation-triangle"></i> ALERTS
                        </div>
                        <div id="k-alert" class="kanban-cards"></div>
                    </div>
                </div>
            </div>

            <!-- VIEW: INVENTORY -->
            <div id="view-inventory" class="hidden">
                <div class="card">
                    <h3>Inventory & Chemical</h3>
                    <table>
                        <thead><tr><th>Item</th><th>Kategori</th><th>Stok</th><th>Unit</th><th>Status</th></tr></thead>
                        <tbody id="invTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- VIEW: MACHINES -->
            <div id="view-machines" class="hidden">
                <div class="card">
                    <h3>Status Mesin</h3>
                    <table>
                        <thead><tr><th>ID</th><th>Nama</th><th>Kapasitas</th><th>Status</th><th>Action</th></tr></thead>
                        <tbody id="machTableBody"></tbody>
                    </table>
                </div>
            </div>

             <!-- VIEW: ADMIN -->
             <div id="view-admin" class="hidden">
                <div class="card">
                    <h3>Manajemen User</h3>
                    <table>
                        <thead><tr><th>Username</th><th>Nama</th><th>Role</th><th>Status</th><th>Aksi</th></tr></thead>
                        <tbody id="userTableBody"></tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <!-- MODAL ACTION -->
    <div class="modal" id="actionModal">
        <div class="modal-content">
            <h3 id="actTitle">Aksi Linen</h3>
            <p id="actInfo" style="color: #64748b; margin-bottom: 15px;"></p>
            <div id="actForm"></div>
            <div style="text-align: right; margin-top: 20px;">
                <button class="btn btn-outline" onclick="UI.closeModal('actionModal')">Batal</button>
                <button class="btn btn-primary" id="btnActSubmit">Proses</button>
            </div>
        </div>
    </div>

    <!-- MODAL REGISTER -->
    <div class="modal" id="regModal">
        <div class="modal-content">
            <h3>Daftar Akun</h3>
            <input type="text" id="regUser" placeholder="Username">
            <input type="text" id="regName" placeholder="Nama Lengkap">
            <input type="password" id="regPass" placeholder="Password">
            <div style="text-align: right; margin-top: 20px;">
                <button class="btn btn-outline" onclick="UI.closeModal('regModal')">Batal</button>
                <button class="btn btn-primary" onclick="Auth.register()">Daftar</button>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <script>
        const CONFIG = {
            // GANTI DENGAN URL DARI LANGKAH 1
            SCRIPT_URL: "https://script.google.com/macros/s/AKfycbxL3d88GrbIv7iCpJu_IR2JPvV-SNmuUnxNPuwimlJe43XjV43wHnFuNECParQw3sPOFQ/exec"
        };

        const State = { user: null, data: {} };

        // API
        const API = {
            post: async function(action, data) {
                UI.loading(true);
                try {
                    const res = await fetch(CONFIG.SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action, ...data })
                    });
                    return await res.json();
                } catch (err) {
                    console.error("Error:", err);
                    return { status: 'error', message: 'Koneksi Gagal: ' + err.message };
                } finally {
                    UI.loading(false);
                }
            }
        };

        // AUTH
        const Auth = {
            login: async function(e) {
                e.preventDefault();
                const u = $('#username').val();
                const p = $('#password').val();
                if(!u || !p) return UI.toast("Isi username & password", "warning");

                const res = await API.post('login', { username: u, password: p });
                
                if (res.status === 'success') {
                    State.user = res.user;
                    UI.toast("Selamat Datang", "success");
                    $('#login-screen').hide();
                    $('#app').show();
                    $('#userInfo').text(res.user.name);
                    if(res.user.role === 'Admin') $('#adminMenu').removeClass('hidden');
                    App.loadData();
                } else {
                    UI.toast(res.message || "Login Gagal", "error");
                }
            },
            register: async function() {
                const u = $('#regUser').val(), n = $('#regName').val(), p = $('#regPass').val();
                if(!u || !n || !p) return UI.toast("Lengkapi data", "warning");
                const res = await API.post('register', { username: u, fullname: n, password: p });
                UI.toast(res.message, res.status === 'success' ? 'success' : 'error');
                if(res.status === 'success') { UI.closeModal('regModal'); $('#regUser').val(''); $('#regName').val(''); $('#regPass').val(''); }
            }
        };

        // WORKFLOW
        const Workflow = {
            click: function(id, status) {
                State.actItem = { id, status };
                const form = $('#actForm'); form.html('');
                $('#actTitle').text(id);
                $('#actInfo').text(`Status: ${status}`);

                let html = '';
                const s = String(status).toUpperCase();
                if(s.includes('DIRTY') || s.includes('RECEIVED')) {
                    html += `<button class="btn btn-primary" style="width:100%; margin-bottom:10px;" onclick="Workflow.conf('WASHING')">Mulai Cuci</button>`;
                    html += `<button class="btn btn-outline" style="width:100%;" onclick="Workflow.conf('DAMAGED')">Lapor Rusak</button>`;
                } else if (s.includes('WASHING') || s.includes('FINISHING')) {
                    html += `<button class="btn btn-primary" style="width:100%; margin-bottom:10px;" onclick="Workflow.conf('READY')">Selesai Cuci</button>`;
                } else if(s.includes('READY')) {
                    html += `<select id="distUnit"><option value="">Pilih Unit...</option></select>`;
                    html += `<button class="btn btn-success" style="width:100%; margin-top:10px;" onclick="Workflow.conf('CLEAN')">Kirim ke Unit</button>`;
                }

                form.html(html);
                if(s.includes('READY')) {
                    const opts = (State.data.units || []).map(u => `<option value="${u.UnitCode}">${u.UnitName}</option>`).join('');
                    $('#distUnit').append(opts);
                }
                UI.openModal('actionModal');
            },
            conf: async function(nextStatus) {
                const payload = {
                    linenIds: [State.actItem.id],
                    toStatus: nextStatus,
                    operator: State.user.name
                };

                if(nextStatus === 'WASHING') {
                    const machines = (State.data.machines || []).filter(m => String(m.Status).toUpperCase().includes('IDLE'));
                    if(machines.length === 0) return UI.toast("Tidak ada mesin kosong!", "error");
                    
                    const mId = prompt("Pilih Mesin ID:\n" + machines.map(m=>`${m.MachineID} - ${m.Name}`).join('\n'), machines[0].MachineID);
                    if(!mId) return;
                    payload.machineId = mId;
                } else if (nextStatus === 'CLEAN') {
                    const uCode = $('#distUnit').val();
                    if(!uCode) return UI.toast("Pilih Unit Tujuan!", "warning");
                    payload.targetUnit = uCode;
                }

                const res = await API.post('process_workflow', payload);
                UI.toast(res.message, res.status === 'success' ? 'success' : 'error');
                if(res.status === 'success') { UI.closeModal('actionModal'); App.loadData(); }
            }
        };

        // CONTROLLER
        const App = {
            nav: function(id) {
                $('div[id^="view-"]').hide();
                $(`#view-${id}`).show();
                $('.nav-item').removeClass('active');
                $(event.currentTarget).addClass('active');
            },
            refresh: function() { this.loadData(); },
            loadData: async function() {
                const res = await API.post('get_all_data');
                if(res.status === 'success') {
                    State.data = res.data;
                    this.render();
                } else {
                    UI.toast("Gagal Load Data", "error");
                }
            },
            render: function() {
                const l = State.data.linen || [];
                
                // Render Kanban
                const renderCard = (id, data, cls) => {
                    const el = $(`#${id}`); el.html('');
                    if(data.length === 0) el.html('<p style="text-align:center;color:#999;font-size:12px;padding:10px;">Kosong</p>');
                    data.forEach(d => {
                        const safeName = (d.Name || '').replace(/'/g, "&#39;");
                        const safeStatus = (d.CurrentStatus || '').replace(/'/g, "&#39;");
                        el.append(`<div class="l-card ${cls}" onclick="Workflow.click('${d.LinenID}','${safeStatus}')"><b>${d.LinenID}</b><br><small>${safeName}</small></div>`);
                    });
                };

                const dirty = l.filter(x => ['DIRTY','RECEIVED'].includes(x.CurrentStatus));
                const proc = l.filter(x => ['WASHING'].includes(x.CurrentStatus));
                const out = l.filter(x => ['READY','CLEAN'].includes(x.CurrentStatus));
                const alert = l.filter(x => ['DAMAGED'].includes(x.CurrentStatus));

                renderCard('k-inbound', dirty, 'dirty');
                renderCard('k-process', proc, 'process');
                renderCard('k-outbound', out, 'ready');
                renderCard('k-alert', alert, 'alert');

                $('#c-inbound').text(dirty.length);
                $('#c-process').text(proc.length);
                $('#c-outbound').text(out.length);

                // Render Tables (Safe Check)
                if(State.data.inventory) {
                    $('#invTableBody').html(State.data.inventory.map(x => `
                        <tr>
                            <td>${x.ItemName}</td><td>${x.Category}</td>
                            <td class="${x.Stock < x.MinStock ? 'text-red font-bold' : ''}">${x.Stock}</td>
                            <td>${x.Unit}</td>
                            <td>${x.Stock < x.MinStock ? 'LOW' : 'OK'}</td>
                        </tr>
                    `).join(''));
                }

                if(State.data.machines) {
                    $('#machTableBody').html(State.data.machines.map(x => `
                        <tr>
                            <td>${x.MachineID}</td><td>${x.Name}</td><td>${x.Capacity}</td>
                            <td><span class="badge ${String(x.Status).toUpperCase().includes('RUNNING')?'bg-blue':'bg-green'}">${x.Status}</span></td>
                            <td><button class="btn btn-sm btn-outline">Log</button></td>
                        </tr>
                    `).join(''));
                }

                if(State.data.users) {
                    $('#userTableBody').html(State.data.users.map(u => `
                        <tr>
                            <td>${u.Username}</td><td>${u.Fullname}</td><td>${u.Role}</td><td>${u.Status}</td>
                            <td>${u.Status==='Pending' ? '<button class="btn btn-sm btn-primary" onclick="approveUser(\''+u.Username+'\')">Approve</button>' : '-'}</td>
                        </tr>
                    `).join(''));

                    // Populate Select Unit
                    $('#distUnit').html('<option value="">-- Pilih Unit --</option>' + (State.data.units || []).map(u => `<option value="${u.UnitCode}">${u.UnitName}</option>`).join(''));
                }
            }
        };

        const approveUser = async function(username) {
            if(!confirm("Setujui user ini?")) return;
            const res = await API.post('approve_user', { targetUsername: username });
            UI.toast(res.message, res.status === 'success' ? 'success' : 'error');
            if(res.status === 'success') App.loadData();
        };

        // UTILS
        const UI = {
            loading: function(show) { if(show) $('body').css('cursor', 'wait'); else $('body').css('cursor', 'default'); },
            toast: function(msg, type) { 
                const c=$('#toast'); if(c.length) c.remove();
                const c2=document.createElement('div');
                c2.className='toast';
                c2.style.cssText=`position:fixed;bottom:20px;right:20px;background:${type==='error'?'#ef4444':type==='success'?'#22c55e':'#f59e0b'};color:white;padding:12px 20px;border-radius:8px;z-index:10000;animation:slide 0.3s;`;
                c2.innerText=msg; document.body.appendChild(c2); setTimeout(()=>c2.remove(),3000);
            },
            openModal: function(id) { $(`#${id}`).addClass('active'); },
            closeModal: function(id) { $(`#${id}`).removeClass('active'); }
        };

        // INIT
        State.actItem = null;
        $(document).ready(function() {
            $('#loginForm').on('submit', Auth.login);
        });
    </script>
</body>
</html>
