<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RS Laundry Intelligence OS</title>
    <!-- Font & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #0f172a; --bg-card: #1e293b; --text-main: #f8fafc; --text-muted: #94a3b8;
            --primary: #3b82f6; --primary-glow: rgba(59, 130, 246, 0.5);
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
            --glass: rgba(30, 41, 59, 0.7);
            --border: rgba(255,255,255,0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Inter', sans-serif; background: var(--bg-dark); color: var(--text-main);
            font-size: 13px; height: 100vh; overflow: hidden;
        }

        h1, h2, h3, .brand-font { font-family: 'Rajdhani', sans-serif; text-transform: uppercase; letter-spacing: 1px; }

        /* LOGIN SCREEN */
        #login-screen {
            position: fixed; inset: 0; background: linear-gradient(135deg, #020617, #172554);
            z-index: 9999; display: flex; justify-content: center; align-items: center;
            background-image: radial-gradient(circle at 50% 50%, rgba(59, 130, 246, 0.15), transparent 50%);
        }
        .login-box {
            width: 90%; max-width: 360px; background: rgba(15, 23, 42, 0.8); border: 1px solid var(--border);
            backdrop-filter: blur(20px); padding: 30px; border-radius: 16px; text-align: center;
            box-shadow: 0 0 40px rgba(59, 130, 246, 0.2);
        }

        /* LAYOUT */
        .app-layout { display: grid; grid-template-columns: 260px 1fr; height: 100vh; }

        /* Sidebar */
        .sidebar {
            background: var(--bg-card); border-right: 1px solid var(--border); display: flex;
            flex-direction: column; padding: 20px 0;
        }
        .brand { padding: 0 24px 20px; font-size: 1.4rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 10px; }

        .nav-item {
            padding: 12px 24px; color: var(--text-muted); display: flex; align-items: center; gap: 12px;
            cursor: pointer; transition: 0.3s; border-left: 3px solid transparent;
        }
        .nav-item:hover, .nav-item.active {
            background: rgba(59, 130, 246, 0.1); color: var(--primary); border-left-color: var(--primary);
        }
        .nav-group { padding: 15px 24px 5px; font-size: 0.7rem; color: #64748b; font-weight: 700; letter-spacing: 1px; }

        /* Main Content */
        .main-content { padding: 24px; overflow-y: auto; height: 100%; position: relative; }

        /* Components */
        .card {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px;
            padding: 20px; margin-bottom: 20px; position: relative; overflow: hidden;
        }
        .card::before {
            content:''; position: absolute; top:0; left:0; width:4px; height:100%;
            background: var(--border); transition: 0.3s;
        }
        .card:hover::before { background: var(--primary); box-shadow: 2px 0 10px var(--primary-glow); }

        .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }

        .stat-value { font-size: 2rem; font-weight: 700; font-family: 'Rajdhani'; margin: 5px 0; }
        .stat-label { color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; }
        .trend-up { color: var(--success); font-size: 0.8rem; }
        .trend-down { color: var(--danger); font-size: 0.8rem; }

        /* Forms */
        input, select, textarea {
            width: 100%; background: rgba(0,0,0,0.2); border: 1px solid var(--border);
            color: white; padding: 12px; border-radius: 8px; font-family: inherit; margin-bottom: 10px;
        }
        input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 2px rgba(59,130,246,0.2); }

        .btn {
            background: var(--primary); color: white; border: none; padding: 12px 20px;
            border-radius: 8px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;
            transition: 0.2s;
        }
        .btn:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .btn-outline { background: transparent; border: 1px solid var(--border); }
        .btn-danger { background: var(--danger); }

        /* Tables */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; color: var(--text-muted); font-size: 0.75rem; border-bottom: 1px solid var(--border); }
        td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }

        /* Badges */
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .bg-success { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .bg-warning { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .bg-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .bg-info { background: rgba(59, 130, 246, 0.2); color: var(--primary); }

        /* Utilities */
        .hidden { display: none !important; }
        .flex { display: flex; align-items: center; gap: 10px; }

        #loading-overlay {
            position: fixed; inset: 0; background: rgba(15,23,42,0.9); z-index: 5000;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }
        .scanner-line {
            width: 200px; height: 2px; background: var(--success);
            box-shadow: 0 0 10px var(--success); animation: scan 2s infinite;
        }
        @keyframes scan { 0% { width: 0; opacity: 0; } 50% { width: 200px; opacity: 1; } 100% { width: 0; opacity: 0; margin-left: 200px; } }

        /* Mobile */
        @media (max-width: 768px) {
            .app-layout { grid-template-columns: 1fr; }
            .sidebar { position: fixed; left: -260px; top: 0; bottom: 0; z-index: 1000; transition: 0.3s; }
            .sidebar.active { left: 0; }
            .mobile-header { display: flex !important; justify-content: space-between; padding: 15px; background: var(--bg-dark); border-bottom: 1px solid var(--border); }
        }
        @media (min-width: 769px) { .mobile-header { display: none; } }
    </style>
</head>
<body>

<!-- LOADING -->
<div id="loading-overlay">
    <div class="scanner-line"></div>
    <p style="margin-top:20px; letter-spacing: 2px;">SYNCING DATA...</p>
</div>

<!-- LOGIN -->
<section id="login-screen">
    <div class="login-box">
        <div style="font-size: 3rem; color: var(--primary); margin-bottom: 10px;"><i class="fas fa-dna"></i></div>
        <h1 style="margin-bottom: 5px;">RS Laundry OS</h1>
        <p style="color: var(--text-muted); margin-bottom: 30px; font-size: 0.9rem;">INTELLIGENT ASSET MANAGEMENT</p>

        <form id="loginForm">
            <input type="text" id="username" placeholder="NIP / Username" required>
            <input type="password" id="password" placeholder="Password" required>
            <button type="submit" class="btn" style="width: 100%; justify-content: center;">AUTHENTICATE</button>
        </form>
        <p style="margin-top: 20px; font-size: 0.7rem; color: var(--text-muted);">SECURE CONNECTION // ENCRYPTED</p>
    </div>
</section>

<!-- APP INTERFACE -->
<div class="app-layout hidden" id="main-app">
    <!-- Mobile Header -->
    <div class="mobile-header">
        <button class="btn-outline" style="border:none; color:white; padding:0;" onclick="toggleSidebar()"><i class="fas fa-bars fa-lg"></i></button>
        <span style="font-weight:700;">LAUNDRY OS</span>
        <i class="fas fa-user-circle fa-lg"></i>
    </div>

    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <div class="brand"><i class="fas fa-dna"></i> LAUNDRY OS</div>

        <div class="nav-group">MONITORING</div>
        <div class="nav-item active" onclick="App.nav('dashboard')"><i class="fas fa-chart-pie"></i> Executive Dashboard</div>
        <div class="nav-item" onclick="App.nav('live-track')"><i class="fas fa-satellite-dish"></i> Live Tracking</div>

        <div class="nav-group">OPERATIONS</div>
        <div class="nav-item" onclick="App.nav('workflow')"><i class="fas fa-random"></i> Workflow Scan</div>
        <div class="nav-item" onclick="App.nav('opname')"><i class="fas fa-clipboard-check"></i> Stock Opname (Audit)</div>

        <div class="nav-group">INTELLIGENCE</div>
        <div class="nav-item" onclick="App.nav('forensic')"><i class="fas fa-search-location"></i> Forensic Audit</div>
        <div class="nav-item" onclick="App.nav('prediction')"><i class="fas fa-brain"></i> AI Prediction</div>

        <div style="margin-top: auto; padding: 20px;">
            <div style="font-size: 0.7rem; color: var(--text-muted);">LOGGED IN AS:</div>
            <div id="user-display" style="font-weight: 600;">-</div>
            <div id="role-display" style="color: var(--primary); font-size: 0.8rem; margin-bottom: 10px;">-</div>
            <button class="btn btn-danger" style="width: 100%; justify-content: center;" onclick="Auth.logout()"><i class="fas fa-power-off"></i> LOGOUT</button>
        </div>
    </nav>

    <!-- Main View -->
    <main class="main-content">

        <!-- DASHBOARD -->
        <section id="view-dashboard" class="view-section">
            <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Executive Dashboard</h2>
                <span class="badge bg-info" id="clock">00:00</span>
            </header>

            <div class="grid-4">
                <div class="card">
                    <div class="stat-label">Total Asset Value</div>
                    <div class="stat-value">Rp 2.4M</div>
                    <div class="trend-up"><i class="fas fa-arrow-up"></i> Stable</div>
                </div>
                <div class="card">
                    <div class="stat-label">Active Linen</div>
                    <div class="stat-value" id="dash-active">0</div>
                    <div class="stat-label">Operational</div>
                </div>
                <div class="card">
                    <div class="stat-label">Critical Loss (YTD)</div>
                    <div class="stat-value" style="color: var(--danger);" id="dash-loss">0</div>
                    <div class="stat-label">Items Missing</div>
                </div>
                <div class="card">
                    <div class="stat-label">Avg Lifecycle</div>
                    <div class="stat-value">42<span style="font-size:1rem;">/50</span></div>
                    <div class="trend-down"><i class="fas fa-arrow-down"></i> Optimized</div>
                </div>
            </div>

            <div class="card" style="margin-top: 20px;">
                <h3 style="margin-bottom: 15px;"><i class="fas fa-exclamation-triangle text-warning"></i> Critical Alerts</h3>
                <ul id="dashboard-alerts" style="list-style: none; padding-left: 0;"></ul>
            </div>
        </section>

        <!-- WORKFLOW -->
        <section id="view-workflow" class="view-section hidden">
            <h2>Workflow Processing</h2>
            <p class="text-muted" style="margin-bottom: 20px;">Scan linen untuk update status dan lifecycle secara real-time.</p>

            <div class="card">
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <div style="flex: 2; min-width: 200px;">
                        <label>SCAN LINEN (QR/RFID)</label>
                        <input type="text" id="wf-scan" placeholder="Scan ID disini..." autofocus>
                    </div>
                    <div style="flex: 1; min-width: 150px;">
                        <label>ACTION</label>
                        <select id="wf-action">
                            <option value="WASHING">1. Start Washing</option>
                            <option value="DRYING">2. Drying Process</option>
                            <option value="READY">3. Ready / Clean</option>
                            <option value="DISTRIBUTED">4. Distributed to Unit</option>
                            <option value="DAMAGED">X. Report Damaged</option>
                        </select>
                    </div>
                    <div style="flex: 1; min-width: 120px; display: flex; align-items: flex-end;">
                        <button class="btn" style="width: 100%; justify-content: center;" onclick="Workflow.submit()">PROCESS</button>
                    </div>
                </div>
                <div id="wf-preview" style="margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px; display: none;">
                    <!-- Preview Item Scanned -->
                </div>
            </div>

            <div class="card">
                <h3>Recent Transactions</h3>
                <div style="overflow-x: auto;">
                    <table id="table-trans">
                        <thead><tr><th>Time</th><th>ID</th><th>Status</th><th>Handler</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- STOCK OPNAME (FORENSIC) -->
        <section id="view-opname" class="view-section hidden">
            <h2>Forensic Stock Opname</h2>
            <p class="text-muted">Investigasi selisih stok dan validasi fisik vs sistem.</p>

            <div class="card">
                <div class="grid-4">
                    <div>
                        <label>Select Unit</label>
                        <select id="op-unit"><option value="ICU">ICU</option><option value="OK">OK</option></select>
                    </div>
                    <div>
                        <label>Input Linen ID</label>
                        <input type="text" id="op-scan" placeholder="Scan...">
                    </div>
                    <div>
                        <label>Action</label>
                        <button class="btn btn-outline" onclick="StockOpname.addItem()">Add to List</button>
                    </div>
                    <div style="display: flex; align-items: flex-end;">
                        <button class="btn btn-danger" onclick="StockOpname.submit()">Submit Investigation</button>
                    </div>
                </div>

                <div style="margin-top: 15px; max-height: 200px; overflow-y: auto;">
                    <table id="table-opname">
                        <thead><tr><th>Linen ID</th><th>System Count</th><th>Physical Count</th><th>Diff</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- PREDICTION -->
        <section id="view-prediction" class="view-section hidden">
            <h2>AI & Intelligence</h2>
            <div class="card">
                <h3><i class="fas fa-chart-line"></i> Cost Projection (Next 6 Months)</h3>
                <div style="padding: 20px; text-align: center; color: var(--text-muted);">
                    [Chart Placeholder: Prediction of Linen Replacement Cost]
                </div>
            </div>
            <div class="card">
                <h3>Replacement Schedule</h3>
                <ul id="ai-replacement-list" style="list-style: none;"></ul>
            </div>
        </section>

    </main>
</div>

<script>
/**
 * RS LAUNDRY OS - FRONTEND CONTROLLER
 */

const CONFIG = {
    // GANTI DENGAN URL DEPLOYMENT APPS SCRIPT KAMU
    SCRIPT_URL: "https://script.google.com/macros/s/AKfycbxAcD8kfIbR-U_2DE98hwX-RNqoT3VR1ZSbAHCbPqIM6zsILjE_eqjBM71lGKToKXEvXw/exec"
};

const State = {
    user: null,
    data: { master: [], units: [], transactions: [], opnameList: [] }
};

// --- AUTH ---
const Auth = {
    login: async function(u, p) {
        UI.showLoading(true);
        try {
            const res = await fetch(CONFIG.SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'login', username: u, password: p })
            });
            const json = await res.json();

            if (json.status === 'success') {
                State.user = json.user;
                // Simpan sesi lokal (opsional untuk offline)
                AndroidNative.saveToLocal('user', JSON.stringify(json.user));
                this.success();
            } else {
                UI.showToast(json.message, 'error');
            }
        } catch (e) {
            UI.showToast("Connection Failed", 'error');
        }
        UI.showLoading(false);
    },
    success: function() {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        document.getElementById('user-display').innerText = State.user.name;
        document.getElementById('role-display').innerText = State.user.role.toUpperCase();
        Data.sync();
    },
    logout: function() {
        location.reload();
    }
};

// --- DATA ---
const Data = {
    sync: async function() {
        UI.showLoading(true);
        try {
            const res = await fetch(CONFIG.SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'get_initial_data' })
            });
            const json = await res.json();
            if (json.status === 'success') {
                State.data = json;
                App.renderDashboard();
                App.renderTransactions();
                UI.showToast("System Synced", 'success');
            }
        } catch (e) {
            UI.showToast("Sync Error (Check Internet)", 'warning');
        }
        UI.showLoading(false);
    },
    pushWorkflow: async function(scans) {
        UI.showLoading(true);
        try {
            const res = await fetch(CONFIG.SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'submit_workflow', scans: scans, user: State.user, location: 'LAUNDRY_PLANT' })
            });
            const json = await res.json();
            UI.showLoading(false);
            if (json.status === 'success') {
                UI.showToast("Workflow Processed & Logged", 'success');
                Data.sync(); // Refresh data
                return true;
            }
        } catch (e) {
            UI.showLoading(false);
            UI.showToast("Error Submitting", 'error');
        }
        return false;
    },
    pushOpname: async function(data) {
         UI.showLoading(true);
        try {
            const res = await fetch(CONFIG.SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'submit_stock_opname', items: data, unit: document.getElementById('op-unit').value, auditor: State.user.name, user: State.user.username })
            });
            const json = await res.json();
            UI.showLoading(false);
            if (json.status === 'success') {
                UI.showToast(`Audit Complete. ${json.discrepancies} Discrepancies Found.`, 'success');
                State.data.opnameList = [];
                App.renderOpnameTable();
                Data.sync();
            }
        } catch(e) { UI.showLoading(false); }
    }
};

// --- WORKFLOW ---
const Workflow = {
    queue: [],
    scan: function() {
        const input = document.getElementById('wf-scan');
        const id = input.value.trim();
        const action = document.getElementById('wf-action').value;

        if(!id) return;

        // Find linen in master
        const linen = State.data.master.find(l => l.LinenID === id);
        if (!linen) {
            UI.showToast(`Linen ID ${id} NOT FOUND in Master Data`, 'error');
            return;
        }

        // Preview
        const preview = document.getElementById('wf-preview');
        preview.style.display = 'block';
        preview.innerHTML = `
            <div class="flex">
                <div style="flex:1"><strong>${linen.LinenID}</strong><br><span style="color:var(--text-muted)">${linen.Name}</span></div>
                <div style="text-align:right;">
                    <span class="badge bg-info">${linen.Status}</span><br>
                    Cycle: ${linen.CycleCount}/${linen.MaxCycle}
                </div>
            </div>
        `;

        this.queue.push({ linenId: id, newStatus: action });
        input.value = '';
        input.focus();
    },
    submit: function() {
        if(this.queue.length === 0) return UI.showToast("No items scanned", 'warning');
        Data.pushWorkflow(this.queue).then(success => {
            if(success) {
                this.queue = [];
                document.getElementById('wf-preview').style.display = 'none';
            }
        });
    }
};

// --- STOCK OPNAME ---
const StockOpname = {
    list: [],
    addItem: function() {
        const id = document.getElementById('op-scan').value.trim();
        const linen = State.data.master.find(l => l.LinenID === id);
        if(!linen) return UI.showToast("Unknown Linen ID", 'error');

        // Logic: System assumes count is 1. Physical count is 1 (default) until changed?
        // For Forensic: We assume System=1. We scan it to say Physical=1. If we DON'T scan it, Physical=0 (Missing).
        // But here we are SCANNING existing items. Let's assume default Diff is 0.

        this.list.push({ linenId: id, systemCount: 1, physicalCount: 1, diff: 0 });
        this.render();
        document.getElementById('op-scan').value = '';
    },
    toggleDiff: function(idx) {
        // Simulate finding a discrepancy manually or auto-calc
        const item = this.list[idx];
        if (item.diff === 0) {
            item.physicalCount = 0; // Mark as MISSING
            item.diff = 1;
        } else {
            item.physicalCount = 1; // Restore
            item.diff = 0;
        }
        this.render();
    },
    submit: function() {
        if(this.list.length === 0) return UI.showToast("List is empty", 'warning');
        Data.pushOpname(this.list).then(() => {
            this.list = [];
            this.render();
        });
    },
    render: function() {
        const tbody = document.querySelector('#table-opname tbody');
        tbody.innerHTML = '';
        this.list.forEach((item, idx) => {
            const row = `<tr>
                <td>${item.linenId}</td>
                <td>${item.systemCount}</td>
                <td><span class="badge ${item.diff > 0 ? 'bg-danger' : 'bg-success'}">${item.physicalCount}</span></td>
                <td><button class="btn-outline" style="padding:2px 6px; font-size:10px;" onclick="StockOpname.toggleDiff(${idx})">Toggle Loss</button></td>
            </tr>`;
            tbody.innerHTML += row;
        });
    }
};

// --- APP ---
const App = {
    nav: function(id) {
        document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden'));
        document.getElementById('view-' + id).classList.remove('hidden');

        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        event.currentTarget.classList.add('active');
    },

    renderDashboard: function() {
        // Calculate Metrics
        const active = State.data.master.filter(l => l.Status === 'READY' || l.Status === 'IN_USE').length;
        const loss = State.data.master.filter(l => l.Status === 'MISSING').length;

        document.getElementById('dash-active').innerText = active;
        document.getElementById('dash-loss').innerText = loss;

        // Alerts Logic (Critical Items)
        const alerts = document.getElementById('dashboard-alerts');
        alerts.innerHTML = '';

        const critical = State.data.master.filter(l => l.HealthStatus && l.HealthStatus.includes('CRITICAL'));
        if(critical.length > 0) {
            critical.forEach(c => {
                alerts.innerHTML += `<li style="padding: 8px 0; border-bottom: 1px solid var(--border);">
                    <span class="badge bg-danger">REPLACE</span> ${c.LinenID} (${c.Name}) - Reached EOL (Cycle: ${c.CycleCount})
                </li>`;
            });
        } else {
            alerts.innerHTML = '<li style="color:var(--success)">No Critical Alerts. System Optimal.</li>';
        }
    },

    renderTransactions: function() {
        const tbody = document.querySelector('#table-trans tbody');
        tbody.innerHTML = '';
        State.data.transactions.slice(0, 10).forEach(t => {
            tbody.innerHTML += `<tr>
                <td>${new Date(t.Timestamp).toLocaleTimeString()}</td>
                <td>${t.LinenID}</td>
                <td><span class="badge bg-info">${t.NewStatus}</span></td>
                <td>${t.User}</td>
            </tr>`;
        });
    },

    renderOpnameTable: function() {
        document.querySelector('#table-opname tbody').innerHTML = '';
    }
};

// --- UI ---
const UI = {
    showLoading: function(show) {
        document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
    },
    showToast: function(msg, type='info') {
        // Simple toast implementation
        const el = document.createElement('div');
        el.style.cssText = `position:fixed; bottom:20px; right:20px; background:${type=='error'?'var(--danger)':'var(--success)'}; color:white; padding:10px 20px; border-radius:8px; z-index:9999; animation:slideIn 0.3s;`;
        el.innerText = msg;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 3000);
    }
};

function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('active');
}

// Init
document.getElementById('loginForm').addEventListener('submit', (e) => {
    e.preventDefault();
    Auth.login(document.getElementById('username').value, document.getElementById('password').value);
});

// Event Listener for Scan Input (Enter key)
document.getElementById('wf-scan').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') Workflow.scan();
});

document.getElementById('op-scan').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') StockOpname.addItem();
});

</script>
</body>
</html>
