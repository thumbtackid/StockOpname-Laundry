<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <title>RS Laundry OS Enterprise</title>
    
    <!-- External Assets -->
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-dark: #0f172a; --bg-card: #1e293b; --bg-input: #0f172a;
            --text-main: #f8fafc; --text-muted: #94a3b8;
            --primary: #3b82f6; --primary-hover: #2563eb; --primary-glow: rgba(59, 130, 246, 0.5);
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
            --border: rgba(255,255,255,0.1);
            --radius: 8px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            font-family: 'Inter', sans-serif; background: var(--bg-dark); color: var(--text-main);
            font-size: 13px; height: 100vh; overflow: hidden;
        }

        h1, h2, h3, h4 { font-family: 'Rajdhani', sans-serif; text-transform: uppercase; letter-spacing: 1px; }

        /* --- COMPONENTS --- */
        
        /* Buttons */
        .btn {
            background: var(--primary); color: white; border: none; padding: 10px 16px;
            border-radius: var(--radius); font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;
            transition: all 0.2s; font-size: 0.9rem;
        }
        .btn:hover { background: var(--primary-hover); transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }
        .btn-danger { background: var(--danger); }
        .btn-danger:hover { background: #dc2626; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
        .btn-outline:hover { border-color: var(--text-main); color: var(--text-main); background: rgba(255,255,255,0.05); }
        .btn-full { width: 100%; justify-content: center; }

        /* Inputs */
        input, select, textarea {
            width: 100%; background: var(--bg-input); border: 1px solid var(--border);
            color: white; padding: 10px; border-radius: var(--radius); font-family: inherit; margin-bottom: 10px;
            transition: border-color 0.2s;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); }
        
        /* Cards & Layout */
        .card {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px;
            padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow);
        }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        
        .flex { display: flex; gap: 10px; align-items: center; }
        .flex-between { justify-content: space-between; }
        .flex-col { flex-direction: column; align-items: stretch; }
        .flex-1 { flex: 1; }

        /* Badges */
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .bg-success { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .bg-warning { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .bg-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .bg-info { background: rgba(59, 130, 246, 0.2); color: var(--primary); }

        /* Tables */
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        th { text-align: left; padding: 12px 10px; color: var(--text-muted); border-bottom: 1px solid var(--border); font-size: 0.7rem; text-transform: uppercase; }
        td { padding: 12px 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: rgba(255,255,255,0.02); }

        /* Stats */
        .stat-value { font-size: 2rem; font-weight: 700; font-family: 'Rajdhani'; margin: 5px 0; line-height: 1; }
        .stat-label { color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; }

        /* --- SPECIFIC VIEWS --- */
        
        /* Login */
        #login-screen {
            position: fixed; inset: 0; background: linear-gradient(135deg, #020617, #1e1b4b);
            z-index: 9999; display: flex; justify-content: center; align-items: center;
        }
        .login-box {
            width: 90%; max-width: 380px; background: rgba(15, 23, 42, 0.95); border: 1px solid var(--border);
            backdrop-filter: blur(20px); padding: 40px 30px; border-radius: 20px; text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        /* Sidebar */
        .app-layout { display: grid; grid-template-columns: 260px 1fr; height: 100vh; }
        .sidebar {
            background: var(--bg-card); border-right: 1px solid var(--border); display: flex;
            flex-direction: column; padding: 20px 0; overflow-y: auto; z-index: 100;
        }
        .brand { padding: 0 24px 30px; font-size: 1.3rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 12px; }
        
        .nav-group { padding: 20px 24px 5px; font-size: 0.7rem; color: #475569; font-weight: 700; letter-spacing: 1.2px; margin-top: 10px;}
        .nav-item {
            padding: 12px 24px; color: var(--text-muted); display: flex; align-items: center; gap: 12px;
            cursor: pointer; transition: 0.2s; border-left: 3px solid transparent; font-weight: 500;
        }
        .nav-item:hover, .nav-item.active {
            background: rgba(59, 130, 246, 0.08); color: var(--primary); border-left-color: var(--primary);
        }

        /* Main Content */
        .main-content { padding: 30px; overflow-y: auto; height: 100%; }
        .section-header { margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }

        /* Loader */
        #loading-overlay {
            position: fixed; inset: 0; background: rgba(15,23,42,0.9); z-index: 10000;
            display: none; justify-content: center; align-items: center; flex-direction: column; backdrop-filter: blur(5px);
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-left-color: var(--primary);
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Utilities */
        .hidden { display: none !important; }
        .text-right { text-align: right; }

        /* Toast Notification */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; }
        .toast {
            background: var(--bg-card); border-left: 4px solid var(--primary); color: white;
            padding: 15px 20px; border-radius: 4px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            min-width: 300px; animation: slideIn 0.3s ease-out; display: flex; align-items: center; justify-content: space-between;
        }
        .toast.success { border-color: var(--success); }
        .toast.error { border-color: var(--danger); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Responsive */
        @media (max-width: 900px) {
            .app-layout { grid-template-columns: 1fr; }
            .sidebar { position: fixed; left: -260px; top: 0; bottom: 0; width: 260px; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
            .sidebar.active { left: 0; box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
            .mobile-header { display: flex !important; padding: 15px 20px; background: var(--bg-dark); justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
            .main-content { padding: 20px; }
        }
        @media (min-width: 901px) { .mobile-header { display: none; } }
    </style>
</head>
<body>

<!-- LOADING OVERLAY -->
<div id="loading-overlay">
    <div class="spinner"></div>
    <p style="letter-spacing: 2px; font-weight: 600; font-size: 0.9rem;">MENGHUBUNGKAN KE SERVER...</p>
</div>

<!-- TOAST CONTAINER -->
<div id="toast-container"></div>

<!-- LOGIN SCREEN -->
<section id="login-screen">
    <div class="login-box">
        <i class="fas fa-hospital-alt fa-3x" style="color:var(--primary); margin-bottom:20px;"></i>
        <h1 style="margin-bottom:5px; font-size: 1.8rem;">RS LAUNDRY OS</h1>
        <p style="color:var(--text-muted); margin-bottom:30px; font-size:0.85rem;">ENTERPRISE EDITION v1.0</p>
        
        <form id="loginForm">
            <div style="text-align: left;">
                <label style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 5px; display: block;">USERNAME</label>
                <input type="text" id="username" placeholder="Username" required autocomplete="off">
                
                <label style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 5px; display: block;">PASSWORD</label>
                <input type="password" id="password" placeholder="Password" required>
            </div>
            <button type="submit" class="btn btn-full" style="margin-top: 15px; padding: 12px;">LOGIN SYSTEM</button>
        </form>
    </div>
</section>

<!-- MAIN APPLICATION -->
<div class="app-layout hidden" id="main-app">
    
    <!-- Mobile Header -->
    <div class="mobile-header">
        <button class="btn" style="background:transparent; padding:5px; color:white;" onclick="UI.toggleSidebar()">
            <i class="fas fa-bars fa-lg"></i>
        </button>
        <div style="display:flex; align-items:center; gap:10px;">
            <i class="fas fa-hospital-alt" style="color:var(--primary);"></i>
            <span style="font-weight:700; letter-spacing: 1px;">LAUNDRY OS</span>
        </div>
        <div style="width: 32px;"></div> <!-- Spacer -->
    </div>

    <!-- Sidebar Navigation -->
    <nav class="sidebar" id="sidebar">
        <div class="brand">
            <i class="fas fa-hospital-alt"></i> 
            <div>
                RS LAUNDRY
                <div style="font-size:0.6rem; color:var(--text-muted); font-weight:400; letter-spacing: 0.5px;">ENTERPRISE</div>
            </div>
        </div>
        
        <div class="nav-group">MONITORING</div>
        <div class="nav-item active" onclick="App.nav('dashboard')"><i class="fas fa-chart-line"></i> Dashboard</div>
        
        <div class="nav-group">OPERATIONS</div>
        <div class="nav-item" onclick="App.nav('workflow')"><i class="fas fa-qrcode"></i> Linen Scan</div>
        <div class="nav-item" onclick="App.nav('opname')"><i class="fas fa-clipboard-check"></i> Stock Opname</div>
        <div class="nav-item" onclick="App.nav('handover')"><i class="fas fa-exchange-alt"></i> Room Handover</div>

        <div class="nav-group">RESOURCES</div>
        <div class="nav-item" onclick="App.nav('chemical')"><i class="fas fa-flask"></i> Chemical Log</div>
        <div class="nav-item" onclick="App.nav('maintenance')"><i class="fas fa-tools"></i> Maintenance</div>
        <div class="nav-item" onclick="App.nav('masterdata')"><i class="fas fa-plus-circle"></i> Add New Linen</div>

        <div style="margin-top:auto; padding:20px; border-top: 1px solid var(--border);">
            <div style="font-size:0.7rem; color:var(--text-muted); margin-bottom: 5px;">LOGGED IN:</div>
            <div id="user-display" style="font-weight:600; color:white; display:flex; align-items:center; gap:8px;">
                <i class="fas fa-user-circle"></i> <span>-</span>
            </div>
            <button class="btn btn-danger btn-full" style="margin-top:15px; justify-content:center;" onclick="Auth.logout()">
                <i class="fas fa-sign-out-alt"></i> LOGOUT
            </button>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="main-content" onclick="UI.closeSidebarOnMobile(event)">
        
        <!-- DASHBOARD VIEW -->
        <section id="view-dashboard" class="view-section">
            <header class="section-header">
                <h2><i class="fas fa-chart-pie" style="margin-right:10px; color:var(--primary);"></i> Executive Dashboard</h2>
                <div class="flex">
                    <button class="btn btn-outline" style="padding: 5px 10px;" onclick="Data.sync()"><i class="fas fa-sync-alt"></i> Refresh</button>
                </div>
            </header>

            <div class="grid-4">
                <div class="card">
                    <div class="stat-label">Total Linen</div>
                    <div class="stat-value" id="dash-linen">0</div>
                    <div style="font-size: 0.75rem; color: var(--success);"><i class="fas fa-check"></i> Inventory Tracked</div>
                </div>
                <div class="card">
                    <div class="stat-label">Critical Health</div>
                    <div class="stat-value" style="color:var(--danger);" id="dash-critical">0</div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">Max Cycle Reached</div>
                </div>
                <div class="card">
                    <div class="stat-label">Active Maintenance</div>
                    <div class="stat-value" style="color:var(--warning);" id="dash-maint">0</div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">Requires Attention</div>
                </div>
                <div class="card">
                    <div class="stat-label">Chemical Stock</div>
                    <div class="stat-value" style="color:var(--primary);" id="dash-chem">OK</div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">Inventory Status</div>
                </div>
            </div>

            <div class="grid-2" style="grid-template-columns: 2fr 1fr;">
                <div class="card">
                    <h3 style="margin-bottom:15px;">Linen Status Distribution</h3>
                    <div style="height: 250px; position: relative;">
                        <canvas id="dashChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h3 style="margin-bottom:15px;">Recent Activity</h3>
                    <div style="overflow-y: auto; max-height: 250px;">
                        <table id="dash-recent-table">
                            <thead><tr><th>Time</th><th>Action</th><th>User</th></tr></thead>
                            <tbody><!-- Populated via JS --></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- WORKFLOW / SCAN VIEW -->
        <section id="view-workflow" class="view-section hidden">
            <header class="section-header">
                <h2>Linen Workflow</h2>
                <div class="badge bg-info">SCANNING MODE</div>
            </header>
            
            <div class="grid-2">
                <div class="card">
                    <h3 style="margin-bottom:15px; color:var(--text-muted);">Process Item</h3>
                    <div class="flex">
                        <input type="text" id="wf-scan" placeholder="Scan RFID / Barcode..." style="flex:2;" autofocus>
                        <select id="wf-action" style="flex:1;">
                            <option value="WASHING">Washing</option>
                            <option value="DRYING">Drying</option>
                            <option value="READY">Ready</option>
                            <option value="DAMAGED">Damaged</option>
                            <option value="IN_USE">In Use</option>
                        </select>
                    </div>
                    <button class="btn btn-full" onclick="Workflow.scanItem()">Process Transaction</button>
                    
                    <div id="wf-preview" style="margin-top:20px; padding:15px; background:rgba(59, 130, 246, 0.1); border:1px solid rgba(59, 130, 246, 0.3); border-radius:8px; display:none;">
                        <div style="font-size:0.7rem; color:var(--text-muted); text-transform:uppercase;">Last Scanned</div>
                        <div style="font-weight:700; font-size:1.1rem; margin-bottom:5px;" id="preview-name">-</div>
                        <div class="flex flex-between">
                            <span class="badge bg-info" id="preview-id">ID: -</span>
                            <span style="font-size:0.8rem;" id="preview-cycle">Cycle: 0/50</span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom:15px; color:var(--text-muted);">Batch Queue</h3>
                    <div style="background:rgba(0,0,0,0.2); border-radius:8px; padding:10px; min-height: 150px;">
                        <ul id="wf-queue-list" style="list-style:none; padding:0; margin:0; font-size:0.8rem;">
                            <li style="color:var(--text-muted); text-align:center; padding-top:40px;">Queue is empty</li>
                        </ul>
                    </div>
                    <div class="flex" style="margin-top:10px;">
                        <button class="btn btn-outline flex-1" onclick="Workflow.clearQueue()">Clear</button>
                        <button class="btn btn-success flex-1" onclick="Workflow.processQueue()">Submit All</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- STOCK OPNAME -->
        <section id="view-opname" class="view-section hidden">
            <header class="section-header">
                <h2>Stock Opname</h2>
                <span class="badge bg-warning">AUDIT MODE</span>
            </header>
            <div class="card">
                <div class="grid-3">
                    <input type="text" id="op-scan" placeholder="Scan Linen ID">
                    <input type="text" id="op-unit" placeholder="Unit / Location">
                    <select id="op-condition">
                        <option value="GOOD">Condition: Good</option>
                        <option value="STAINED">Condition: Stained</option>
                        <option value="TORN">Condition: Torn</option>
                    </select>
                </div>
                <div class="flex">
                    <button class="btn btn-outline" onclick="StockOpname.addItem()"><i class="fas fa-plus"></i> Add Item</button>
                    <button class="btn btn-danger" style="margin-left:auto;" onclick="StockOpname.submit()">Finalize Audit</button>
                </div>
            </div>

            <div class="card">
                <h3>Audit List</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Linen ID</th>
                            <th>Name</th>
                            <th>Unit</th>
                            <th>Condition</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="table-opname"></tbody>
                </table>
            </div>
        </section>

        <!-- ROOM HANDOVER -->
        <section id="view-handover" class="view-section hidden">
            <header class="section-header">
                <h2>Room Handover</h2>
            </header>
            <div class="card" style="max-width: 800px; margin: 0 auto;">
                <div class="grid-3">
                    <div>
                        <label class="stat-label">From Unit</label>
                        <input type="text" id="ho-from" placeholder="e.g. Laundry">
                    </div>
                    <div>
                        <label class="stat-label">To Unit</label>
                        <input type="text" id="ho-to" placeholder="e.g. ICU">
                    </div>
                    <div>
                        <label class="stat-label">Date</label>
                        <input type="date" id="ho-date">
                    </div>
                </div>
                
                <div class="grid-4" style="margin-top:10px;">
                    <input type="text" id="ho-id" placeholder="Linen ID (Item Code)">
                    <input type="number" id="ho-qty" placeholder="Qty" value="1">
                    <input type="text" id="ho-cond" placeholder="Condition Note">
                    <button class="btn" onclick="Handover.addLine()"><i class="fas fa-plus"></i> Add</button>
                </div>

                <div style="margin-top:20px;">
                    <table>
                        <thead><tr><th>ID</th><th>Qty</th><th>Condition</th><th>Action</th></tr></thead>
                        <tbody id="table-handover"></tbody>
                    </table>
                </div>

                <div style="margin-top:20px; text-align:right;">
                     <button class="btn btn-success" onclick="Handover.submit()">Record Handover</button>
                </div>
            </div>
        </section>

        <!-- CHEMICAL -->
        <section id="view-chemical" class="view-section hidden">
            <header class="section-header">
                <h2>Daily Chemical Log</h2>
            </header>
            <div class="grid-2">
                <div class="card">
                    <h3>Input Usage</h3>
                    <div class="grid-2">
                        <input type="date" id="c-date">
                        <select id="c-shift">
                            <option value="I">Shift I (Morning)</option>
                            <option value="II">Shift II (Afternoon)</option>
                            <option value="III">Shift III (Night)</option>
                        </select>
                    </div>
                    
                    <div style="margin-top:15px;">
                        <label class="stat-label">Production Data (KG)</label>
                        <div class="grid-3">
                            <input type="number" id="c-kg-total" placeholder="Total">
                            <input type="number" id="c-kg-noninf" placeholder="Non-Infection">
                            <input type="number" id="c-kg-inf" placeholder="Infection">
                        </div>
                    </div>

                    <div style="margin-top:15px;">
                        <label class="stat-label">Chemicals (ml)</label>
                        <div class="grid-2">
                            <input type="number" id="c-detergent" placeholder="Detergent (Brodklin)">
                            <input type="number" id="c-disinfectant" placeholder="Disinfectant (Hevklir)">
                            <input type="number" id="c-alkali" placeholder="Alkali">
                            <input type="number" id="c-softener" placeholder="Softener (Softy)">
                        </div>
                    </div>
                    
                    <div style="margin-top:15px;">
                         <input type="number" id="c-lpg" placeholder="LPG Tabung">
                    </div>

                    <button class="btn btn-full" style="margin-top:20px;" onclick="Chemical.submit()">Log Usage</button>
                </div>

                <div class="card">
                    <h3>Inventory Status</h3>
                    <table id="chem-inventory-table">
                        <thead><tr><th>Chemical</th><th>Stock (L)</th><th>Status</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- MAINTENANCE -->
        <section id="view-maintenance" class="view-section hidden">
            <header class="section-header">
                <h2>Machine Maintenance</h2>
            </header>
            <div class="grid-2">
                <div class="card">
                    <h3>Report Issue</h3>
                    <label class="stat-label">Machine</label>
                    <select id="m-machine">
                        <!-- Populated by JS -->
                    </select>
                    
                    <label class="stat-label" style="margin-top:10px;">Issue Description</label>
                    <textarea id="m-desc" rows="3" placeholder="Describe the problem..."></textarea>
                    
                    <label class="stat-label" style="margin-top:10px;">Priority</label>
                    <select id="m-priority">
                        <option value="LOW">Low</option>
                        <option value="MEDIUM">Medium</option>
                        <option value="HIGH">High</option>
                    </select>

                    <button class="btn btn-danger btn-full" style="margin-top:20px;" onclick="Maintenance.submit()">Submit Ticket</button>
                </div>

                <div class="card">
                    <h3>Active Tickets</h3>
                    <table id="maint-table">
                        <thead><tr><th>Date</th><th>Machine</th><th>Issue</th><th>Status</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- ADD NEW LINEN -->
        <section id="view-masterdata" class="view-section hidden">
            <header class="section-header">
                <h2>Add New Linen Master</h2>
            </header>
            <div class="card" style="max-width: 600px; margin: 0 auto;">
                <div class="grid-2">
                    <div>
                        <label class="stat-label">Linen Name</label>
                        <input type="text" id="nl-name" placeholder="e.g. Bed Sheet King">
                    </div>
                    <div>
                        <label class="stat-label">Type</label>
                        <input type="text" id="nl-type" placeholder="e.g. Sheet">
                    </div>
                </div>
                
                <div class="grid-2" style="margin-top:10px;">
                    <div>
                        <label class="stat-label">Unit Origin</label>
                        <input type="text" id="nl-origin" placeholder="e.g. ICU">
                    </div>
                    <div>
                        <label class="stat-label">Current Location</label>
                        <input type="text" id="nl-loc" placeholder="e.g. STORAGE">
                    </div>
                </div>

                <div class="grid-2" style="margin-top:10px;">
                    <div>
                        <label class="stat-label">Max Cycle</label>
                        <input type="number" id="nl-maxcycle" value="50">
                    </div>
                    <div>
                        <label class="stat-label">Unit Cost (Rp)</label>
                        <input type="number" id="nl-cost" placeholder="0">
                    </div>
                </div>

                <div style="margin-top:10px;">
                    <label class="stat-label">Quantity</label>
                    <input type="number" id="nl-qty" value="1">
                </div>

                <button class="btn btn-success btn-full" style="margin-top:20px;" onclick="MasterData.add()">Register Linen</button>
            </div>
        </section>

    </main>
</div>

<script>
/**
 * FRONTEND CONFIGURATION
 * PENTING: Ganti URL di bawah ini dengan URL Web App dari Google Script Anda
 */
const CONFIG = {
    // Masukkan URL Deployment Apps Script Anda di sini
    SCRIPT_URL: "PASTE_DEPLOYMENT_URL_APPS_SCRIPT_DISINI" 
};

// --- STATE MANAGEMENT ---
const State = {
    user: null,
    data: { 
        linen:[], 
        units:[], 
        chemicals:[], 
        machines:[], 
        transactions:[], 
        maintenance:[],
        opnameLogs: [],
        chemicalUsage: []
    },
    opnameList: [],
    handoverList: [],
    workflowQueue: []
};

// --- AUTHENTICATION ---
const Auth = {
    login: async function(u, p) {
        UI.showLoading(true);
        try {
            const res = await fetch(CONFIG.SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'login', username: u, password: p })
            });
            const json = await res.json();
            
            if (json.status === 'success') {
                State.user = json.user;
                localStorage.setItem('rs_user', JSON.stringify(json.user));
                this.success();
            } else { 
                UI.showToast(json.message, 'error'); 
            }
        } catch (e) { 
            UI.showToast("Connection Failed: " + e.message, 'error'); 
        }
        UI.showLoading(false);
    },
    checkSession: function() {
        const stored = localStorage.getItem('rs_user');
        if(stored) {
            State.user = JSON.parse(stored);
            this.success();
        }
    },
    success: function() {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        document.getElementById('user-display').innerHTML = `<i class="fas fa-user-circle"></i> <span>${State.user.name}</span>`;
        Data.sync();
    },
    logout: function() { 
        localStorage.removeItem('rs_user');
        location.reload(); 
    }
};

// --- DATA SYNCING ---
const Data = {
    sync: async function() {
        UI.showLoading(true);
        try {
            const res = await fetch(CONFIG.SCRIPT_URL, {
                method: 'POST', 
                body: JSON.stringify({ action: 'get_initial_data' })
            });
            const json = await res.json();
            if (json.status === 'success') {
                State.data = json.data;
                App.render();
                UI.showToast("Data Synced", 'success');
            } else {
                UI.showToast(json.message, 'error');
            }
        } catch (e) { UI.showToast("Sync Error: " + e.message, 'warning'); }
        UI.showLoading(false);
    },
    post: async function(action, payload) {
        UI.showLoading(true);
        try {
            // Append user info automatically if not present
            if(!payload.user) payload.user = State.user;
            
            const res = await fetch(CONFIG.SCRIPT_URL, { 
                method: 'POST', 
                body: JSON.stringify({ ...payload, action: action }) 
            });
            const json = await res.json();
            UI.showLoading(false);
            
            if(json.status === 'success') {
                UI.showToast(json.message || "Success", 'success');
                this.sync();
                return true;
            }
            UI.showToast(json.message || "Error occurred", 'error');
        } catch(e) { 
            UI.showLoading(false); 
            UI.showToast("Network Error", 'error');
        }
        return false;
    }
};

// --- FEATURE LOGIC ---

const Workflow = {
    scanItem: function() {
        const id = document.getElementById('wf-scan').value.trim();
        if(!id) {
            UI.showToast("Masukkan Linen ID", 'error');
            return;
        }
        
        // Find linen in master data
        const linen = State.data.linen.find(l => l.LinenID === id);
        if(!linen) {
            UI.showToast(`Linen ID ${id} tidak ditemukan`, 'error');
            return;
        }
        
        // Add to queue
        const newStatus = document.getElementById('wf-action').value;
        State.workflowQueue.push({ 
            linenId: id, 
            newStatus: newStatus 
        });
        
        // Show preview
        this.previewLinen(linen);
        
        // Render queue
        this.renderQueue();
        
        // Clear input and focus
        document.getElementById('wf-scan').value = '';
        document.getElementById('wf-scan').focus();
        
        UI.showToast(`Added ${id} to queue`, 'success');
    },
    
    processQueue: function() {
        if(State.workflowQueue.length === 0) {
            UI.showToast("Queue is empty", 'warning');
            return;
        }
        
        Data.post('process_linen_scan', { 
            scans: State.workflowQueue, 
            location: 'LAUNDRY' 
        })
        .then(success => { 
            if(success) { 
                this.clearQueue(); 
            }
        });
    },
    
    clearQueue: function() {
        State.workflowQueue = [];
        this.renderQueue();
        document.getElementById('wf-preview').style.display='none';
        UI.showToast("Queue cleared", 'success');
    },
    
    previewLinen: function(linen) {
        document.getElementById('wf-preview').style.display = 'block';
        document.getElementById('preview-name').innerText = linen.Name || linen.LinenID;
        document.getElementById('preview-id').innerText = "ID: " + linen.LinenID;
        document.getElementById('preview-cycle').innerText = `Cycle: ${linen.CycleCount || 0}/${linen.MaxCycle || 50}`;
        
        // Color code based on health status
        const cycleEl = document.getElementById('preview-cycle');
        if(linen.HealthStatus === 'CRITICAL') {
            cycleEl.style.color = 'var(--danger)';
        } else if(linen.HealthStatus === 'WARNING') {
            cycleEl.style.color = 'var(--warning)';
        } else {
            cycleEl.style.color = 'var(--success)';
        }
    },
    
    renderQueue: function() {
        const list = document.getElementById('wf-queue-list');
        if (State.workflowQueue.length === 0) {
            list.innerHTML = '<li style="color:var(--text-muted); text-align:center; padding-top:40px;">Queue is empty</li>';
            return;
        }
        
        list.innerHTML = '';
        State.workflowQueue.forEach((item, index) => {
            const linen = State.data.linen.find(l => l.LinenID === item.linenId);
            const linenName = linen ? linen.Name : 'Unknown Item';
            
            list.innerHTML += `
                <li style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.05);">
                    <span>
                        <span style="color:var(--primary); font-weight:600;">${item.linenId}</span> 
                        <small style="color:var(--text-muted);">(${linenName})</small>
                    </span>
                    <span class="badge bg-info">${item.newStatus}</span>
                </li>`;
        });
    }
};

const StockOpname = {
    addItem: function() {
        const id = document.getElementById('op-scan').value.trim();
        const unit = document.getElementById('op-unit').value.trim();
        
        if(!id) {
            UI.showToast("Masukkan Linen ID", 'error');
            return;
        }
        
        if(!unit) {
            UI.showToast("Masukkan Unit/Lokasi", 'error');
            return;
        }
        
        // Find linen in master data
        const linen = State.data.linen.find(l => l.LinenID === id);
        if(!linen) {
            UI.showToast(`Linen ID ${id} tidak ditemukan`, 'error');
            return;
        }
        
        // Add to opname list
        State.opnameList.push({ 
            linenId: id, 
            linenName: linen.Name,
            unit: unit,
            physicalCount: 1,
            notes: document.getElementById('op-condition').value,
            reason: "Regular Audit"
        });
        
        // Render the list
        this.render();
        
        // Clear input and focus
        document.getElementById('op-scan').value = '';
        document.getElementById('op-scan').focus();
        
        UI.showToast(`Added ${id} to audit list`, 'success');
    },
    
    removeItem: function(index) {
        State.opnameList.splice(index, 1);
        this.render();
    },
    
    submit: function() {
        if(State.opnameList.length === 0) {
            UI.showToast("Audit list is empty", 'warning');
            return;
        }
        
        Data.post('submit_stock_opname', { 
            items: State.opnameList, 
            unit: 'GENERAL_AUDIT',
            auditor: State.user.name 
        })
        .then(() => { 
            State.opnameList = []; 
            this.render(); 
        });
    },
    
    render: function() {
        const tbody = document.getElementById('table-opname');
        tbody.innerHTML = '';
        
        if (State.opnameList.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align:center; color:var(--text-muted); padding:40px 0;">
                        No items in audit list
                    </td>
                </tr>`;
            return;
        }
        
        State.opnameList.forEach((item, index) => {
            tbody.innerHTML += `
                <tr>
                    <td>${item.linenId}</td>
                    <td>${item.linenName}</td>
                    <td>${item.unit}</td>
                    <td>${item.notes}</td>
                    <td>
                        <button class="btn btn-danger" style="padding: 2px 6px; font-size: 0.7rem;" 
                                onclick="StockOpname.removeItem(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    </td>
                </tr>`;
        });
    }
};

const Chemical = {
    submit: function() {
        const totalKg = document.getElementById('c-kg-total').value;
        if(!totalKg || totalKg <= 0) {
            UI.showToast("Masukkan Total KG yang valid", 'warning');
            return;
        }
        
        const payload = {
            action: 'submit_chemical_usage',
            date: document.getElementById('c-date').value,
            shift: document.getElementById('c-shift').value,
            totalLinen: totalKg,
            nonInfectionLinen: document.getElementById('c-kg-noninf').value || 0,
            infectionLinen: document.getElementById('c-kg-inf').value || 0,
            detergent_ml: document.getElementById('c-detergent').value || 0,
            disinfectant_ml: document.getElementById('c-disinfectant').value || 0,
            alkali_ml: document.getElementById('c-alkali').value || 0,
            softener_ml: document.getElementById('c-softener').value || 0,
            lpg: document.getElementById('c-lpg').value || 0,
            operator: State.user.name
        };
        
        Data.post('submit_chemical_usage', payload);
    },
    
    renderInventory: function() {
        const tbody = document.querySelector('#chem-inventory-table tbody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        const chemicals = State.data.chemicals || [];
        
        chemicals.forEach(chem => {
            const stock = parseFloat(chem.StockQuantity || 0);
            const minStock = parseFloat(chem.MinimumStock || 10);
            let status = 'OK';
            let statusClass = 'bg-success';
            
            if (stock <= minStock) {
                status = 'LOW';
                statusClass = 'bg-danger';
            } else if (stock <= minStock * 1.5) {
                status = 'WARNING';
                statusClass = 'bg-warning';
            }
            
            tbody.innerHTML += `
                <tr>
                    <td>${chem.ChemicalName}</td>
                    <td>${stock.toFixed(1)} L</td>
                    <td><span class="badge ${statusClass}">${status}</span></td>
                </tr>`;
        });
    }
};

const Maintenance = {
    submit: function() {
        const machine = document.getElementById('m-machine').value;
        const desc = document.getElementById('m-desc').value;
        
        if(!machine) {
            UI.showToast("Pilih mesin", 'error');
            return;
        }
        
        if(!desc) {
            UI.showToast("Masukkan deskripsi masalah", 'error');
            return;
        }
        
        const payload = {
            action: 'submit_machine_maintenance',
            machineName: machine,
            issueDescription: desc,
            status: 'REPORTED',
            reportedBy: State.user.name,
            priority: document.getElementById('m-priority').value
        };
        
        Data.post('submit_machine_maintenance', payload);
    },
    
    populateMachines: function() {
        const select = document.getElementById('m-machine');
        if (!select) return;
        
        select.innerHTML = '<option value="">Select Machine...</option>';
        const machines = State.data.machines || [];
        
        machines.forEach(m => {
            const status = m.Status || 'UNKNOWN';
            select.innerHTML += `<option value="${m.Name}">${m.Name} (${status})</option>`;
        });
    },
    
    renderActiveTickets: function() {
        const tbody = document.querySelector('#maint-table tbody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        const maintenance = State.data.maintenance || [];
        const activeTickets = maintenance.filter(m => 
            m.Status === 'REPORTED' || m.Status === 'IN_PROGRESS'
        ).slice(0, 10); // Show only latest 10
        
        activeTickets.forEach(m => {
            const date = m.ReportDate ? new Date(m.ReportDate).toLocaleDateString() : '-';
            const issue = m.IssueDescription ? m.IssueDescription.substring(0, 50) + '...' : '-';
            
            tbody.innerHTML += `
                <tr>
                    <td>${date}</td>
                    <td>${m.MachineName}</td>
                    <td>${issue}</td>
                    <td><span class="badge bg-warning">${m.Status}</span></td>
                </tr>`;
        });
    }
};

const Handover = {
    addLine: function() {
        const id = document.getElementById('ho-id').value.trim();
        const qty = document.getElementById('ho-qty').value;
        const cond = document.getElementById('ho-cond').value;
        
        if(!id) {
            UI.showToast("Masukkan Linen ID", 'error');
            return;
        }
        
        if(!qty || qty <= 0) {
            UI.showToast("Masukkan jumlah yang valid", 'error');
            return;
        }
        
        // Find linen
        const linen = State.data.linen.find(l => l.LinenID === id);
        if(!linen) {
            UI.showToast(`Linen ID ${id} tidak ditemukan`, 'error');
            return;
        }
        
        // Add to handover list
        State.handoverList.push({ 
            linenId: id, 
            linenName: linen.Name,
            quantity: parseInt(qty),
            condition: cond || 'GOOD'
        });
        
        // Render list
        this.render();
        
        // Clear inputs
        document.getElementById('ho-id').value = '';
        document.getElementById('ho-qty').value = '1';
        document.getElementById('ho-cond').value = '';
        document.getElementById('ho-id').focus();
        
        UI.showToast(`Added ${id} to handover list`, 'success');
    },
    
    removeItem: function(index) {
        State.handoverList.splice(index, 1);
        this.render();
    },
    
    submit: function() {
        const fromUnit = document.getElementById('ho-from').value.trim();
        const toUnit = document.getElementById('ho-to').value.trim();
        
        if(!fromUnit || !toUnit) {
            UI.showToast("Masukkan From Unit dan To Unit", 'error');
            return;
        }
        
        if(State.handoverList.length === 0) {
            UI.showToast("Handover list is empty", 'warning');
            return;
        }
        
        // Process each item in handover list
        const promises = State.handoverList.map(item => {
            const payload = {
                action: 'submit_room_handover',
                fromUnit: fromUnit,
                toUnit: toUnit,
                linenId: item.linenId,
                linenName: item.linenName,
                quantity: item.quantity,
                condition: item.condition,
                handoverTime: new Date().toLocaleTimeString(),
                user: State.user
            };
            
            // Return promise for each item
            return fetch(CONFIG.SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            });
        });
        
        UI.showLoading(true);
        
        // Execute all promises
        Promise.all(promises)
            .then(responses => Promise.all(responses.map(r => r.json())))
            .then(results => {
                UI.showLoading(false);
                const successCount = results.filter(r => r.status === 'success').length;
                
                if (successCount === State.handoverList.length) {
                    UI.showToast(`${successCount} items handed over successfully`, 'success');
                    State.handoverList = [];
                    this.render();
                } else {
                    UI.showToast(`Only ${successCount} of ${State.handoverList.length} items processed`, 'warning');
                }
            })
            .catch(error => {
                UI.showLoading(false);
                UI.showToast("Error processing handover", 'error');
            });
    },
    
    render: function() {
        const tbody = document.getElementById('table-handover');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (State.handoverList.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" style="text-align:center; color:var(--text-muted); padding:40px 0;">
                        No items in handover list
                    </td>
                </tr>`;
            return;
        }
        
        State.handoverList.forEach((item, index) => {
            tbody.innerHTML += `
                <tr>
                    <td>${item.linenId}</td>
                    <td>${item.quantity}</td>
                    <td>${item.condition}</td>
                    <td>
                        <button class="btn btn-danger" style="padding: 2px 6px; font-size: 0.7rem;" 
                                onclick="Handover.removeItem(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    </td>
                </tr>`;
        });
    }
};

const MasterData = {
    add: function() {
        const name = document.getElementById('nl-name').value.trim();
        const type = document.getElementById('nl-type').value.trim();
        const quantity = parseInt(document.getElementById('nl-qty').value) || 1;
        
        if(!name) {
            UI.showToast("Masukkan nama linen", 'error');
            return;
        }
        
        if(!type) {
            UI.showToast("Masukkan tipe linen", 'error');
            return;
        }
        
        if(quantity <= 0) {
            UI.showToast("Masukkan jumlah yang valid", 'error');
            return;
        }
        
        const payload = {
            action: 'add_new_linen',
            name: name,
            type: type,
            unitOrigin: document.getElementById('nl-origin').value || 'LAUNDRY',
            currentLocation: document.getElementById('nl-loc').value || 'STORAGE',
            maxCycle: document.getElementById('nl-maxcycle').value || 50,
            unitCost: document.getElementById('nl-cost').value || 0,
            quantity: quantity,
            user: State.user
        };
        
        Data.post('add_new_linen', payload)
            .then(success => {
                if(success) {
                    // Clear form
                    document.getElementById('nl-name').value = '';
                    document.getElementById('nl-type').value = '';
                    document.getElementById('nl-origin').value = '';
                    document.getElementById('nl-loc').value = '';
                    document.getElementById('nl-cost').value = '';
                    document.getElementById('nl-qty').value = '1';
                }
            });
    }
};

// --- APP CONTROLLER ---
const App = {
    currentView: 'dashboard',
    
    nav: function(viewId) {
        // Hide all views
        document.querySelectorAll('.view-section').forEach(el => {
            el.classList.add('hidden');
        });
        
        // Show selected view
        const targetView = document.getElementById('view-' + viewId);
        if (targetView) {
            targetView.classList.remove('hidden');
            this.currentView = viewId;
        }
        
        // Update active nav item
        document.querySelectorAll('.nav-item').forEach(el => {
            el.classList.remove('active');
        });
        
        // Set clicked nav as active
        if (event && event.currentTarget) {
            event.currentTarget.classList.add('active');
        }
        
        // Perform view-specific initialization
        this.initView(viewId);
    },
    
    initView: function(viewId) {
        switch(viewId) {
            case 'dashboard':
                this.renderDashboard();
                break;
            case 'chemical':
                Chemical.renderInventory();
                break;
            case 'maintenance':
                Maintenance.populateMachines();
                Maintenance.renderActiveTickets();
                break;
            case 'workflow':
                document.getElementById('wf-scan').focus();
                break;
            case 'opname':
                document.getElementById('op-scan').focus();
                break;
        }
    },
    
    renderDashboard: function() {
        // Dashboard Stats
        const linens = State.data.linen || [];
        document.getElementById('dash-linen').textContent = linens.length;
        
        const criticalLinen = linens.filter(l => l.HealthStatus === 'CRITICAL').length;
        document.getElementById('dash-critical').textContent = criticalLinen;
        
        const maintenance = State.data.maintenance || [];
        const activeMaint = maintenance.filter(m => 
            m.Status === 'REPORTED' || m.Status === 'IN_PROGRESS'
        ).length;
        document.getElementById('dash-maint').textContent = activeMaint;
        
        // Chemical Stock Status
        const chemicals = State.data.chemicals || [];
        const lowStock = chemicals.filter(c => {
            const stock = parseFloat(c.StockQuantity || 0);
            const minStock = parseFloat(c.MinimumStock || 10);
            return stock <= minStock;
        }).length;
        
        const chemBadge = document.getElementById('dash-chem');
        if (lowStock > 0) {
            chemBadge.textContent = 'LOW';
            chemBadge.style.color = 'var(--danger)';
        } else {
            chemBadge.textContent = 'OK';
            chemBadge.style.color = 'var(--success)';
        }
        
        // Render Chart
        this.renderChart();
        
        // Render Recent Activity
        this.renderRecentActivity();
    },
    
    renderChart: function() {
        const linens = State.data.linen || [];
        
        const readyCount = linens.filter(l => l.Status === 'READY').length;
        const washingCount = linens.filter(l => l.Status === 'WASHING').length;
        const criticalCount = linens.filter(l => l.HealthStatus === 'CRITICAL').length;
        const damagedCount = linens.filter(l => l.Status === 'DAMAGED').length;
        const missingCount = linens.filter(l => l.Status === 'MISSING').length;
        
        // Destroy existing chart if exists
        if (window.dashChart) {
            window.dashChart.destroy();
        }
        
        const ctx = document.getElementById('dashChart');
        if (!ctx) return;
        
        window.dashChart = new Chart(ctx.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: ['Ready', 'Washing', 'Critical', 'Damaged', 'Missing'],
                datasets: [{
                    data: [readyCount, washingCount, criticalCount, damagedCount, missingCount],
                    backgroundColor: [
                        '#10b981', // Ready - green
                        '#3b82f6', // Washing - blue
                        '#ef4444', // Critical - red
                        '#f59e0b', // Damaged - yellow
                        '#64748b'  // Missing - gray
                    ],
                    borderWidth: 0
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                plugins: { 
                    legend: { 
                        position: 'right', 
                        labels: { 
                            color: '#94a3b8',
                            padding: 15,
                            usePointStyle: true
                        } 
                    }
                },
                cutout: '60%'
            }
        });
    },
    
    renderRecentActivity: function() {
        const tbody = document.querySelector('#dash-recent-table tbody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        const transactions = State.data.transactions || [];
        
        // Get last 5 transactions
        const recentTransactions = transactions.slice(0, 5);
        
        if (recentTransactions.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="3" style="text-align:center; color:var(--text-muted); padding:20px;">
                        No recent activity
                    </td>
                </tr>`;
            return;
        }
        
        recentTransactions.forEach(t => {
            const time = t.Timestamp ? 
                new Date(t.Timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 
                '-';
            
            const action = t.NewStatus ? 
                `Status: ${t.NewStatus}` : 
                t.TransactionType || 'Transaction';
            
            const user = t.User || 'System';
            
            tbody.innerHTML += `
                <tr>
                    <td>${time}</td>
                    <td>${action}</td>
                    <td>${user}</td>
                </tr>`;
        });
    },
    
    render: function() {
        this.renderDashboard();
    }
};

// --- UI UTILS ---
const UI = {
    showLoading: function(show) {
        document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
    },
    
    showToast: function(message, type = 'info') {
        const container = document.getElementById('toast-container');
        if (!container) return;
        
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `
            <span>${message}</span>
            <i class="fas fa-times" style="cursor:pointer;" onclick="this.parentElement.remove()"></i>
        `;
        
        container.appendChild(toast);
        
        // Auto remove after 4 seconds
        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 4000);
        
        // Limit to 3 toasts at a time
        const toasts = container.querySelectorAll('.toast');
        if (toasts.length > 3) {
            toasts[0].remove();
        }
    },
    
    toggleSidebar: function() {
        const sidebar = document.getElementById('sidebar');
        if (sidebar) {
            sidebar.classList.toggle('active');
        }
    },
    
    closeSidebarOnMobile: function(event) {
        const sidebar = document.getElementById('sidebar');
        const mobileHeaderBtn = document.querySelector('.mobile-header button');
        
        if (window.innerWidth <= 900 && 
            sidebar.classList.contains('active') && 
            !sidebar.contains(event.target) && 
            !mobileHeaderBtn.contains(event.target)) {
            sidebar.classList.remove('active');
        }
    }
};

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', function() {
    // Check if Script URL is configured
    if(CONFIG.SCRIPT_URL.includes("PASTE_DEPLOYMENT_URL_APPS_SCRIPT_DISINI")) {
        alert(" PERHATIAN: Anda belum memasukkan URL Deployment Google Script!\n\n1. Deploy Apps Script Anda sebagai Web App\n2. Copy URL Deployment-nya\n3. Ganti nilai CONFIG.SCRIPT_URL di file ini (baris ~500)\n\nSetelah itu sistem akan berfungsi dengan baik.");
    }
    
    // Check for existing session
    Auth.checkSession();
    
    // Set default dates
    const today = new Date().toISOString().slice(0, 10);
    document.querySelectorAll('input[type="date"]').forEach(input => {
        input.value = today;
    });
    
    // Set default handover date to tomorrow
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const tomorrowStr = tomorrow.toISOString().slice(0, 10);
    const hoDate = document.getElementById('ho-date');
    if (hoDate) hoDate.value = tomorrowStr;
    
    // Login Form Handler
    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
        loginForm.addEventListener('submit', function(e) { 
            e.preventDefault(); 
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                UI.showToast("Masukkan username dan password", 'error');
                return;
            }
            
            Auth.login(username, password); 
        });
    }
    
    // Enter key listeners
    const wfScanInput = document.getElementById('wf-scan');
    if (wfScanInput) {
        wfScanInput.addEventListener('keypress', function(e) { 
            if (e.key === 'Enter') {
                e.preventDefault();
                Workflow.scanItem();
            }
        });
    }
    
    const opScanInput = document.getElementById('op-scan');
    if (opScanInput) {
        opScanInput.addEventListener('keypress', function(e) { 
            if (e.key === 'Enter') {
                e.preventDefault();
                StockOpname.addItem();
            }
        });
    }
    
    const hoIdInput = document.getElementById('ho-id');
    if (hoIdInput) {
        hoIdInput.addEventListener('keypress', function(e) { 
            if (e.key === 'Enter') {
                e.preventDefault();
                Handover.addLine();
            }
        });
    }
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl+R to refresh data
        if (e.ctrlKey && e.key === 'r') {
            e.preventDefault();
            Data.sync();
            UI.showToast("Refreshing data...", 'info');
        }
        
        // Escape to close sidebar on mobile
        if (e.key === 'Escape') {
            const sidebar = document.getElementById('sidebar');
            if (window.innerWidth <= 900 && sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
            }
        }
    });
    
    // Initialize app
    App.nav('dashboard');
});

// Make functions globally available
window.Auth = Auth;
window.Data = Data;
window.Workflow = Workflow;
window.StockOpname = StockOpname;
window.Chemical = Chemical;
window.Maintenance = Maintenance;
window.Handover = Handover;
window.MasterData = MasterData;
window.App = App;
window.UI = UI;
</script>
</body>
</html>
