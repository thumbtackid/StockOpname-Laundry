<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RS Charlie - Laundry Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #64748b;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1e293b;
            --light: #f1f5f9;
            --white: #ffffff;
            --sidebar-width: 250px;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; }
        body { background: var(--light); display: flex; height: 100vh; overflow: hidden; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--dark);
            color: var(--white);
            display: flex;
            flex-direction: column;
            transition: 0.3s;
        }
        .sidebar-header { padding: 20px; font-weight: bold; font-size: 1.2rem; border-bottom: 1px solid #334155; }
        .menu-item {
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #94a3b8;
            transition: 0.2s;
            text-decoration: none;
        }
        .menu-item:hover, .menu-item.active { background: var(--primary); color: var(--white); }
        
        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            position: relative;
        }

        /* --- COMPONENTS --- */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card { background: var(--white); border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; color: white; display: inline-flex; align-items: center; gap: 5px; }
        .btn-primary { background: var(--primary); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        .btn-sm { padding: 5px 10px; font-size: 0.85rem; }
        
        /* --- TABLE --- */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background: #f8fafc; color: var(--secondary); font-size: 0.85rem; text-transform: uppercase; }
        
        /* --- WORKFLOW UI --- */
        .workflow-actions {
            background: #e0f2fe;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            border: 1px solid #bae6fd;
        }
        .workflow-actions select { padding: 8px; border-radius: 4px; border: 1px solid #cbd5e1; }

        /* --- MODAL (POPUP) --- */
        .modal {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center; align-items: center; z-index: 1000;
        }
        .modal.active { display: flex; }
        .modal-content { background: var(--white); padding: 25px; border-radius: 8px; width: 100%; max-width: 400px; animation: slideDown 0.3s; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9rem; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; }

        /* --- UTILS --- */
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .badge-dirty { background: #fee2e2; color: var(--danger); }
        .badge-washing { background: #fef3c7; color: var(--warning); }
        .badge-clean { background: #dcfce7; color: var(--success); }
        
        .hidden { display: none !important; }
        
        /* LOGIN PAGE */
        #login-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--dark); z-index: 2000;
            display: flex; justify-content: center; align-items: center;
        }
        .login-box { background: var(--white); padding: 30px; border-radius: 8px; width: 300px; text-align: center; }

        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

    <!-- LOGIN PAGE -->
    <div id="login-page">
        <div class="login-box">
            <h2><i class="fa-solid fa-hospital"></i> RS Charlie</h2>
            <p style="color:#64748b; margin-bottom:20px;">Laundry Management</p>
            <div class="form-group">
                <input type="text" id="loginUser" placeholder="Username">
            </div>
            <div class="form-group">
                <input type="password" id="loginPass" placeholder="Password">
            </div>
            <button class="btn btn-primary" style="width:100%" onclick="doLogin()">MASUK</button>
        </div>
    </div>

    <!-- SIDEBAR -->
    <div class="sidebar hidden" id="app-sidebar">
        <div class="sidebar-header">
            <i class="fa-solid fa-soap"></i> Laundry System
        </div>
        <a href="#" class="menu-item active" onclick="showPage('dashboard')"><i class="fa-solid fa-chart-pie"></i> Dashboard</a>
        <a href="#" class="menu-item" onclick="showPage('workflow')"><i class="fa-solid fa-arrows-rotate"></i> Workflow</a>
        <a href="#" class="menu-item" onclick="showPage('master')"><i class="fa-solid fa-database"></i> Master Data</a>
        <div style="margin-top: auto; padding: 20px;">
            <button class="btn btn-danger btn-sm" style="width:100%" onclick="location.reload()"><i class="fa-solid fa-power-off"></i> Keluar</button>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content hidden" id="app-content">
        
        <!-- HEADER -->
        <div class="header">
            <h2 id="page-title">Dashboard</h2>
            <div style="font-weight: 600; color: var(--secondary);">Halo, <span id="userNameDisplay">Admin</span></div>
        </div>

        <!-- PAGE: DASHBOARD -->
        <div id="page-dashboard">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <div class="card" style="border-left: 5px solid var(--primary);">
                    <h3 style="color: var(--secondary); font-size: 0.9rem;">TOTAL LINEN</h3>
                    <div style="font-size: 2rem; font-weight: bold;" id="stat-total">0</div>
                </div>
                <div class="card" style="border-left: 5px solid var(--danger);">
                    <h3 style="color: var(--secondary); font-size: 0.9rem;">KOTOR (DIRTY)</h3>
                    <div style="font-size: 2rem; font-weight: bold;" id="stat-dirty">0</div>
                </div>
                <div class="card" style="border-left: 5px solid var(--warning);">
                    <h3 style="color: var(--secondary); font-size: 0.9rem;">PROSES (WASHING)</h3>
                    <div style="font-size: 2rem; font-weight: bold;" id="stat-washing">0</div>
                </div>
                <div class="card" style="border-left: 5px solid var(--success);">
                    <h3 style="color: var(--secondary); font-size: 0.9rem;">BERSIH (CLEAN)</h3>
                    <div style="font-size: 2rem; font-weight: bold;" id="stat-clean">0</div>
                </div>
            </div>

            <div class="card">
                <h3>Status Mesin Cuci</h3>
                <div class="table-container">
                    <table id="dash-machines">
                        <thead><tr><th>ID</th><th>Nama</th><th>Kapasitas</th><th>Status</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PAGE: WORKFLOW -->
        <div id="page-workflow" class="hidden">
            <div class="workflow-actions">
                <label><strong>Mode Kerja:</strong></label>
                <button class="btn btn-primary btn-sm" onclick="switchWorkflow('dirty')">Kotor (Siap Cuci)</button>
                <button class="btn btn-warning btn-sm" onclick="switchWorkflow('washing')">Sedang Cuci</button>
            </div>

            <!-- PANEL: DIRTY -->
            <div id="wf-dirty-panel">
                <div class="workflow-actions" style="background: white; border: 1px solid #e2e8f0;">
                    <span>Pilih Mesin:</span>
                    <select id="selectMachine">
                        <option value="">-- Pilih Mesin --</option>
                    </select>
                    <button class="btn btn-primary" onclick="processWashing()">ðŸ§º MULAI CUCI</button>
                </div>
                <div class="card">
                    <h3>Daftar Linen Kotor</h3>
                    <p style="font-size: 0.85rem; color: #64748b; margin-bottom: 10px;">Centang item yang akan dimasukkan ke mesin cuci.</p>
                    <div class="table-container">
                        <table id="table-dirty">
                            <thead><tr><th><input type="checkbox" onchange="toggleAll(this, 'table-dirty')"></th><th>ID</th><th>Nama</th><th>Lokasi</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- PANEL: WASHING -->
            <div id="wf-washing-panel" class="hidden">
                <div class="workflow-actions" style="background: white; border: 1px solid #e2e8f0;">
                    <span>Input Unit Tujuan:</span>
                    <input type="text" id="targetUnitInput" placeholder="Contoh: U-ICU" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    <button class="btn btn-success" onclick="processClean()">âœ… SELESAI CUCI</button>
                </div>
                <div class="card">
                    <h3>Daftar Sedang Dicuci</h3>
                    <p style="font-size: 0.85rem; color: #64748b; margin-bottom: 10px;">Centang item yang sudah selesai dicuci.</p>
                    <div class="table-container">
                        <table id="table-washing">
                            <thead><tr><th><input type="checkbox" onchange="toggleAll(this, 'table-washing')"></th><th>ID</th><th>Nama</th><th>Mesin</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- PAGE: MASTER DATA -->
        <div id="page-master" class="hidden">
            <div style="margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="openModal('modalLinen')"><i class="fa-solid fa-plus"></i> Tambah Linen</button>
                <button class="btn btn-primary" onclick="openModal('modalMachine')"><i class="fa-solid fa-plus"></i> Tambah Mesin</button>
                <button class="btn btn-primary" onclick="openModal('modalInv')"><i class="fa-solid fa-plus"></i> Tambah Inventory</button>
            </div>
            
            <div class="card">
                <h3>Master Linen</h3>
                <div class="table-container">
                    <table id="master-linen">
                        <thead><tr><th>ID</th><th>Nama</th><th>Status</th><th>Lokasi</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- MODALS -->
    <!-- Modal Linen -->
    <div id="modalLinen" class="modal">
        <div class="modal-content">
            <h3>Tambah Linen Baru</h3>
            <div class="form-group"><label>ID Linen</label><input type="text" id="inLinenId"></div>
            <div class="form-group"><label>Nama Item</label><input type="text" id="inLinenName"></div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-secondary" onclick="closeModal('modalLinen')">Batal</button>
                <button class="btn btn-primary" onclick="saveData('linen')">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal Machine -->
    <div id="modalMachine" class="modal">
        <div class="modal-content">
            <h3>Tambah Mesin Cuci</h3>
            <div class="form-group"><label>ID Mesin</label><input type="text" id="inMachineId"></div>
            <div class="form-group"><label>Nama Mesin</label><input type="text" id="inMachineName"></div>
            <div class="form-group"><label>Kapasitas (Kg)</label><input type="number" id="inMachineCap"></div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-secondary" onclick="closeModal('modalMachine')">Batal</button>
                <button class="btn btn-primary" onclick="saveData('machine')">Simpan</button>
            </div>
        </div>
    </div>

    <script>
        // --- KONFIGURASI URL ---
        // PASTIKAN URL INI BENAR
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyeLp4DRTBOVblLYa7wcwdlnP3WQEvXIMGfBCeuN8w3S9yQ_L_x1kHkdOw9T1j25xJheQ/exec";
        
        let globalData = {};

        // --- AUTH & INIT ---
        function doLogin() {
            const u = document.getElementById('loginUser').value;
            const p = document.getElementById('loginPass').value;

            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'login', username: u, password: p })
            })
            .then(r => r.json())
            .then(d => {
                if (d.status === 'success') {
                    document.getElementById('login-page').classList.add('hidden');
                    document.getElementById('app-sidebar').classList.remove('hidden');
                    document.getElementById('app-content').classList.remove('hidden');
                    document.getElementById('userNameDisplay').innerText = d.user.name;
                    loadData();
                } else {
                    alert(d.message);
                }
            });
        }

        // --- NAVIGATION ---
        function showPage(pageId) {
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active'); // Set active button
            
            document.querySelectorAll('#app-content > div').forEach(div => div.classList.add('hidden'));
            document.getElementById('page-' + pageId).classList.remove('hidden');
            
            const titles = { 'dashboard': 'Dashboard Ringkasan', 'workflow': 'Workflow Operasional', 'master': 'Master Data' };
            document.getElementById('page-title').innerText = titles[pageId];
        }

        // --- DATA LOADER ---
        function loadData() {
            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'get_all_data' })
            })
            .then(r => r.json())
            .then(res => {
                if(res.status === 'success') {
                    globalData = res.data;
                    renderDashboard();
                    renderWorkflow();
                    renderMaster();
                    fillMachineSelect();
                }
            });
        }

        // --- RENDER FUNCTIONS ---
        function renderDashboard() {
            const l = globalData.linen;
            document.getElementById('stat-total').innerText = l.length;
            document.getElementById('stat-dirty').innerText = l.filter(x => x.CurrentStatus === 'DIRTY').length;
            document.getElementById('stat-washing').innerText = l.filter(x => x.CurrentStatus === 'WASHING').length;
            document.getElementById('stat-clean').innerText = l.filter(x => x.CurrentStatus === 'CLEAN').length;

            const tbody = document.querySelector('#dash-machines tbody');
            tbody.innerHTML = '';
            globalData.machines.forEach(m => {
                tbody.innerHTML += `<tr><td>${m.MachineID}</td><td>${m.Name}</td><td>${m.Capacity} Kg</td><td><span class="badge ${m.Status === 'Running' ? 'badge-washing' : 'badge-clean'}">${m.Status}</span></td></tr>`;
            });
        }

        function renderWorkflow() {
            // Render Dirty Table
            const tDirty = document.querySelector('#table-dirty tbody');
            tDirty.innerHTML = '';
            globalData.linen.filter(x => x.CurrentStatus === 'DIRTY').forEach(item => {
                tDirty.innerHTML += `<tr><td><input type="checkbox" class="chk-linen" value="${item.LinenID}"></td><td>${item.LinenID}</td><td>${item.Name}</td><td>${item.CurrentLocation}</td></tr>`;
            });

            // Render Washing Table
            const tWash = document.querySelector('#table-washing tbody');
            tWash.innerHTML = '';
            globalData.linen.filter(x => x.CurrentStatus === 'WASHING').forEach(item => {
                tWash.innerHTML += `<tr><td><input type="checkbox" class="chk-linen" value="${item.LinenID}"></td><td>${item.LinenID}</td><td>${item.Name}</td><td>${item.CurrentLocation}</td></tr>`;
            });
        }

        function renderMaster() {
            const tLinen = document.querySelector('#master-linen tbody');
            tLinen.innerHTML = '';
            globalData.linen.forEach(item => {
                tLinen.innerHTML += `<tr><td>${item.LinenID}</td><td>${item.Name}</td><td><span class="badge badge-${item.CurrentStatus.toLowerCase()}">${item.CurrentStatus}</span></td><td>${item.CurrentLocation}</td></tr>`;
            });
        }

        function fillMachineSelect() {
            const sel = document.getElementById('selectMachine');
            sel.innerHTML = '<option value="">-- Pilih Mesin --</option>';
            globalData.machines.forEach(m => {
                sel.innerHTML += `<option value="${m.MachineID}">${m.Name} (${m.Capacity}kg)</option>`;
            });
        }

        // --- WORKFLOW ACTIONS ---
        function switchWorkflow(type) {
            document.getElementById('wf-dirty-panel').classList.add('hidden');
            document.getElementById('wf-washing-panel').classList.add('hidden');
            document.getElementById('wf-' + type + '-panel').classList.remove('hidden');
        }

        function getCheckedIds(tableId) {
            const checks = document.querySelectorAll(`#${tableId} .chk-linen:checked`);
            return Array.from(checks).map(c => c.value);
        }

        function processWashing() {
            const ids = getCheckedIds('table-dirty');
            const machineId = document.getElementById('selectMachine').value;

            if (ids.length === 0) return alert("Pilih linen dulu!");
            if (!machineId) return alert("Pilih mesin cuci!");

            sendProcess(ids, 'WASHING', machineId);
        }

        function processClean() {
            const ids = getCheckedIds('table-washing');
            const unit = document.getElementById('targetUnitInput').value;
            
            if (ids.length === 0) return alert("Pilih linen yang selesai dicuci!");
            if (!unit) return alert("Isi unit tujuan distribusi!");

            // Untuk backend, saat status CLEAN kita butuh 'targetUnit' di payload. 
            // Backend case 'process_workflow' mengharapkan 'targetUnit'.
            // Kita kirim machineId kosong atau '-' agar tidak crash.
            // Kita modifikasi fungsi sendProcess sedikit di bawah untuk handle payload dinamis.
            sendProcess(ids, 'CLEAN', null, unit); 
        }

        function sendProcess(linenIds, toStatus, machineId = null, targetUnit = null) {
            if(!confirm("Proses workflow: " + toStatus + "?")) return;

            const payload = {
                action: 'process_workflow',
                linenIds: linenIds,
                toStatus: toStatus,
                operator: 'Staff', // Hardcoded untuk demo, bisa ambil dari session
                machineId: machineId || '-'
            };

            // Jika CLEAN, tambahkan targetUnit
            if(toStatus === 'CLEAN' && targetUnit) {
                payload.targetUnit = targetUnit;
            }

            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            })
            .then(r => r.json())
            .then(res => {
                if(res.status === 'success') {
                    alert("Berhasil diproses!");
                    loadData(); // Reload data
                } else {
                    alert("Gagal: " + res.message);
                }
            });
        }

        // --- MASTER DATA INPUT ---
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function saveData(type) {
            let payload = { action: '' };
            
            if(type === 'linen') {
                payload.action = 'save_linen';
                payload.id = document.getElementById('inLinenId').value;
                payload.name = document.getElementById('inLinenName').value;
                if(!payload.id || !payload.name) return alert("Lengkapi data!");
            } 
            else if (type === 'machine') {
                payload.action = 'save_machine';
                payload.id = document.getElementById('inMachineId').value;
                payload.name = document.getElementById('inMachineName').value;
                payload.cap = document.getElementById('inMachineCap').value;
                if(!payload.id || !payload.name) return alert("Lengkapi data!");
            }

            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            })
            .then(r => r.json())
            .then(res => {
                if(res.status === 'success') {
                    alert("Data tersimpan!");
                    closeModal(type === 'linen' ? 'modalLinen' : 'modalMachine');
                    loadData();
                } else {
                    alert("Gagal: " + res.message);
                }
            });
        }

        function toggleAll(source, tableId) {
            document.querySelectorAll(`#${tableId} .chk-linen`).forEach(c => c.checked = source.checked);
        }
    </script>
</body>
</html>
